<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì£¼ì°¨ì¥ ì‹¤íƒœ ê´€ë¦¬ ëª©ë¡</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280;
    --primary:#2563eb; --primary-2:#1d4ed8; --ring:rgba(37,99,235,.35);
    --border:#e5e7eb; --badge:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#3b82f6; --primary-2:#2563eb; --ring:rgba(59,130,246,.35);
      --border:#20304f; --badge:#0b1220;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif;
    background: var(--bg); color:var(--text);
    display:flex; flex-direction:column; gap:16px; padding:16px;
  }
  .wrap{max-width:1220px; margin:0 auto; width:100%}
  .title{font-size:1.25rem; font-weight:700; margin:4px 0 0}
  .sub{color:var(--muted); margin:0 0 10px}

  .panel{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
  }
  .filters{
    display:grid; gap:10px;
    grid-template-columns: 1fr 1fr;
  }
  @media (min-width: 900px){
    .filters{ grid-template-columns: repeat(4, 1fr); }
  }
  label{font-size:.88rem; color:var(--muted)}
  .control{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:transparent;
  }
  .control:focus-within{ outline:3px solid var(--ring); outline-offset:1px }
  select,input[type="text"]{
    width:100%; border:0; outline:0; background:transparent; color:var(--text); font-size:1rem;
  }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .btn{
    border:0; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600;
    background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#fff;
  }
  .btn.sec{ background:#eef2ff; color:#1e40af; border:1px solid var(--border) }
  .btn.ghost{ background:transparent; color:var(--primary); border:1px solid var(--border) }
  .btn:active{ transform:translateY(1px) }

  .result-panel{ display:grid; gap:8px }
  .summary{ color:var(--muted); font-size:.9rem }

  /* ====== íƒ­ ====== */
  .tabs{ display:flex; gap:6px; border-bottom:1px solid var(--border); margin-top:8px }
  .tab-btn{
    appearance:none; background:transparent; border:1px solid transparent; border-bottom:0;
    padding:10px 14px; border-radius:12px 12px 0 0; cursor:pointer; font-weight:700; color:var(--muted);
  }
  .tab-btn.active{
    color:var(--text); background:var(--card); border-color:var(--border) var(--border) transparent var(--border);
  }
  .tab-panels{ border:1px solid var(--border); border-radius:0 14px 14px 14px; overflow:hidden; background:var(--card) }

  .tab-panel{ padding:10px }
  .tab-panel[hidden]{ display:none }

  /* ====== ë¦¬ìŠ¤íŠ¸ ë·°: ì¹´ë“œ/í…Œì´ë¸” ====== */
  .table-wrap{ display:none }
  .cards{ display:grid }

  @media (min-width: 1100px) and (hover:hover) and (pointer:fine){
    .table-wrap{ display:block }
    .cards{ display:none }
  }

  /* í…Œì´ë¸” */
  .table-wrap{ background:var(--card); border-top:1px solid var(--border) }
  table{ width:100%; border-collapse:collapse; font-size:.95rem }
  thead th{
    text-align:left; background:#f3f4f6; padding:12px; position:sticky; top:0; z-index:1; border-bottom:1px solid var(--border);
  }
  tbody td{ padding:12px; border-top:1px solid var(--border) }
  tbody tr:hover{ background: rgba(37,99,235,.04); cursor:pointer }
  .addr{ color:var(--muted) }
  .num, .check { text-align:center }
  .check input{ width:18px; height:18px }

  /* ì¹´ë“œ(ëª¨ë°”ì¼/ì•„ì´íŒ¨ë“œ) */
  .cards{ gap:10px; }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:grid; gap:6px; cursor:pointer;
  }
  .card .name{ font-weight:700 }
  .badge{
    display:inline-block; font-size:.78rem; padding:4px 8px; border-radius:999px; background:var(--badge); border:1px solid var(--border)
  }
  .status.appr{ color:var(--ok) } .status.pend{ color:var(--warn) } .status.reject{ color:var(--err) }
  /* ëª¨ë°”ì¼ ì¹´ë“œìš© ì²´í¬ë°•ìŠ¤ ë¼ì¸ */
  .card-head{ display:flex; align-items:center; gap:10px }
  .card-check{ width:18px; height:18px }

  .pager{ display:flex; justify-content:center; gap:6px; flex-wrap:wrap; margin:10px 0 }
  .page-btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; cursor:pointer }
  .page-btn.active{ background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#fff; border-color:transparent }
  .page-btn:disabled{ opacity:.5; cursor:not-allowed }
  .right{ margin-left:auto }

  .muted{ color:var(--muted) }

  /* ìƒì„¸(iframe) */
  .detail-wrap{ background:var(--card) }
  #detailFrame{ width:100%; height:70vh; border:0; display:block }

  /* í† ìŠ¤íŠ¸ */
  .toast{
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.25);
    font-size:.95rem; z-index:1000; display:none;
  }
  .toast.show{ display:block; }
</style>
</head>
<body>
  <main class="main container">
    <div class="card">
        <div class="wrap">
            <h1 class="title">ì£¼ì°¨ì¥ ì‹¤íƒœ ê´€ë¦¬ ëª©ë¡</h1>
            <p class="sub">ëª¨ë°”ì¼/ì•„ì´íŒ¨ë“œ: ì¹´ë“œ ì „ìš© Â· ë°ìŠ¤í¬í†±: í…Œì´ë¸”/ì¹´ë“œ ìë™ ì „í™˜ Â· íƒ­(ëª©ë¡/ìƒì„¸)</p>

            <!-- ê²€ìƒ‰ íŒ¨ë„ -->
            <section class="panel" aria-label="ê²€ìƒ‰ ì¡°ê±´">
                <form id="searchForm">
                    <div class="filters">
                        <div>
                            <label for="sido">ì‹œë„</label>
                            <div class="control">
                                <select id="sido" name="sido">
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="sigungu">ì‹œêµ°êµ¬</label>
                            <div class="control">
                                <select id="sigungu" name="sigungu" disabled>
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="emd">ìë©´ë™</label>
                            <div class="control">
                                <select id="emd" name="emd" disabled>
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="prkNm">ì£¼ì°¨ì¥ëª…</label>
                            <div class="control">
                                <input id="prkNm" name="prkNm" type="text" placeholder="ì˜ˆ) ì¤‘ì•™ê³µì˜ì£¼ì°¨ì¥"/>
                            </div>
                        </div>
                        <div>
                            <label for="prkType">ì£¼ì°¨ì¥í˜•íƒœ</label>
                            <div class="control">
                                <select id="prkType" name="prkType">
                                    <option value="">ì „ì²´</option>
                                    <option>ë…¸ìƒ</option>
                                    <option>ë…¸ì™¸</option>
                                    <option>ë¶€ì„¤</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="status">ì§„í–‰ìƒíƒœ</label>
                            <div class="control">
                                <select id="status" name="status">
                                    <option value="">ì „ì²´</option>
                                    <option value="APPROVED">ìŠ¹ì¸</option>
                                    <option value="PENDING">ì§„í–‰ì¤‘</option>
                                    <option value="REJECTED">ë°˜ë ¤</option>
                                    <option value="TEMP">ì„ì‹œì €ì¥</option>
                                </select>
                            </div>
                        </div>
                        <div class="span2">
                            <label for="addr">ìƒì„¸ì£¼ì†Œ</label>
                            <div class="control">
                                <input id="addr" name="addr" type="text" placeholder="ë„ë¡œëª…/ì§€ë²ˆ ë“± ì¼ë¶€ë¥¼ ì…ë ¥"/>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn">ê²€ìƒ‰</button>
                        <button type="button" id="resetBtn" class="btn ghost">ì´ˆê¸°í™”</button>
                        <button type="button" id="exportBtn" class="btn sec">CSV ë‚´ë³´ë‚´ê¸°</button>
                        <button type="button" id="sendBtn" class="btn">ì„ íƒ ì „ì†¡</button>
                        <span class="right muted" id="hint">ë°ëª¨ ë°ì´í„° ê¸°ë°˜ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§</span>
                    </div>
                </form>
            </section>

            <!-- ê²°ê³¼/íƒ­ -->
            <section class="result-panel">
                <div class="summary" id="summary">ì´ 0ê±´</div>

                <div class="tabs" role="tablist" aria-label="ëª©ë¡">
                    <button id="tabList" class="tab-btn active" role="tab" aria-controls="panelList" aria-selected="true">ëª©ë¡</button>
                </div>

                <div class="tab-panels">
                    <!-- ëª©ë¡ íŒ¨ë„ -->
                    <div id="panelList" class="tab-panel" role="tabpanel" aria-labelledby="tabList">
                        <div id="cards" class="cards" aria-label="ê²€ìƒ‰ ê²°ê³¼ - ì¹´ë“œ ëª©ë¡"></div>
                        <div class="table-wrap" aria-label="ê²€ìƒ‰ ê²°ê³¼ - í…Œì´ë¸”">
                            <table>
                                <thead>
                                <tr>
                                    <th style="width:64px" class="num">ìˆœë²ˆ</th>
                                    <th style="width:60px" class="check">
                                        <input id="checkAll" type="checkbox" aria-label="í˜„ì¬ í˜ì´ì§€ ì „ì²´ ì„ íƒ"/>
                                    </th>
                                    <th style="width:10%">ì£¼ì°¨ì¥êµ¬ë¶„</th>
                                    <th style="width:10%">ì§„í–‰ìƒíƒœ</th>
                                    <th style="width:12%">ì‹œë„</th>
                                    <th style="width:12%">ì‹œêµ°êµ¬</th>
                                    <th style="width:12%">ìë©´ë™</th>
                                    <th>ìƒì„¸ì£¼ì†Œ</th>
                                    <th style="width:18%">ì£¼ì°¨ì¥ëª…</th>
                                </tr>
                                </thead>
                                <tbody id="tbody"></tbody>
                            </table>
                        </div>
                        <div id="pager" class="pager" role="navigation" aria-label="í˜ì´ì§€ë„¤ì´ì…˜"></div>
                    </div>

                    <!-- ìƒì„¸ íŒ¨ë„ -->
                    <%--<div id="panelDetail" class="tab-panel detail-wrap" role="tabpanel" aria-label="ìƒì„¸" style="min-width:0">
                        <div class="ld-tabs" id="ldTabs" role="tablist" aria-label="ëª©ë¡ ë° ìƒì„¸ íƒ­">
                            <div class="ld-tablist" id="ldTablist">
                                <!-- ê³ ì • ëª©ë¡ íƒ­ -->
                                <!-- <button class="ld-tab list-tab" role="tab" aria-selected="true" aria-controls="ld-panel-list" id="ld-tab-list">ğŸ“‹ ëª©ë¡</button>-->
                                <!-- ë™ì  ëª©ë¡ íƒ­ -->
                            </div>
                            <div class="ld-panels" id="ldPanels">
                                <!--<section class="ld-panel" id="ld-panel-list" role="tabpanel" aria-labelledby="ld-tab-list" aria-hidden="false">
                                     ëª©ë¡ íƒ­ì„ ëˆ„ë¥´ë©´ ì´ íŒ¨ë„ì´ ë³´ì´ì§€ë§Œ, ì‹¤ì œ ëª©ë¡ì€ ìœ„ìª½ í…Œì´ë¸”/ì¹´ë“œê°€ ì›ë³¸ì…ë‹ˆë‹¤
                                    <p style="margin:0;color:#94a3b8">ìœ„ì˜ ëª©ë¡ í…Œì´ë¸”/ì¹´ë“œë¥¼ ì´ìš©í•˜ì„¸ìš”.</p>
                                </section> -->
                                <!-- ìƒì„¸ íŒ¨ë„ë“¤ì€ JSë¡œ ë™ì  ì¶”ê°€ -->
                            </div>
                        </div>
                    </div>--%>
                </div>
            </section>
        </div>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>
</main>

<script>
/* =========================
   ë°ëª¨ ë°ì´í„°/í–‰ì •êµ¬ì—­
   ========================= */
const ADM = {
    "ì„œìš¸íŠ¹ë³„ì‹œ": {
        "ì¢…ë¡œêµ¬": ["ì‚¬ì§ë™","ì‚¼ì²­ë™","í‰ì°½ë™","ì²­ìš´íš¨ìë™"],
        "ë§ˆí¬êµ¬": ["ì•„í˜„ë™","ë„í™”ë™","ì—°ë‚¨ë™","ìƒì•”ë™"]
    },
    "ê²½ê¸°ë„": {
        "ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬": ["ì •ìë™","ìˆ˜ë‚´ë™","ì„œí˜„ë™","ì•¼íƒ‘ë™"],
        "ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬": ["í’ë•ì²œë™","ìƒí˜„ë™","ì„±ë³µë™"]
    },
    "ëŒ€ì „ê´‘ì—­ì‹œ": {
        "ìœ ì„±êµ¬": ["ê¶ë™","ë´‰ëª…ë™","ì‹ ì„±ë™"],
        "ì„œêµ¬": ["ë‘”ì‚°ë™","ê°€ìˆ˜ì›ë™","íƒ„ë°©ë™"]
    }
};

const DATA = [
    { nm:"ì¤‘ì•™ê³µì˜ì£¼ì°¨ì¥", type:"ë…¸ìƒ", status:"APPROVED",  sido:"ì„œìš¸íŠ¹ë³„ì‹œ", sigungu:"ì¢…ë¡œêµ¬", emd:"ì‚¬ì§ë™",  addr:"ì‚¬ì§ë¡œ 1",       manageNo:"PRK-0001" },
    { nm:"ì—°ë‚¨ë¡œ ë…¸ìƒ",     type:"ë…¸ìƒ", status:"PENDING",   sido:"ì„œìš¸íŠ¹ë³„ì‹œ", sigungu:"ë§ˆí¬êµ¬", emd:"ì—°ë‚¨ë™",  addr:"ì—°ë‚¨ë¡œ 123",     manageNo:"PRK-0002" },
    { nm:"ìƒì•”DMC ë³µí•©",    type:"ë¶€ì„¤", status:"TEMP",      sido:"ì„œìš¸íŠ¹ë³„ì‹œ", sigungu:"ë§ˆí¬êµ¬", emd:"ìƒì•”ë™",  addr:"ì›”ë“œì»µë¶ë¡œ 400", manageNo:"PRK-0003" },
    { nm:"ë¶„ë‹¹êµ¬ì²­ ë…¸ì™¸",   type:"ë…¸ì™¸", status:"APPROVED",  sido:"ê²½ê¸°ë„",     sigungu:"ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬", emd:"ì •ìë™", addr:"ë¶„ë‹¹ë¡œ 23", manageNo:"PRK-0004" },
    { nm:"ì„œí˜„ì—­ ë…¸ì™¸",     type:"ë…¸ì™¸", status:"REJECTED",  sido:"ê²½ê¸°ë„",     sigungu:"ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬", emd:"ì„œí˜„ë™", addr:"í™©ìƒˆìš¸ë¡œ 333", manageNo:"PRK-0005" },
    { nm:"ìˆ˜ì§€ ì„±ë³µ ë¶€ì„¤",   type:"ë¶€ì„¤", status:"APPROVED",  sido:"ê²½ê¸°ë„",     sigungu:"ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬", emd:"ì„±ë³µë™", addr:"ì„±ë³µë¡œ 77",  manageNo:"PRK-0006" },
    { nm:"DCC ë…¸ì™¸",        type:"ë…¸ì™¸", status:"PENDING",   sido:"ëŒ€ì „ê´‘ì—­ì‹œ", sigungu:"ì„œêµ¬",  emd:"ë‘”ì‚°ë™",  addr:"ì—‘ìŠ¤í¬ë¡œ 1",     manageNo:"PRK-0007" },
    { nm:"KAIST ë¶€ì„¤",      type:"ë¶€ì„¤", status:"APPROVED",  sido:"ëŒ€ì „ê´‘ì—­ì‹œ", sigungu:"ìœ ì„±êµ¬", emd:"ê¶ë™",   addr:"ëŒ€í•™ë¡œ 291",    manageNo:"PRK-0008" },
    { nm:"ìœ ì„± í™ˆí”Œ ë…¸ìƒ",   type:"ë…¸ìƒ", status:"TEMP",      sido:"ëŒ€ì „ê´‘ì—­ì‹œ", sigungu:"ìœ ì„±êµ¬", emd:"ë´‰ëª…ë™", addr:"ì˜¨ì²œì„œë¡œ 11",    manageNo:"PRK-0009" },
    { nm:"íƒ„ë°©ë™ ë…¸ìƒ",     type:"ë…¸ìƒ", status:"APPROVED",  sido:"ëŒ€ì „ê´‘ì—­ì‹œ", sigungu:"ì„œêµ¬",  emd:"íƒ„ë°©ë™", addr:"ë¬¸ì •ë¡œ 25",     manageNo:"PRK-0010" }
];

const PAGE_SIZE = 6;
const INTERNAL_API = '/api/internal/parkings/submit';
const MAX_DETAIL_TABS = 8;

/* =========================
   ìƒíƒœ/í—¬í¼
   ========================= */
let currentPage = 1;
let filtered = [...DATA];
const selected = new Set();

const $id  = (id) => document.getElementById(id);
const $one = (sel, root=document) => root.querySelector(sel);
const $all = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function toast(msg){
    const t = $id('toast');
    if (!t) return;
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}

function badgeStatus(s){
    if (s === 'APPROVED') return '<span class="badge status appr">ìŠ¹ì¸</span>';
    if (s === 'PENDING')  return '<span class="badge status pend">ì§„í–‰ì¤‘</span>';
    if (s === 'REJECTED') return '<span class="badge status reject">ë°˜ë ¤</span>';
    if (s === 'TEMP')     return '<span class="badge">ì„ì‹œì €ì¥</span>';
    return '<span class="badge">'+s+'</span>';
}

/* =========================
   í–‰ì •êµ¬ì—­ ì…€ë ‰íŠ¸
   ========================= */
function initAdm(){
    const sidoSel = $id('sido'), sggSel = $id('sigungu'), emdSel = $id('emd');
    if (!sidoSel || !sggSel || !emdSel) return;

    Object.keys(ADM).forEach(s => sidoSel.add(new Option(s, s)));

    sidoSel.addEventListener('change', ()=>{
        sggSel.innerHTML = '<option value="">ì „ì²´</option>';
        emdSel.innerHTML = '<option value="">ì „ì²´</option>';
        emdSel.disabled = true;
        const s = sidoSel.value;
        if(!s){ sggSel.disabled = true; return; }
        sggSel.disabled = false;
        Object.keys(ADM[s]).forEach(g => sggSel.add(new Option(g, g)));
    });

    sggSel.addEventListener('change', ()=>{
        emdSel.innerHTML = '<option value="">ì „ì²´</option>';
        const s = sidoSel.value, g = sggSel.value;
        if(!g){ emdSel.disabled = true; return; }
        emdSel.disabled = false;
        ADM[s][g].forEach(e => emdSel.add(new Option(e, e)));
    });
}

/* =========================
   í•„í„°/ë Œë”
   ========================= */
function applyFilter(){
    const f = {
        sido: $id('sido')?.value.trim() || '',
        sgg:  $id('sigungu')?.value.trim() || '',
        emd:  $id('emd')?.value.trim() || '',
        nm:   $id('prkNm')?.value.trim() || '',
        type: $id('prkType')?.value.trim() || '',
        st:   $id('status')?.value.trim() || '',
        ad:   $id('addr')?.value.trim() || ''
    };

    filtered = DATA.filter(r=>{
        if (f.sido && r.sido !== f.sido) return false;
        if (f.sgg  && r.sigungu !== f.sgg) return false;
        if (f.emd  && r.emd !== f.emd) return false;
        if (f.nm   && r.nm.indexOf(f.nm) === -1) return false;
        if (f.type && r.type !== f.type) return false;
        if (f.st   && r.status !== f.st) return false;
        if (f.ad   && String(r.addr).indexOf(f.ad) === -1) return false;
        return true;
    });
    currentPage = 1;
    render();
}

function render(){
    const tbody = $id('tbody'), cards = $id('cards'), summary = $id('summary');
    if (!tbody || !cards || !summary) return;

    summary.textContent = 'ì´ ' + filtered.length + 'ê±´';

    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (currentPage > pages) currentPage = pages;
    const start = (currentPage - 1) * PAGE_SIZE;
    const pageRows = filtered.slice(start, start + PAGE_SIZE);

    // í…Œì´ë¸”
    tbody.innerHTML = pageRows.map((r,i)=>{
        const seq = start + i + 1;
        const checked = selected.has(r.manageNo) ? 'checked' : '';
        return `
      <tr data-id="${r.manageNo}">
        <td class="num">${seq}</td>
        <td class="check"><input type="checkbox" class="row-check" ${checked} aria-label="ì„ íƒ: ${r.nm}" /></td>
        <td>${r.type}</td>
        <td>${badgeStatus(r.status)}</td>
        <td>${r.sido}</td>
        <td>${r.sigungu}</td>
        <td>${r.emd}</td>
        <td><span class="addr">${r.addr}</span></td>
        <td><strong>${r.nm}</strong><div class="muted">${r.manageNo}</div></td>
      </tr>`;
    }).join('');

    // ì¹´ë“œ
    cards.innerHTML = pageRows.map(r=>{
        const checked = selected.has(r.manageNo) ? 'checked' : '';
        return `
      <article class="card" data-id="${r.manageNo}" aria-label="${r.nm}">
        <div class="card-head">
          <input type="checkbox" class="card-check" ${checked} aria-label="ì„ íƒ: ${r.nm}" />
          <div class="muted">${r.manageNo}</div>
        </div>
        <div class="name">${r.nm}</div>
        <div><span class="badge">${r.type}</span> Â· ${badgeStatus(r.status)}</div>
        <div class="muted">${r.sido} ${r.sigungu} ${r.emd}</div>
        <div class="addr">${r.addr}</div>
      </article>`;
    }).join('');

    renderPager(pages);
    bindRowChecks();
    bindCardChecks();
    bindOpenDetailHandlers(pageRows);
}

function renderPager(pages){
    const pager = $id('pager'); if (!pager) return;
    pager.innerHTML = '';
    const makeBtn = (txt, page, disabled, active)=>{
        const b = document.createElement('button');
        b.className = 'page-btn' + (active ? ' active' : '');
        b.textContent = txt;
        b.disabled = !!disabled;
        b.addEventListener('click', ()=>{ currentPage = page; render(); });
        return b;
    };
    pager.appendChild(makeBtn('Â«', 1, currentPage === 1, false));
    pager.appendChild(makeBtn('â€¹', Math.max(1, currentPage - 1), currentPage === 1, false));
    const span = 3;
    const from = Math.max(1, currentPage - span);
    const to   = Math.min(pages, currentPage + span);
    for (let p = from; p <= to; p++) pager.appendChild(makeBtn(String(p), p, false, p===currentPage));
    pager.appendChild(makeBtn('â€º', Math.min(pages, currentPage + 1), currentPage === pages, false));
    pager.appendChild(makeBtn('Â»', pages, currentPage === pages, false));
}

/* =========================
   ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
   ========================= */
function bindRowChecks(){
    const tbody = $id('tbody'), cards = $id('cards'); if (!tbody || !cards) return;
    tbody.querySelectorAll('.row-check').forEach(chk=>{
        chk.addEventListener('change', (e)=>{
            const tr = e.target.closest('tr'); const id = tr.dataset.id;
            if (e.target.checked) selected.add(id); else selected.delete(id);
            syncHeaderCheck();
            const card = cards.querySelector(`.card[data-id="${id}"] .card-check`);
            if (card) card.checked = e.target.checked;
        });
    });
}
function bindCardChecks(){
    const tbody = $id('tbody'), cards = $id('cards'); if (!tbody || !cards) return;
    cards.querySelectorAll('.card-check').forEach(chk=>{
        chk.addEventListener('click', e=>e.stopPropagation());
        chk.addEventListener('change', (e)=>{
            const card = e.target.closest('.card'); const id = card.dataset.id;
            if (e.target.checked) selected.add(id); else selected.delete(id);
            const row = tbody.querySelector(`tr[data-id="${id}"] .row-check`);
            if (row) row.checked = e.target.checked;
            syncHeaderCheck();
        });
    });
}
function syncHeaderCheck(){
    const tbody = $id('tbody'), checkAll = $id('checkAll'); if (!tbody || !checkAll) return;
    const visible = Array.from(tbody.querySelectorAll('tr')).map(tr=>tr.dataset.id);
    const allChecked = visible.length > 0 && visible.every(id=>selected.has(id));
    checkAll.checked = allChecked;
    checkAll.indeterminate = !allChecked && visible.some(id=>selected.has(id));
}
(function(){
    const checkAll = $id('checkAll');
    if (checkAll){
        checkAll.addEventListener('change', ()=>{
            const tbody = $id('tbody'), cards = $id('cards'); if (!tbody || !cards) return;
            const visible = Array.from(tbody.querySelectorAll('tr')).map(tr=>tr.dataset.id);
            if (checkAll.checked) visible.forEach(id=>selected.add(id)); else visible.forEach(id=>selected.delete(id));
            tbody.querySelectorAll('.row-check').forEach(chk=>{
                const id = chk.closest('tr').dataset.id; chk.checked = selected.has(id);
            });
            visible.forEach(id=>{
                const cardChk = cards.querySelector(`.card[data-id="${id}"] .card-check`);
                if (cardChk) cardChk.checked = selected.has(id);
            });
            syncHeaderCheck();
        });
    }
})();

/* =========================
   CSV/ì „ì†¡ (í•˜ì´ë¸Œë¦¬ë“œ í˜¸í™˜)
   ========================= */
function exportCSV(){
    const header = ['ìˆœë²ˆ','ê´€ë¦¬ë²ˆí˜¸','ì£¼ì°¨ì¥êµ¬ë¶„','ì§„í–‰ìƒíƒœ','ì‹œë„','ì‹œêµ°êµ¬','ìë©´ë™','ìƒì„¸ì£¼ì†Œ','ì£¼ì°¨ì¥ëª…'];
    const rows = filtered.map((r, idx)=>[
        idx + 1, r.manageNo, r.type,
        (r.status === 'APPROVED' ? 'ìŠ¹ì¸' :
            r.status === 'PENDING'  ? 'ì§„í–‰ì¤‘' :
                r.status === 'REJECTED' ? 'ë°˜ë ¤' :
                    r.status === 'TEMP'     ? 'ì„ì‹œì €ì¥' : r.status),
        r.sido, r.sigungu, r.emd, r.addr, r.nm
    ]);
    const csv = [header, ...rows].map(cols =>
        cols.map(v=>{
            const s = String(v ?? '').replace(/"/g,'""');
            return /[",\n]/.test(s) ? `"${s}"` : s;
        }).join(',')
    ).join('\n');

    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
    const fileName = 'parking_list.csv';

    // í‘œì¤€ ë‹¤ìš´ë¡œë“œ
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    if ('download' in a){
        a.download = fileName;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(a.href);
        return;
    }

    // Web Share API
    if (navigator.share && navigator.canShare){
        try{
            const file = new File([blob], fileName, { type: blob.type });
            if (navigator.canShare({ files: [file] })){
                navigator.share({ files:[file], title:fileName }).catch(()=>{});
                return;
            }
        }catch(_){}
    }

    // data: URL fallback
    try{
        const dataUrl = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
        window.location.href = dataUrl;
    }catch(e){
        toast('ì´ ê¸°ê¸°ì—ì„œëŠ” CSV ì €ì¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

async function sendSelected(){
    if (selected.size === 0){ toast('ì „ì†¡í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ì„ íƒ 0)'); return; }
    const items = DATA.filter(r=>selected.has(r.manageNo)).map(r=>({
        manageNo:r.manageNo, nm:r.nm, type:r.type, status:r.status,
        sido:r.sido, sigungu:r.sigungu, emd:r.emd, addr:r.addr
    }));
    try{
        const res = await fetch(INTERNAL_API, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({items})
        });
        if (!res.ok){
            const txt = await res.text().catch(()=> '');
            throw new Error(('HTTP '+res.status+' '+res.statusText+' '+txt).trim());
        }
        toast('ì „ì†¡ ì™„ë£Œ Â· ' + items.length + 'ê±´');
    }catch(err){
        console.error(err);
        toast('ì „ì†¡ ì‹¤íŒ¨: ' + (err?.message || err));
    }
}

/* =========================
   ìƒë‹¨ í°ìƒ‰ íƒ­ ì—”ì§„ (.tabs / .tab-panels)
   ========================= */
function getTabHost(){
    return {
        tabBar:     $one('.tabs'),        // ìƒë‹¨ í°ìƒ‰ íƒ­ë°”(ì´ë¯¸ JSPì— ìˆìŒ)
        panelsWrap: $one('.tab-panels')   // íŒ¨ë„ ë˜í¼(ì´ë¯¸ JSPì— ìˆìŒ)
    };
}

function getOpenCountTop(){
    const { tabBar } = getTabHost(); if (!tabBar) return 0;
    return $all('.tab-btn', tabBar).filter(b=>b.id !== 'tabList').length;
}

function activateTop(tabId){
    const { tabBar, panelsWrap } = getTabHost();
    if (!tabBar || !panelsWrap) return;

    // ë²„íŠ¼ í™œì„±í™”
    $all('.tab-btn', tabBar).forEach(btn=>{
        const active = (btn.id === tabId);
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-selected', String(active));
    });

    // íŒ¨ë„ í‘œì‹œ
    $all('.tab-panel', panelsWrap).forEach(p=>{
        const owner = $one(`.tab-btn[aria-controls="${p.id}"]`, tabBar);
        p.hidden = !(owner && owner.id === tabId);
    });

    $id(tabId)?.scrollIntoView({ inline:'nearest', behavior:'smooth' });
    resizeDetail();
}

function ensureDetailTabTop(rec){
    const { tabBar, panelsWrap } = getTabHost();
    if (!tabBar || !panelsWrap){
        toast('ìƒì„¸ íƒ­ ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤(.tabs/.tab-panels).');
        return;
    }

    const tabId   = `tab-${rec.manageNo}`;
    const panelId = `panel-${rec.manageNo}`;

    // ì´ë¯¸ ìˆìœ¼ë©´ í™œì„±í™”
    if ($id(tabId) && $id(panelId)){ activateTop(tabId); return; }

    // ìµœëŒ€ ê°œìˆ˜ ì œí•œ(ëª©ë¡ ì œì™¸)
    if (getOpenCountTop() >= MAX_DETAIL_TABS){
        toast(`ìƒì„¸ íƒ­ì€ ìµœëŒ€ ${MAX_DETAIL_TABS}ê°œê¹Œì§€ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        return;
    }

    // êµ¬ë¶„ â†’ ê²½ë¡œ ë§¤í•‘
    const routeMap = { 'ë…¸ìƒ':'offparking.html', 'ë…¸ì™¸':'onparking.html', 'ë¶€ì„¤':'buildparking.html' };
    const path = routeMap[rec.type];

    // íƒ­ ë²„íŠ¼
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.id = tabId;
    btn.type = 'button';
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-controls', panelId);
    btn.setAttribute('aria-selected','false');
    btn.innerHTML = `${rec.nm} <span class="x" aria-hidden="true">âœ•</span>`;
    tabBar.appendChild(btn);

    // ìƒì„¸ íŒ¨ë„: iframeë§Œ + ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€
    const panel = document.createElement('section');
    panel.className = 'tab-panel';
    panel.id = panelId;
    panel.setAttribute('role','tabpanel');
    panel.setAttribute('aria-labelledby', tabId);
    panel.hidden = true;
    panel.innerHTML = `
      <iframe class="detail-frame" title="ìƒì„¸: ${rec.nm}"
              style="width:100%;border:0;display:block;min-height:420px"
              loading="eager" allow="geolocation"
              sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
      <div class="no-page muted" style="padding:12px;display:none">í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    `;
    panelsWrap.appendChild(panel);

    const iframe = panel.querySelector('iframe');
    const noPage = panel.querySelector('.no-page');

    // ë§¤í•‘ì´ ì—†ìœ¼ë©´ ê³§ì¥ ì•ˆë‚´ë¬¸êµ¬
    if (!path){
        iframe.remove();
        noPage.style.display = 'block';
        activateTop(tabId);
        return;
    }

    // ì¿¼ë¦¬ êµ¬ì„±
    const sp = new URLSearchParams({
        id: rec.manageNo, name: rec.nm, status: rec.status,
        sido: rec.sido, sigungu: rec.sigungu, emd: rec.emd, addr: rec.addr
    });
    const url = `${path}?${sp.toString()}`;

    // í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸(HEAD). ì—†ìœ¼ë©´ ì•ˆë‚´ë¬¸êµ¬ë¡œ ëŒ€ì²´
    fetch(url, { method:'HEAD' })
        .then(res => res.ok)
        .catch(()=>false)
        .then(ok=>{
            if (ok){
                iframe.src = url;
                iframe.addEventListener('load', ()=>{ resizeDetail(); });
            }else{
                iframe.remove();
                noPage.style.display = 'block';
            }
        });

    activateTop(tabId);
}

function closeTop(btn){
    if (!btn || btn.id === 'tabList') return;
    const panelId = btn.getAttribute('aria-controls');
    const panel = $id(panelId);
    const wasActive = btn.classList.contains('active');
    btn.remove();
    panel?.remove();
    if (wasActive){
        const { tabBar } = getTabHost();
        const all = $all('.tab-btn', tabBar);
        const fallback = all[all.length - 1] || $id('tabList');
        fallback && activateTop(fallback.id);
    }
    if (getOpenCountTop() === 0) activateTop('tabList');
}

/* =========================
   ëª©ë¡/ì¹´ë“œ â†’ ìƒì„¸ íƒ­ ì—´ê¸°
   ========================= */
function bindOpenDetailHandlers(pageRows){
    const tbody = $id('tbody'), cards = $id('cards');
    if (!tbody || !cards) return;

    tbody.onclick = (e)=>{
        if (e.target.closest('input,button,label,a')) return;
        const tr = e.target.closest('tr'); if (!tr) return;
        const id = tr.dataset.id;
        const rec = pageRows.find(r=>r.manageNo===id);
        if (rec) ensureDetailTabTop(rec);
    };

    cards.onclick = (e)=>{
        if (e.target.closest('input,button,label,a')) return;
        const card = e.target.closest('.card'); if (!card) return;
        const id = card.dataset.id;
        const rec = pageRows.find(r=>r.manageNo===id);
        if (rec) ensureDetailTabTop(rec);
    };
}

/* =========================
   í¬ê¸°/í•˜ì´ë¸Œë¦¬ë“œ ë°”ì¸ë”©
   ========================= */
function resizeDetail(){
    // í˜„ì¬ ë³´ì´ëŠ” ìƒì„¸ íŒ¨ë„ ë‚´ iframe ë†’ì´ ìë™ ì¡°ì ˆ
    const panelsWrap = $one('.tab-panels');
    if (!panelsWrap) return;
    const activeIframe = panelsWrap.querySelector('.tab-panel:not([hidden]) iframe');
    if (!activeIframe) return;

    const top = activeIframe.getBoundingClientRect().top;
    const vh  = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
    const footerGap = 16;
    const min = Math.max(420, vh - top - footerGap);
    activeIframe.style.minHeight = min + 'px';
}

function initHybridBindings(){
    // 100vh ë³´ì •(ëª¨ë°”ì¼ ì£¼ì†Œì°½ ë†’ì´ ë³€í™” ëŒ€ì‘)
    const setVh = ()=>{
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        resizeDetail();
    };
    setVh();
    window.addEventListener('resize', setVh, { passive:true });

    // Android í•˜ë“œì›¨ì–´ Back (Cordova)
    if (window.cordova){
        document.addEventListener('backbutton', (e)=>{
            e.preventDefault();
            const { tabBar } = getTabHost();
            const opened = $all('.tab-btn', tabBar).filter(b=>b.id!=='tabList');
            if (opened.length){ closeTop(opened[opened.length-1]); }
            else { activateTop('tabList'); }
        }, false);
    }

    // Capacitor Back
    if (window.Capacitor && window.Capacitor.App && window.Capacitor.App.addListener){
        window.Capacitor.App.addListener('backButton', ({canGoBack})=>{
            const { tabBar } = getTabHost();
            const opened = $all('.tab-btn', tabBar).filter(b=>b.id!=='tabList');
            if (opened.length){ closeTop(opened[opened.length-1]); }
            else { activateTop('tabList'); }
        });
    }
}

/* =========================
   ì´ˆê¸°í™”
   ========================= */
function init(){
    // í•˜ë‹¨ panelDetailì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ(ë””ìì¸ ìœ ì§€ìš©ìœ¼ë¡œë§Œ ì¡´ì¬) â†’ ìˆ¨ê¹€
    $id('panelDetail')?.setAttribute('hidden','');

    initAdm();
    applyFilter();

    // íƒ­ë°” ë™ì‘ ë°”ì¸ë”©(1íšŒ)
    const { tabBar } = getTabHost();
    if (tabBar && !tabBar.__bound){
        tabBar.__bound = true;

        // ëª©ë¡ íƒ­
        $id('tabList')?.addEventListener('click', ()=> activateTop('tabList'));

        // íƒ­ í´ë¦­/ë‹«ê¸°
        tabBar.addEventListener('click', (e)=>{
            const btn = e.target.closest('.tab-btn');
            if (!btn) return;
            if (e.target.closest('.x') && btn.id !== 'tabList'){ closeTop(btn); return; }
            activateTop(btn.id);
        });

        // í‚¤ë³´ë“œ ë„¤ë¹„
        tabBar.addEventListener('keydown', (e)=>{
            if (!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
            const tabs = $all('.tab-btn', tabBar);
            const idx = tabs.findIndex(t => t.classList.contains('active'));
            let next = idx;
            if (e.key==='ArrowRight') next = Math.min(idx+1, tabs.length-1);
            if (e.key==='ArrowLeft')  next = Math.max(idx-1, 0);
            if (e.key==='Home')       next = 0;
            if (e.key==='End')        next = tabs.length-1;
            e.preventDefault();
            activateTop(tabs[next].id);
            tabs[next].focus();
        });

        // ìƒì„¸ ë‚´ë¶€ "ëª©ë¡ ë³´ê¸°"
        document.addEventListener('click', (e)=>{
            const b = e.target.closest('button[data-action="back-to-list"]');
            if (!b) return;
            activateTop('tabList');
        });

        // ì´ˆê¸° í™œì„±
        activateTop('tabList');
    }

    // í¼/ë²„íŠ¼
    $id('searchForm')?.addEventListener('submit', (e)=>{ e.preventDefault(); applyFilter(); });
    $id('resetBtn')?.addEventListener('click', ()=>{
        const sggSel = $id('sigungu'), emdSel = $id('emd');
        $id('searchForm')?.reset();
        if (sggSel){ sggSel.innerHTML = '<option value="">ì „ì²´</option>'; sggSel.disabled = true; }
        if (emdSel){ emdSel.innerHTML = '<option value="">ì „ì²´</option>'; emdSel.disabled = true; }
        filtered = [...DATA]; currentPage = 1; render();
        selected.clear(); syncHeaderCheck();
    });
    $id('exportBtn')?.addEventListener('click', exportCSV);
    $id('sendBtn')?.addEventListener('click', sendSelected);

    // ë¦¬ì‚¬ì´ì¦ˆ
    window.addEventListener('resize', resizeDetail, { passive:true });

    // í•˜ì´ë¸Œë¦¬ë“œ ë°”ì¸ë”©
    initHybridBindings();
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
</script>
</body>
</html>