<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>브이월드 전용 지도 · 김천 (완본)</title>

<!-- ★ VWorld 스크립트: key/domain 인코딩 없이 그대로 -->
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=CF9A371B-35A6-3822-8315-6592C8342E82&domain=psychic-pancake-r7q577jxr6ghwx9g-8080.app.github.dev"></script>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}
  .status{
    position:fixed;left:12px;top:12px;z-index:20;background:#0f172a;color:#e5e7eb;
    border:1px solid #20304f;border-radius:10px;padding:8px 10px;font-size:.92rem
  }
  .ok{color:#10b981}.bad{color:#ef4444}.muted{color:#9ca3af}
  /* 팝업(카카오맵 느낌) */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);
    box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);
    bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;
    filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}
</style>
</head>
<body>
<div class="status" id="stat">브이월드 초기화 중…</div>
<div id="map" aria-label="지도"></div>

<script>
(function(){
  const FALLBACK_CENTER = { lng:128.1136, lat:36.1398 }; // 김천(한국교통안전공단 인근)
  const stat = document.getElementById('stat');

  const PARK_ICON_SVG =
    `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
       <circle cx='18' cy='18' r='16' fill='#2563eb'/>
       <text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
     </svg>`;

  const ok  = (msg)=> stat.innerHTML = `<span class="ok">✔</span> ${msg}`;
  const bad = (msg)=> stat.innerHTML = `<span class="bad">✖</span> ${msg}`;

  function init(){
    // 1) 브이월드/OL 가용성 체크
    if(!(window.vw && vw.ol3)){
      bad('브이월드 객체(vw.ol3) 미탑재 — apiKey·domain 확인 필요');
      return;
    }

    // 2) 브이월드 지도 생성
    const vmap = new vw.ol3.Map("map", {
      basemapType: vw.ol3.BasemapType.GRAPHIC, // 배경지도
      controlDensity: vw.ol3.DensityType.BASIC,
      interactionDensity: vw.ol3.DensityType.BASIC,
      controlsAutoArrange: true
    });

    // 3) OpenLayers 맵 핸들
    const map = vmap.getMap ? vmap.getMap() : (vmap.map || vmap);
    if(!(window.ol && map && map.getView)){
      bad('OpenLayers 핸들 확보 실패');
      return;
    }
    // 디버깅/확장 편의: 윈도우로 노출
    window.olmap = map;

    // 4) 초기 중심/줌 (김천)
    const center3857 = ol.proj.fromLonLat([FALLBACK_CENTER.lng, FALLBACK_CENTER.lat]);
    map.getView().setCenter(center3857);
    map.getView().setZoom(14);

    // 5) 샘플 마커 레이어
    const iconStyle = new ol.style.Style({
      image: new ol.style.Icon({
        src: 'data:image/svg+xml;utf8,' + encodeURIComponent(PARK_ICON_SVG.trim()),
        anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1.0
      })
    });

    const feat = new ol.Feature({
      geometry: new ol.geom.Point(center3857),
      nm: '한국교통안전공단 본사',
      addr: '경북 김천시 혁신로 242',
      type: '부설'
    });
    feat.setStyle(iconStyle);

    const vecSrc = new ol.source.Vector({ features: [feat] });
    const vecLy  = new ol.layer.Vector({ source: vecSrc, zIndex: 100 });
    map.addLayer(vecLy);

    // 6) 팝업(× 닫기/ESC 지원)
    const popupEl = document.createElement('div');
    popupEl.className = 'ol-popup';
    popupEl.innerHTML = `
      <button class="x" aria-label="닫기">×</button>
      <div class="tit"></div>
      <div class="sub addr"></div>
      <div class="sub meta"></div>
    `;
    const overlay = new ol.Overlay({
      element: popupEl, positioning: 'bottom-center', stopEvent: true, offset: [0,-14]
    });
    map.addOverlay(overlay);

    const closePopup = ()=> overlay.setPosition(undefined);
    popupEl.querySelector('.x').addEventListener('click', closePopup);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePopup(); });

    // 7) 마커 클릭 → 팝업
    map.on('singleclick', (evt)=>{
      let picked = null;
      map.forEachFeatureAtPixel(evt.pixel, (f, layer)=>{
        if(layer === vecLy){ picked = f; return true; }
      }, {hitTolerance: 6});
      if(!picked){ closePopup(); return; }
      const p = picked.getProperties();
      popupEl.querySelector('.tit').textContent  = p.nm || '주차장';
      popupEl.querySelector('.addr').textContent = p.addr || '';
      popupEl.querySelector('.meta').textContent = `형태: ${p.type||'주차장'}`;
      overlay.setPosition(evt.coordinate);
    });

    ok('브이월드 지도 로딩 완료');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>