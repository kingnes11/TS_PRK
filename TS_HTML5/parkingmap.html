<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>브이월드 + 더미 주차장 + 현재위치 · 반응형 패널 · OL 10.6.1</title>

<!-- 플랫폼/폼팩터 감지 -->
<script>
(function(){
  const html = document.documentElement;
  const ua = (navigator.userAgent || navigator.vendor || '').toLowerCase();
  const isIOS = /iphone|ipad|ipod/.test(ua) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
  const isAndroid = /android/.test(ua);
  html.classList.add(isIOS ? 'platform-ios' : (isAndroid ? 'platform-android' : 'platform-other'));
  const minPx = Math.min(screen.width, screen.height) / (window.devicePixelRatio || 1);
  const isTablet = minPx >= 600 && minPx < 1025;
  const isDesktop = minPx >= 1025;
  html.classList.add(isDesktop ? 'ff-desktop' : (isTablet ? 'ff-tablet' : 'ff-phone'));
})();
</script>

<!-- OpenLayers 10.6.1 로더(로컬→CDN 폴백) -->
<script>
(function(){
  const basePath = location.pathname.replace(/\/[^/]*$/, '');
  const cssSrcs = [
    basePath + '/vendor/ol/10.6.1/ol.css',
    '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.css',
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'
  ];
  const jsSrcs = [
    basePath + '/vendor/ol/10.6.1/ol.js',
    '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.js',
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js'
  ];
  function loadCSS(list, i=0){ if(i<list.length){ const l=document.createElement('link'); l.rel='stylesheet'; l.href=list[i]; l.onerror=()=>loadCSS(list,i+1); document.head.appendChild(l);} }
  function loadJS(list, i, resolve, reject){
    if(i>=list.length) return reject(new Error('OpenLayers JS load failed'));
    const s=document.createElement('script'); s.src=list[i]; s.defer=false; s.async=false; s.crossOrigin='anonymous';
    let tried=false;
    const next=()=>{ if(tried) return; tried=true; s.remove(); loadJS(list,i+1,resolve,reject); };
    s.onload=()=> setTimeout(()=> (window.ol && ol.Map) ? resolve(list[i]) : next(),0);
    s.onerror=next; document.head.appendChild(s);
  }
  loadCSS(cssSrcs,0);
  window.OL_READY = new Promise((res,rej)=>{
    if(window.ol && ol.Map){ res('(preloaded)'); return; }
    loadJS(jsSrcs,0,res,rej);
  });
})();
</script>

<!-- 스타일: 반응형 사이드/로그 -->
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
    --side-w:360px; --side-top:12px; --side-bottom:12px; --list-max-h:62vh;
    --errdock-w:560px; --errdock-max-h:50vh; --err-right:12px; --err-bottom:68px;
  }
  @media (max-width:430px){
    :root{ --side-w:calc(100% - 16px); --side-top:8px; --side-bottom:calc(8px + env(safe-area-inset-bottom));
      --list-max-h:42svh; --errdock-w:calc(100% - 16px); --errdock-max-h:48svh; --err-right:8px; --err-bottom:calc(10px + env(safe-area-inset-bottom)); }
  }
  @media (min-width:431px) and (max-width:599px){
    :root{ --side-w:min(440px, calc(100% - 20px)); --list-max-h:50svh; --errdock-w:min(520px, calc(100% - 20px)); --errdock-max-h:52svh; }
  }
  @media (min-width:600px) and (max-width:1024px) and (orientation:portrait){
    :root{ --side-w:420px; --list-max-h:58svh; --errdock-w:560px; --errdock-max-h:52svh; }
  }
  @media (min-width:800px) and (orientation:landscape){
    :root{ --list-max-h:46svh; --errdock-max-h:46svh; }
  }
  html.platform-ios.ff-phone{ --list-max-h:40svh; --errdock-max-h:46svh; }
  html.platform-ios.ff-tablet{ --list-max-h:50svh; --errdock-max-h:50svh; }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0;height:100dvh;width:100vw}

  .side{
    position:fixed; left:12px; top:var(--side-top); bottom:var(--side-bottom); width:var(--side-w); z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media (max-width:960px){ .side{ right:12px; width:auto } }
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent}
  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#c7d2fe; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem}
  .chip.active{background:var(--chipOn); color:#fff; border-color:transparent}
  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530; max-height:var(--list-max-h);}
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}
  .dist{color:#9ca3af}

  .ol-popup{position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25)}
  .ol-popup:after{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)}
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  .errdock{position:fixed; right:var(--err-right); bottom:var(--err-bottom); z-index:1000; width:var(--errdock-w); max-height:var(--errdock-max-h); background:#0f172a; border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; flex-direction:column;}
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{ overflow:auto; padding:8px 10px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.86rem; background:#0b1220 }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px } .lvl{ font-weight:800; margin-right:6px }
  .lvl-INFO{ color:#93c5fd } .lvl-WARN{ color:#fbbf24 } .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }
  .errfab{ position:fixed; right:var(--err-right); bottom:calc(12px + env(safe-area-inset-bottom)); z-index:1001; background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px; box-shadow:0 8px 20px rgba(0,0,0,.35) }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}
</style>
</head>

<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널 -->
<aside class="side">
  <div class="row title">
    <div>주차장(반경 <b id="radiusLabel">5</b>km)</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
  </div>
  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn ghost" id="fitBtn">전체 보기</button>
    <span id="stat" class="muted" style="margin-left:auto">초기화 중…</span>
  </div>
  <div class="chipbar" id="typeBar" role="group" aria-label="주차장 형태 필터">
    <div class="chip active" data-type="">전체</div>
    <div class="chip" data-type="노상">노상</div>
    <div class="chip" data-type="노외">노외</div>
    <div class="chip" data-type="부설">부설</div>
  </div>
  <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
</aside>

<!-- 오류 로그 도크 + FAB -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div class="grow"></div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm red" id="clearErr">지우기</button>
    <button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
/* === 공통/로그 === */
const $ = (s)=>document.querySelector(s);
const stat = $('#stat');
const ok   = (m)=> stat.innerHTML = `<span style="color:#10b981">✔</span> ${m}`;
const warn = (m)=> stat.innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

const ERRUI = (()=>{ // 오류 로그 UI 바인딩
  const dock=$('#errdock'), body=$('#errbody'), count=$('#errcount'), fab=$('#errFab'), cntFab=$('#errCntFab');
  $('#closeErr').onclick=()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
  $('#clearErr').onclick=()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
  $('#copyErr').onclick=async()=>{ const txt=[...body.querySelectorAll('.logrow')].map(el=>el.innerText).join('\n'); try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch(e){} };
  fab.onclick=()=>{ const opened=dock.classList.toggle('open'); fab.setAttribute('aria-expanded',String(opened)); };
  return {dock,body,count,fab,cntFab};
})();
const logs=[]; let autoOpened=false;
const tstr=()=> new Date().toLocaleTimeString();
function appendRow(level,msg,extra){ const div=document.createElement('div'); div.className='logrow';
  div.innerHTML=`<span class="time">[${tstr()}]</span><span class="lvl lvl-${level}">${level}</span><span>${msg}</span>`+(extra?`<div class="muted" style="margin-left:8px;white-space:pre-wrap">${extra}</div>`:'');
  ERRUI.body.appendChild(div); ERRUI.body.scrollTop=ERRUI.body.scrollHeight;
}
function log(level,msg,detail){ const text=typeof detail==='string'?detail:(detail?(detail.stack||JSON.stringify(detail)):'');
  logs.push({t:Date.now(),level,msg,detail:text}); appendRow(level,msg,text);
  const errCnt=logs.filter(x=>x.level==='ERR').length; ERRUI.count.textContent=`${logs.length}건`; ERRUI.cntFab.textContent=String(errCnt);
  if(errCnt>0) ERRUI.fab.classList.add('error'); if(level==='ERR' && !autoOpened){ ERRUI.dock.classList.add('open'); ERRUI.fab.setAttribute('aria-expanded','true'); autoOpened=true; }
}
const logInfo=(m,d)=>log('INFO',m,d), logWarn=(m,d)=>log('WARN',m,d), logErr=(m,d)=>log('ERR',m,d);
window.addEventListener('error', (e)=> logErr('window.onerror: '+e.message, e.error||e));
window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', e.reason||e));

/* === 상수 === */
const VW_KEY='CF9A371B-35A6-3822-8315-6592C8342E82';
const DOMAIN='kingnes11.github.io';
const INIT={lng:128.1136, lat:36.1398};
const RADIUS_KM=5.0; $('#radiusLabel').textContent=RADIUS_KM;

/* === 전역(지도/레이어/소스) === */
let map, vwBase, osm;
let currentCoord3857=null;
let geolSrc, geolLayer;
let prkSrc, prkClusterSrc, prkLayer;
let overlay, overlayEl;
let currentFilterType = '';

/* === 아이콘(Data URI) === */
const ICON_P = 'data:image/svg+xml;base64,' + btoa(`
<svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 34 34">
 <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%">
  <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".35"/></filter></defs>
 <circle cx="17" cy="17" r="15" fill="#2563eb" filter="url(#s)"/>
 <text x="17" y="21" font-family="Segoe UI, Roboto, Arial" font-size="16" text-anchor="middle" fill="#fff" font-weight="800">P</text>
</svg>`);

/* === 유틸 === */
const to3857 = (lon,lat)=> ol.proj.fromLonLat([lon,lat]);
const toLonLat= (xy)=> ol.proj.toLonLat(xy);
const distM = (a,b)=> { const dx=a[0]-b[0], dy=a[1]-b[1]; return Math.sqrt(dx*dx+dy*dy); };
function fmtDist(m){
  if(m>=1000) return (m/1000).toFixed(1)+'km';
  return Math.round(m)+'m';
}

/* === 시작 === */
window.OL_READY.then((src)=> startApp(src)).catch(err=>{
  warn('OpenLayers 로드 실패'); logErr('OpenLayers 로드 실패', err);
});

function startApp(olSrc){
  logInfo('OpenLayers loaded', olSrc); ok('OpenLayers 10.6.1 로드 완료');

  /* 베이스 타일: VW WMTS → OSM 폴백 */
  vwBase = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: `https://api.vworld.kr/req/wmts/1.0.0/${VW_KEY}/Base/{z}/{y}/{x}.png?domain=${DOMAIN}`,
      maxZoom: 18, minZoom: 5
    }),
    zIndex: 0, visible: true
  });
  osm = new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0, visible:false });

  map = new ol.Map({
    target:'map',
    layers:[vwBase, osm],
    view: new ol.View({ center: to3857(INIT.lng, INIT.lat), zoom: 15, maxZoom: 18, minZoom: 5 })
  });
  let switched=false;
  vwBase.getSource().on('tileloaderror', (evt)=>{
    const key=evt && evt.tile && (evt.tile.getKey?.()||''); logWarn('WMTS tile error → OSM 폴백', key);
    if(!switched){ vwBase.setVisible(false); osm.setVisible(true); warn('브이월드 타일 오류 → OSM 전환'); switched=true; }
  });

  /* 현재위치 레이어 */
  geolSrc = new ol.source.Vector();
  geolLayer = new ol.layer.Vector({
    source: geolSrc,
    style: (f)=>{
      const kind=f.get('kind');
      if(kind==='accuracy'){
        return new ol.style.Style({ stroke:new ol.style.Stroke({color:'rgba(59,130,246,0.4)',width:2}), fill:new ol.style.Fill({color:'rgba(59,130,246,0.15)'}) });
      }
      return new ol.style.Style({
        image: new ol.style.Circle({ radius:6, fill:new ol.style.Fill({color:'#3b82f6'}), stroke:new ol.style.Stroke({color:'#fff', width:2}) })
      });
    },
    zIndex: 20
  });
  map.addLayer(geolLayer);

  /* 주차장 더미 + 클러스터 레이어 */
  prkSrc = new ol.source.Vector();
  prkClusterSrc = new ol.source.Cluster({ distance: 48, minDistance: 16, source: prkSrc });
  prkLayer = new ol.layer.Vector({
    source: prkClusterSrc,
    style: clusterStyle,
    zIndex: 15
  });
  map.addLayer(prkLayer);

  /* 팝업 */
  overlayEl = document.createElement('div');
  overlayEl.className='ol-popup';
  overlayEl.innerHTML='<button class="x" title="닫기" aria-label="닫기">×</button><div id="popBody"></div>';
  overlay = new ol.Overlay({ element:overlayEl, offset:[0, -8], positioning:'bottom-center', stopEvent:true });
  map.addOverlay(overlay);
  overlayEl.querySelector('.x').onclick=()=> overlay.setPosition(undefined);

  /* UI 이벤트 */
  $('#locBtn').onclick = ()=> locate(true);
  $('#fitBtn').onclick = ()=> fitAll();
  $('#typeBar').addEventListener('click', (e)=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    [...document.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentFilterType = chip.dataset.type || '';
    refreshList(); // 필터 반영
    prkLayer.changed(); // 스타일(투명화) 반영
  });

  map.on('click', onMapClick);
  map.on('pointermove', (e)=> map.getTargetElement().style.cursor = hitCluster(e) ? 'pointer' : '');

  // 초기: 현재 위치 요청 → 성공 시 거점 기준 더미 시딩
  locate(false).finally(()=>{
    // 현재 위치 실패해도 초기 중심 기준 시딩
    seedParking( currentCoord3857 || map.getView().getCenter(), 300, RADIUS_KM );
    refreshList();
    fitAll();
  });
}

/* === 현재 위치 === */
function locate(recenter){
  return new Promise((resolve)=>{
    if(!('geolocation' in navigator)){ warn('Geolocation 미지원'); logWarn('Geolocation not supported'); return resolve(); }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const {longitude:lon, latitude:lat, accuracy} = pos.coords || {};
      currentCoord3857 = to3857(lon,lat);
      // 피처(포인트)
      let pt = geolSrc.getFeatureById('me');
      if(!pt){ pt = new ol.Feature(new ol.geom.Point(currentCoord3857)); pt.setId('me'); geolSrc.addFeature(pt); }
      else pt.getGeometry().setCoordinates(currentCoord3857);
      pt.set('kind','point');

      // 정확도 원
      let acc = geolSrc.getFeatureById('me_acc');
      const radius = Math.max(accuracy||25, 15);
      if(!acc){ acc = new ol.Feature(new ol.geom.Circle(currentCoord3857, radius)); acc.setId('me_acc'); geolSrc.addFeature(acc); }
      else { acc.setGeometry(new ol.geom.Circle(currentCoord3857, radius)); }
      acc.set('kind','accuracy');

      if(recenter){ map.getView().animate({center: currentCoord3857, zoom: 16, duration: 450}); }
      ok('현재 위치 확보'); logInfo('geolocated', JSON.stringify({lng:lon,lat:lat,accuracy:accuracy}));
      resolve();
    }, (err)=>{
      warn('위치 권한 거부 또는 실패'); logWarn('geolocation error', err);
      resolve();
    }, { enableHighAccuracy:true, timeout:7000, maximumAge:0 });
  });
}

/* === 더미 주차장 생성 === */
function seedParking(center3857, count, radiusKm){
  prkSrc.clear();
  const types = ['노상','노외','부설'];
  for(let i=0;i<count;i++){
    const ang = Math.random()*Math.PI*2;
    const r   = (Math.random()**0.5) * radiusKm * 1000; // 균등 분포 보정
    const x = center3857[0] + Math.cos(ang)*r;
    const y = center3857[1] + Math.sin(ang)*r;
    const t = types[i%types.length];
    const f = new ol.Feature({ geometry: new ol.geom.Point([x,y]),
      name: `더미 주차장 #${i+1}`, type: t, slots: (80 + Math.floor(Math.random()*420)),
      fee: Math.random()<0.6 ? '유료' : '무료',
      hours: '24시간', id: 'D'+(10000+i)
    });
    prkSrc.addFeature(f);
  }
}

/* === 클러스터/개별 스타일 === */
function clusterStyle(feature){
  const feats = feature.get('features');
  if(!feats) return null;

  // 필터: 타입이 선택되었을 때, 비해당 개별은 살짝 흐리게
  const ftype = currentFilterType;
  if(feats.length===1){
    const f=feats[0];
    const active = !ftype || f.get('type')===ftype;
    const opacity = active ? 1 : 0.25;
    return new ol.style.Style({
      image: new ol.style.Icon({ src: ICON_P, scale: 1.0, opacity }),
      text: new ol.style.Text({
        text: f.get('type'), offsetY: 18, fill: new ol.style.Fill({color: active?'#ffffff':'#cbd5e1'}),
        stroke: new ol.style.Stroke({color:'rgba(0,0,0,0.35)', width:3}), font:'700 11px "Segoe UI",Roboto,Arial'
      })
    });
  }

  // 클러스터는 개수 배지
  const size = feats.filter(f=> !ftype || f.get('type')===ftype ).length;
  const dim  = 28 + Math.min(12, Math.floor(Math.log2(feats.length+1))*2);
  return new ol.style.Style({
    image: new ol.style.Circle({
      radius: dim/2,
      fill: new ol.style.Fill({color:'rgba(37,99,235,0.85)'}),
      stroke: new ol.style.Stroke({color:'#e5e7eb', width:2})
    }),
    text: new ol.style.Text({
      text: String(feats.length),
      fill: new ol.style.Fill({color:'#ffffff'}),
      stroke: new ol.style.Stroke({color:'rgba(0,0,0,0.35)', width:3}),
      font:'800 13px "Segoe UI",Roboto,Arial'
    })
  });
}

/* === 목록 갱신 === */
function refreshList(){
  const list = $('#list'); list.innerHTML='';
  const feats = prkSrc.getFeatures().filter(f=> !currentFilterType || f.get('type')===currentFilterType );

  // 거리 계산
  const base = currentCoord3857 || map.getView().getCenter();
  feats.sort((a,b)=> distM(a.getGeometry().getCoordinates(), base) - distM(b.getGeometry().getCoordinates(), base));

  feats.slice(0, 500).forEach((f,idx)=>{
    const c = f.getGeometry().getCoordinates();
    const d = distM(c, base);
    const div = document.createElement('div');
    div.className='item'; div.setAttribute('role','option');
    div.innerHTML = `
      <div class="nm">${f.get('name')}</div>
      <div class="sub">
        <span class="badge">${f.get('type')}</span>
        <span class="badge">${f.get('fee')}</span>
        <span class="badge">정원 ${f.get('slots')}면</span>
        <span class="dist">${fmtDist(d)}</span>
      </div>`;
    div.onclick = ()=>{
      selectFeature(f);
    };
    list.appendChild(div);
  });

  $('#count').textContent = String(feats.length);
  $('#sel').textContent = '-';
}

/* === 선택/팝업 === */
function selectFeature(f){
  const c = f.getGeometry().getCoordinates();
  map.getView().animate({center:c, zoom:16, duration:300});
  const el = overlayEl.querySelector('#popBody');
  el.innerHTML = `
    <div class="tit">${f.get('name')}</div>
    <div class="sub2">종류: <b>${f.get('type')}</b> · 요금: <b>${f.get('fee')}</b> · 정원: <b>${f.get('slots')}면</b><br/>운영시간: ${f.get('hours')}</div>
  `;
  overlay.setPosition(c);
  $('#sel').textContent = f.get('name');
}

/* === 전체 보기(현재위치 + 주차장) === */
function fitAll(){
  const ext = ol.extent.createEmpty();
  const add = (g)=> g && ol.extent.extend(ext, g.getExtent());
  prkSrc.getFeatures().forEach(f=> add(f.getGeometry()));
  const me = geolSrc.getFeatureById('me'); if(me) add(me.getGeometry());
  if(ol.extent.isEmpty(ext)){ map.getView().animate({zoom:14}); return; }
  map.getView().fit(ext, {padding:[40,40,40,40], duration:400, maxZoom:16});
}

/* === 지도 클릭(클러스터 분해/개별 선택) === */
function hitCluster(evt){
  const pixel = map.getEventPixel(evt.originalEvent || evt);
  const feats = map.getFeaturesAtPixel(pixel, {layerFilter:(l)=>l===prkLayer});
  if(!feats || feats.length===0) return null;
  return feats[0];
}
function onMapClick(evt){
  const f = hitCluster(evt);
  if(!f) { overlay.setPosition(undefined); return; }
  const children = f.get('features');
  if(children && children.length>1){
    map.getView().animate({zoom: map.getView().getZoom()+1, center: evt.coordinate, duration:250});
    return;
  }
  if(children && children.length===1){ selectFeature(children[0]); }
}
</script>
</body>
</html>