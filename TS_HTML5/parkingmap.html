<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>주차장정보시스템 · WMS(경계) + WFS(주차장) · 에러URL 로그</title>

<!-- OpenLayers 동적 로더 (10.6.1, 로컬/레포→CDN 폴백) -->
<script>
(function(){
  const basePath = location.pathname.replace(/\/[^/]*$/, '');
  const localCSS = basePath + '/vendor/ol/10.6.1/ol.css';
  const localJS  = basePath + '/vendor/ol/10.6.1/ol.js';
  const repoCSS  = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.css';
  const repoJS   = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.js';

  const cssSrcs = [
    localCSS, repoCSS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'
  ];
  const jsSrcs = [
    localJS, repoJS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js'
  ];

  function loadCSS(list, i=0){ if(i<list.length){ const l=document.createElement('link'); l.rel='stylesheet'; l.href=list[i]; l.onerror=()=>loadCSS(list,i+1); document.head.appendChild(l); } }
  function loadJS(list, i, resolve, reject){
    if(i>=list.length) return reject(new Error('OpenLayers JS load failed'));
    const s=document.createElement('script'); let done=false;
    s.src=list[i]; s.defer=false; s.async=false; s.crossOrigin='anonymous';
    const next=()=>{ if(done) return; done=true; s.remove(); loadJS(list,i+1,resolve,reject); };
    s.onload=()=>setTimeout(()=>{ (window.ol && typeof ol.Map==='function') ? (done=true, resolve(list[i])) : next(); },0);
    s.onerror=next; document.head.appendChild(s);
  }
  loadCSS(cssSrcs,0);
  window.OL_READY = new Promise((resolve,reject)=>{
    if(window.ol && typeof ol.Map==='function'){ resolve('(preloaded)'); return; }
    loadJS(jsSrcs,0,resolve,reject);
  });
})();
</script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb; --border:#20304f;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  .side{
    position:fixed; left:12px; top:12px; bottom:12px; width:360px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530}
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}

  /* 팝업 */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  /* 오류 로그 도크 + FAB (에러만) */
  .errdock{
    position:fixed; right:12px; bottom:68px; z-index:1000;
    width:min(560px, calc(100% - 24px));
    background:#0f172a; border:1px solid var(--border); border-radius:12px;
    display:none; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{
    max-height:38vh; overflow:auto; padding:8px 10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem; background:#0b1220
  }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px; color:#fca5a5 }

  .errfab{
    position:fixed; right:12px; bottom:12px; z-index:1001;
    background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.35)
  }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}

  /* 반응형(휴대폰/태블릿) */
  @media (max-width:380px){
    .side{ left:8px; right:8px; width:auto; top:8px; bottom:auto; max-height:62vh; overflow:auto }
    .list{ min-height:120px; max-height:40vh }
    .errdock{ left:8px; right:8px; width:auto }
  }
  @media (min-width:381px) and (max-width:480px){
    .side{ left:10px; right:10px; width:auto; top:10px; bottom:auto; max-height:64vh; overflow:auto }
    .list{ min-height:140px; max-height:42vh }
    .errdock{ left:10px; right:10px; width:auto }
  }
  @media (min-width:481px) and (max-width:768px){
    .side{ width:380px; top:10px; bottom:10px }
    .list{ min-height:160px }
    .errdock{ width:min(520px, calc(100% - 20px)) }
  }
  @media (min-width:769px) and (max-width:1024px){
    .side{ width:420px }
    .errdock{ width:min(560px, calc(100% - 24px)) }
  }
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널 -->
<aside class="side">
  <div class="row title">
    <div>주차장(반경 <b id="radiusLabel">5</b>km)</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
  </div>
  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn" id="fitBtn">전체 보기</button>
    <span id="stat" class="muted" style="margin-left:auto">초기화 중…</span>
  </div>
  <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
</aside>

<!-- 오류 로그 (ERR만) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div class="grow"></div>
    <button class="btn" id="copyErr">복사</button>
    <button class="btn" id="clearErr">지우기</button>
    <button class="btn" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(function(){
  /* ===== 설정 ===== */
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const RADIUS_KM = 5;
  document.getElementById('radiusLabel').textContent = RADIUS_KM;

  /* ===== 에러 로그(에러만 + URL 표시) ===== */
  const ERRUI = (()=> {
    const dock = document.getElementById('errdock');
    const body = document.getElementById('errbody');
    const count= document.getElementById('errcount');
    const fab  = document.getElementById('errFab');
    const cntFab = document.getElementById('errCntFab');

    document.getElementById('closeErr').onclick = ()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    document.getElementById('clearErr').onclick = ()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
    document.getElementById('copyErr').onclick  = async ()=>{
      const txt = Array.from(body.querySelectorAll('.logrow')).map(el=>el.innerText).join('\n');
      try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch(e){}
    };
    fab.onclick = ()=>{ const opened=dock.classList.toggle('open'); fab.setAttribute('aria-expanded', String(opened)); };
    return {dock, body, count, fab, cntFab};
  })();

  const lastErrKeyTime = new Map();
  function pushErr(title, detail){
    const now = Date.now();
    const key = title+'|'+detail;
    if(now - (lastErrKeyTime.get(key)||0) < 1500) return; // 스팸 억제
    lastErrKeyTime.set(key, now);

    const row = document.createElement('div');
    row.className = 'logrow';
    row.innerHTML = `<span class="time">[${new Date().toLocaleTimeString()}]</span><span class="lvl">ERR</span> ${title}` +
      (detail? `<div style="white-space:pre-wrap; color:#9ca3af; margin-left:8px">${detail}</div>`:'');
    ERRUI.body.appendChild(row); ERRUI.body.scrollTop = ERRUI.body.scrollHeight;
    const n = ERRUI.body.querySelectorAll('.logrow').length;
    ERRUI.count.textContent = `${n}건`;
    ERRUI.cntFab.textContent = String(n);
    if(n>0) ERRUI.fab.classList.add('error');
  }

  window.addEventListener('error', (e)=> pushErr('window.onerror: '+(e.message||'Error'), e.filename||'' ));
  window.addEventListener('unhandledrejection', (e)=> pushErr('unhandledrejection', (e.reason && (e.reason.stack||e.reason.message)) || String(e.reason)));

  const ok   = (m)=> document.getElementById('stat').innerHTML = `<span style="color:#10b981">✔</span> ${m}`;
  const warn = (m)=> document.getElementById('stat').innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

  /* ===== URL 빌더 ===== */
  const WMS_BASE = 'https://api.vworld.kr/req/wms';
  const WFS_BASE = 'https://api.vworld.kr/req/wfs';

  function buildWMSUrlFromBbox(bbox){ // [minX,minY,maxX,maxY] (EPSG:900913/3857)
    const p = new URLSearchParams({
      SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
      LAYERS:'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
      STYLES:'lp_pa_cbnd_bonbun_line,lp_pa_cbnd_bubun_line',
      CRS:'EPSG:900913',
      BBOX:bbox.join(','),
      WIDTH:'256', HEIGHT:'256',
      FORMAT:'image/png', TRANSPARENT:'false', BGCOLOR:'0xFFFFFF',
      EXCEPTIONS:'text/xml',
      KEY:VW_KEY, DOMAIN:DOMAIN
    });
    return `${WMS_BASE}?${p.toString()}`;
  }

  function buildWFSUrl(bbox){ // [minX,minY,maxX,maxY] EPSG:900913
    const p = new URLSearchParams({
      SERVICE:'WFS', REQUEST:'GetFeature', VERSION:'1.1.0',
      TYPENAME:'lt_c_uq111',
      SRSNAME:'EPSG:900913',
      BBOX:bbox.join(','),
      MAXFEATURES:'400',
      PROPERTYNAME:'mnum,sido_cd,sigungu_cd,dyear,dnum,ucode,bon_bun,bu_bun,uname,sido_name,sigg_name,ag_geom',
      OUTPUT:'application/json',
      EXCEPTIONS:'text/xml',
      KEY:VW_KEY, DOMAIN:DOMAIN
    });
    return `${WFS_BASE}?${p.toString()}`;
  }

  /* ===== 앱 시작 ===== */
  function start(){
    ok('OpenLayers 로드 완료');

    /* 지도 & 뷰 */
    const view = new ol.View({
      center: ol.proj.fromLonLat([127.5,36.4]),
      zoom: 7, minZoom:4, maxZoom:18
    });
    const map = new ol.Map({
      target:'map',
      layers:[ new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0 }) ],
      view
    });

    /* WMS(경계) */
    const wmsSource = new ol.source.TileWMS({
      url: WMS_BASE,
      params:{
        SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
        LAYERS:'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
        STYLES:'lp_pa_cbnd_bonbun_line,lp_pa_cbnd_bubun_line',
        CRS:'EPSG:900913',
        FORMAT:'image/png', TRANSPARENT:false, BGCOLOR:'0xFFFFFF',
        KEY:VW_KEY, DOMAIN:DOMAIN
      },
      crossOrigin:'anonymous'
    });
    const wmsLayer = new ol.layer.Tile({ source:wmsSource, zIndex:200, opacity:.95, visible:true });
    map.addLayer(wmsLayer);

    /* WMS 타일 에러 URL 로깅 */
    wmsSource.on('tileloaderror', (evt)=>{
      try{
        const img = evt.tile && evt.tile.getImage && evt.tile.getImage();
        const url = (img && (img.src || img.currentSrc)) || '(알 수 없음)';
        pushErr('WMS 타일 오류 → 요청 URL', url);
      }catch(e){
        pushErr('WMS 타일 오류(추가정보)', String(e));
      }
    });

    /* 현재위치 + 반경 */
    const meSrc = new ol.source.Vector();
    const meLy  = new ol.layer.Vector({
      source:meSrc, zIndex:120
    });
    map.addLayer(meLy);

    const ME_ICON = new ol.style.Icon({
      src:'data:image/svg+xml;utf8,'+encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>
           <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
           <path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>
           <circle cx='19' cy='12' r='5' fill='#fff'/>
           <path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>
         </svg>`
      ),
      anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1
    });
    const styleMe = new ol.style.Style({ image:ME_ICON });
    const styleCircle = new ol.style.Style({
      stroke:new ol.style.Stroke({color:[239,68,68,.9], width:2}),
      fill:new ol.style.Fill({color:[239,68,68,.08]})
    });

    function setMe(lng,lat){
      meSrc.clear();
      const c = ol.proj.fromLonLat([lng,lat]);
      meSrc.addFeature(new ol.Feature({ geometry:new ol.geom.Point(c), kind:'me' })).setStyle(styleMe);
      meSrc.addFeature(new ol.Feature({ geometry:new ol.geom.Circle(c, RADIUS_KM*1000), kind:'ring' })).setStyle(styleCircle);
      view.animate({center:c, zoom:15, duration:400});
      ok('현재 위치 반영 완료');
    }

    /* WFS(주차장) – 클러스터 */
    const rawSrc = new ol.source.Vector({ wrapX:true });
    const clusterSrc = new ol.source.Cluster({ distance:40, minDistance:10, source:rawSrc });
    const PARK_ICON = new ol.style.Icon({
      src:'data:image/svg+xml;utf8,'+encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
           <circle cx='18' cy='18' r='16' fill='#2563eb'/>
           <text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
         </svg>`
      ),
      anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1
    });
    const stylePark = new ol.style.Style({ image:PARK_ICON });

    const clusterLy = new ol.layer.Vector({
      source:clusterSrc, zIndex:110,
      style:(feature)=>{
        const members = feature.get('features')||[];
        const size = members.length;
        if(size>1){
          return new ol.style.Style({
            image:new ol.style.Circle({
              radius: Math.max(12, Math.min(28, 10 + Math.log(size)*8)),
              fill:new ol.style.Fill({color:[37,99,235,.92]}),
              stroke:new ol.style.Stroke({color:'#fff',width:2})
            }),
            text:new ol.style.Text({
              text:String(size),
              fill:new ol.style.Fill({color:'#fff'}),
              stroke:new ol.style.Stroke({color:'#000',width:3})
            })
          });
        }
        const m = members[0];
        return (m && m.getStyle && m.getStyle()) || stylePark;
      }
    });
    map.addLayer(clusterLy);

    /* 목록 */
    let LIST_ROWS = [];
    function renderList(rows){
      document.getElementById('count').textContent = String(rows.length);
      const list = document.getElementById('list');
      if(!rows.length){
        list.innerHTML = `<div class="item"><div class="nm">결과 없음</div><div class="sub">현재 화면 범위 내</div></div>`;
        return;
      }
      list.innerHTML = rows.map((r,i)=>`
        <div class="item" data-id="${r.__id}">
          <div class="nm">${i+1}. ${r.name||'주차장'}</div>
          <div class="sub"><span class="badge">ID:${r.__id}</span> ${r.addr||''}</div>
        </div>
      `).join('');
      list.querySelectorAll('.item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const r = LIST_ROWS.find(x=>x.__id===el.dataset.id); if(!r) return;
          const c = ol.proj.fromLonLat([r.lng,r.lat]);
          view.setCenter(c); view.setZoom(17);
          openPopup(r, c);
          list.querySelectorAll('.item').forEach(x=>x.classList.remove('active'));
          el.classList.add('active');
        });
      });
    }

    /* 팝업 */
    const popupEl = document.createElement('div');
    popupEl.className='ol-popup';
    popupEl.innerHTML = `<button class="x" aria-label="닫기">×</button><div class="tit"></div><div class="sub2 addr"></div><div class="sub2 meta"></div>`;
    const overlay = new ol.Overlay({ element: popupEl, positioning:'bottom-center', stopEvent:true, offset:[0,-14] });
    map.addOverlay(overlay);
    popupEl.querySelector('.x').onclick = ()=> overlay.setPosition(undefined);

    function openPopup(r, coord){
      popupEl.querySelector('.tit').textContent = r.name || '주차장';
      popupEl.querySelector('.addr').textContent = r.addr || '';
      popupEl.querySelector('.meta').textContent = `좌표: ${r.lat?.toFixed(5)||'-'}, ${r.lng?.toFixed(5)||'-'}`;
      overlay.setPosition(coord);
      document.getElementById('sel').textContent = r.name || '-';
    }

    map.on('singleclick', (evt)=>{
      let handled=false;
      map.forEachFeatureAtPixel(evt.pixel,(feat, layer)=>{
        if(layer!==clusterLy) return;
        const ms = feat.get('features')||[];
        if(ms.length>1){
          const ex=ol.extent.createEmpty(); ms.forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
          view.fit(ex,{duration:250,maxZoom:17,padding:[30,380,30,30]});
        }else if(ms.length===1){
          const f=ms[0], c=f.getGeometry().getCoordinates();
          const p=f.getProperties().__row;
          openPopup(p, c);
          handled=true; return true;
        }
      },{hitTolerance:6});
      if(!handled) overlay.setPosition(undefined);
    });

    /* 주차장 피처 로딩 */
    let lastBboxKey = '';
    let wfsPending = false;

    async function loadWFSForExtent(extent3857){
      if(wfsPending) return;
      const bbox = extent3857.slice(0); // 3857 == 900913
      const key  = bbox.map(n=>Math.round(n)).join(',');
      if(key===lastBboxKey) return; // 동일 범위 재요청 방지
      lastBboxKey = key;
      wfsPending = true;

      // 실제 요청 URL
      const url = buildWFSUrl(bbox);

      try{
        const res = await fetch(url, {mode:'cors'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();

        // GeoJSON -> Feature
        const fmt = new ol.format.GeoJSON();
        const feats = fmt.readFeatures(json, { dataProjection:'EPSG:900913', featureProjection:'EPSG:3857' });

        rawSrc.clear(true);
        LIST_ROWS = [];

        feats.forEach((f,i)=>{
          // 속성 매핑(필드명은 서비스 스키마에 따라 조정)
          const g = f.getGeometry();
          if(!(g instanceof ol.geom.Point)) return; // 포인트만 표출
          const lonlat = ol.proj.toLonLat(g.getFirstCoordinate());
          const p = f.getProperties();
          const row = {
            __id: p.mnum || String(i+1),
            name: p.uname || p.sigg_name || '주차장',
            addr: [p.sido_name, p.sigg_name, (p.bon_bun||''), (p.bu_bun||'')].filter(Boolean).join(' '),
            lng: lonlat[0], lat: lonlat[1]
          };
          const vf = new ol.Feature({ geometry:g.clone(), __row:row });
          vf.setStyle(stylePark);
          rawSrc.addFeature(vf);
          LIST_ROWS.push(row);
        });

        renderList(LIST_ROWS);
        ok(`WFS ${LIST_ROWS.length}건`);
      }catch(err){
        pushErr('WFS 로드 실패 → URL', url + '\n' + ((err && (err.stack||err.message))||String(err)));
      }finally{
        wfsPending = false;
      }
    }

    /* moveend 디바운스 후 BBOX 로딩 */
    let moveTimer=null;
    function requestByView(){
      const ex = view.calculateExtent(map.getSize());
      loadWFSForExtent(ex);
    }
    map.on('moveend', ()=>{
      clearTimeout(moveTimer);
      moveTimer = setTimeout(requestByView, 400);
    });

    /* fit 버튼: 현재위치+피처 */
    document.getElementById('fitBtn').onclick = ()=>{
      const ex=ol.extent.createEmpty();
      meSrc.getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
      rawSrc.getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
      if(!ol.extent.isEmpty(ex)) view.fit(ex,{duration:400,padding:[30,380,30,30],maxZoom:17});
    };

    /* 현재 위치 버튼 */
    document.getElementById('locBtn').onclick = ()=> getLocation(true);

    /* 자동 현재 위치 (김천 고정 제거) */
    function getLocation(fly){
      const secure = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!secure || !navigator.geolocation){ warn('위치 권한/환경 문제(https 필요)'); return; }
      navigator.geolocation.getCurrentPosition(
        p=>{ setMe(p.coords.longitude, p.coords.latitude); },
        e=>{ pushErr('geolocation 실패', `${e.code} ${e.message}`); },
        { enableHighAccuracy:true, maximumAge:5000, timeout:9000 }
      );
    }
    getLocation(false);

    /* 초기 1회 WFS 로딩 */
    requestByView();

    /* 참고: WMS 호출 URL 예시를 오류시 출력(정상 상태에선 OpenLayers가 타일별로 처리) */
    // 필요 시 수동 URL 생성 예시:
    // const example = buildWMSUrlFromBbox(view.calculateExtent(map.getSize()));
    // console.log('WMS 샘플 URL', example);
  }

  function domReady(cb){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', cb); else cb(); }
  window.OL_READY.then(()=> domReady(start)).catch(err=>{
    pushErr('OpenLayers 로딩 실패', (err && (err.stack||err.message)) || String(err));
  });
})();
</script>
</body>
</html>