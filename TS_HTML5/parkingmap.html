<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>브이월드 안전 로더 · 진단 + (선택)OSM 폴백</title>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif;background:#0b1220;color:#e5e7eb}
  #map{position:fixed;inset:0}
  .panel{position:fixed;left:12px;top:12px;z-index:50;background:#0f172a;border:1px solid #20304f;border-radius:12px;padding:10px 12px;max-width:520px}
  .panel b{color:#fff}
  .muted{color:#9ca3af}
  .ok{color:#10b981}.bad{color:#ef4444}.warn{color:#f59e0b}
  .btn{border:1px solid #334155;background:transparent;color:#c7d2fe;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer;margin-right:6px}
  .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:transparent;color:#fff}
  pre{margin:8px 0 0;white-space:pre-wrap;font-size:.9rem;color:#cbd5e1}
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<div class="panel">
  <div><b>브이월드 로더</b> <span id="step" class="muted">대기 중…</span></div>
  <div style="margin-top:6px">
    <button id="retry" class="btn">다시 시도</button>
    <button id="osm" class="btn">OSM 폴백 보기</button>
    <button id="clear" class="btn">오버레이 숨기기</button>
  </div>
  <pre id="log"></pre>
</div>

<script>
/* ====== 설정 (키/도메인 그대로) ====== */
const VWORLD_URL =
  "https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=CF9A371B-35A6-3822-8315-6592C8342E82&domain=psychic-pancake-r7q577jxr6ghwx9g-8080.app.github.dev";

/* ====== DOM 유틸 ====== */
const $ = (s)=>document.querySelector(s);
const stepEl = $('#step'), logEl = $('#log');
function log(msg){ logEl.textContent += msg + '\n'; }
function step(msg, cls=''){ stepEl.textContent = msg; stepEl.className = cls || 'muted'; }

/* ====== 스크립트 로더 ====== */
function loadScript(url, timeoutMs=8000){
  return new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    const tid = setTimeout(()=>{
      s.remove();
      reject(new Error('timeout'));
    }, timeoutMs);
    s.src = url; s.async = true; s.defer = false;
    s.onload = ()=>{ clearTimeout(tid); resolve('loaded'); };
    s.onerror = (e)=>{ clearTimeout(tid); reject(new Error('onerror')); };
    document.head.appendChild(s);
  });
}

/* ====== vw.ol3 준비 대기 ====== */
function waitVWorldReady(maxMs=5000){
  const start = performance.now();
  return new Promise((resolve,reject)=>{
    (function tick(){
      if (window.vw && vw.ol3){ resolve(true); return; }
      if (performance.now() - start > maxMs){
        reject(new Error('vw.ol3 not ready')); return;
      }
      setTimeout(tick, 100);
    })();
  });
}

/* ====== OL6 로더(OSM 폴백용) ====== */
async function ensureOpenLayers6(){
  if (window.ol && ol.proj && ol.layer && ol.source) return;
  await loadScript("https://cdnjs.cloudflare.com/ajax/libs/ol/6.15.1/ol.js", 8000);
  // 간단 체크
  if(!(window.ol && ol.Map)){ throw new Error('OpenLayers 6 load failed'); }
}

/* ====== 브이월드 지도 만들기 ====== */
function buildVWorld(){
  // vw.ol3 가정하에 동작
  const vmap = new vw.ol3.Map("map", {
    basemapType: vw.ol3.BasemapType.GRAPHIC,
    controlDensity: vw.ol3.DensityType.BASIC,
    interactionDensity: vw.ol3.DensityType.BASIC,
    controlsAutoArrange: true
  });
  const map = vmap.getMap ? vmap.getMap() : (vmap.map || vmap);
  if(!(window.ol && map && map.getView)) throw new Error('OpenLayers handle missing');

  // 김천 중심
  const center = ol.proj.fromLonLat([128.1136, 36.1398]);
  map.getView().setCenter(center);
  map.getView().setZoom(14);

  // 샘플 마커
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'><circle cx='18' cy='18' r='16' fill='#2563eb'/><text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text></svg>`;
  const iconStyle = new ol.style.Style({
    image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(svg), anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction' })
  });
  const f = new ol.Feature({ geometry:new ol.geom.Point(center) });
  f.setStyle(iconStyle);
  const src = new ol.source.Vector({ features:[f] });
  const layer = new ol.layer.Vector({ source: src, zIndex:100 });
  map.addLayer(layer);

  return map;
}

/* ====== OSM 폴백 지도 ====== */
async function buildOSM(){
  await ensureOpenLayers6();
  const map = new ol.Map({
    target: 'map',
    layers: [ new ol.layer.Tile({ source:new ol.source.OSM() }) ],
    view: new ol.View({ center: ol.proj.fromLonLat([128.1136, 36.1398]), zoom: 14 })
  });
  // 동일한 샘플 마커
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'><circle cx='18' cy='18' r='16' fill='#22c55e'/><text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text></svg>`;
  const iconStyle = new ol.style.Style({
    image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(svg), anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction' })
  });
  const center = ol.proj.fromLonLat([128.1136,36.1398]);
  const f = new ol.Feature({ geometry:new ol.geom.Point(center) }); f.setStyle(iconStyle);
  const src = new ol.source.Vector({ features:[f] });
  map.addLayer(new ol.layer.Vector({ source: src, zIndex:100 }));
  return map;
}

/* ====== 메인 플로우 ====== */
async function boot(){
  // 상태 초기화
  logEl.textContent = '';
  step('브이월드 스크립트 로드 중…');
  try{
    await loadScript(VWORLD_URL, 8000);
    step('브이월드 로드됨, 엔진 준비 대기…', 'warn');
    log('script loaded OK (HTTP 200일 가능). 이제 vw.ol3 준비 대기');

    await waitVWorldReady(5000);
    step('vw.ol3 준비됨 → 지도 생성', 'ok');

    window.olmap = buildVWorld();
    step('브이월드 지도 OK', 'ok');
    log('브이월드 지도 초기화 성공');
  }catch(err){
    // 실패 케이스 설명
    if(err.message==='timeout'){
      step('브이월드 스크립트 타임아웃', 'bad');
      log('❌ map.vworld.kr 응답 지연: 네트워크/방화벽/서버 이슈 의심');
    }else if(err.message==='onerror'){
      step('브이월드 스크립트 로드 실패', 'bad');
      log('❌ onerror: URL 차단/도메인 불일치/키 권한 실패(403/502) 가능');
    }else if(err.message==='vw.ol3 not ready'){
      step('vw.ol3 객체가 준비되지 않음', 'bad');
      log('❌ 응답은 있었으나 엔진 노출 실패: 502/권한 실패/내부 오류 가능');
    }else{
      step('예상 외 오류: '+err.message, 'bad');
      log('❌ '+(err.stack||err));
    }
    log('\n도움말:\n- 개발자도구 Network에서 위 스크립트 URL 상태 코드를 확인하세요(403/502/ERR_* 등)\n- domain/apiKey가 브이월드 콘솔 등록값과 정확히 일치해야 합니다 (서브도메인까지)\n- 보안장비/프록시가 map.vworld.kr을 차단하는지 확인');
  }
}

/* ====== 버튼 ====== */
$('#retry').addEventListener('click', boot);
$('#clear').addEventListener('click', ()=>$('.panel').style.display='none');
$('#osm').addEventListener('click', async ()=>{
  try{
    step('OSM 폴백 로드 중…', 'warn');
    window.olmap = await buildOSM();
    step('OSM 폴백 표시 중', 'ok');
  }catch(e){
    step('OSM 폴백 실패: '+e.message, 'bad');
  }
});

/* ====== 자동 시도 ====== */
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>