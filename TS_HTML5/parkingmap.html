<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ë¸Œì´ì›”ë“œ WMS/WFS(JS) í´ë°± Â· ë¦¬ìŠ¤íŠ¸/í•„í„° Â· ì˜¤ë¥˜ë¡œê·¸(FAB) Â· OL 10.6.1</title>

<!-- âœ… OpenLayers ë™ì  ë¡œë”: 10.6.1 (ë¡œì»¬ â†’ CDN í´ë°±) -->
<script>
(function(){
  const basePath = location.pathname.replace(/\/[^/]*$/, '');
  const localCSS = basePath + '/vendor/ol/10.6.1/ol.css';
  const localJS  = basePath + '/vendor/ol/10.6.1/ol.js';
  const repoCSS  = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.css';
  const repoJS   = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.js';

  const cssSrcs = [
    localCSS, repoCSS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'
  ];
  const jsSrcs = [
    localJS, repoJS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js'
  ];

  function loadCSS(list, i=0){
    if(i>=list.length) return;
    const link=document.createElement('link');
    link.rel='stylesheet'; link.href=list[i];
    link.onerror=()=>loadCSS(list, i+1);
    document.head.appendChild(link);
  }
  function loadJS(list, i, resolve, reject){
    if(i>=list.length) return reject(new Error('OpenLayers JS load failed (all sources)'));
    const s=document.createElement('script');
    s.src=list[i]; s.defer=false; s.async=false; s.crossOrigin='anonymous';
    let done=false;
    const next=()=>{ if(done) return; done=true; s.remove(); loadJS(list, i+1, resolve, reject); };
    s.onload=()=>{ setTimeout(()=>{ (window.ol && typeof ol.Map==='function') ? (done=true, resolve(list[i])) : next(); },0); };
    s.onerror=next;
    document.head.appendChild(s);
  }

  loadCSS(cssSrcs, 0);
  window.OL_READY = new Promise((resolve,reject)=>{
    if(window.ol && typeof ol.Map==='function'){ resolve('(preloaded)'); return; }
    loadJS(jsSrcs, 0, resolve, reject);
  });
})();
</script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  /* ì¢Œì¸¡ íŒ¨ë„ (ëª¨ë°”ì¼ì—ì„œëŠ” í•˜ë‹¨ ì‹œíŠ¸ë¡œ ì „í™˜) */
  .side{
    position:fixed; left:12px; top:12px; bottom:12px; width:360px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media (max-width:960px){
    .side{ right:12px; width:auto }
  }
  /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™”: ì§€ë„ ê°€ë¦¼ ìµœì†Œí™” (í•˜ë‹¨ ì‹œíŠ¸) */
  @media (max-width:640px){
    .side{
      left:8px; right:8px; top:auto; bottom:8px; width:auto; max-height:52vh;
      border-radius:14px; padding:10px; backdrop-filter:saturate(120%) blur(2px)
    }
  }

  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent}

  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#c7d2fe; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem}
  .chip.active{background:var(--chipOn); color:#fff; border-color:transparent}

  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530}
  @media (max-width:640px){ .list{ min-height:120px } }
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}
  .dist{color:#9ca3af}

  /* íŒì—… */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  /* ì˜¤ë¥˜ ë¡œê·¸ ë„í¬ + FAB (ëª¨ë°”ì¼ ë†’ì´ ì¶•ì†Œ) */
  .errdock{
    position:fixed; right:12px; bottom:68px; z-index:1000;
    width:min(560px, calc(100% - 24px));
    background:#0f172a; border:1px solid var(--border); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:none; flex-direction:column;
  }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{
    max-height:38vh; overflow:auto; padding:8px 10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem;
    background:#0b1220
  }
  @media (max-width:640px){ .errdock .body{ max-height:32vh } }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px }
  .lvl-INFO{ color:#93c5fd } .lvl-WARN{ color:#fbbf24 } .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }

  .errfab{
    position:fixed; right:12px; bottom:12px; z-index:1001;
    background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.35)
  }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}
</style>
</head>
<body>
<div id="map" aria-label="ì§€ë„"></div>

<!-- ì¢Œì¸¡ íŒ¨ë„(ëª¨ë°”ì¼: í•˜ë‹¨ ì‹œíŠ¸) -->
<aside class="side">
  <div class="row title">
    <div>ì£¼ì°¨ì¥(ë°˜ê²½ <b id="radiusLabel">5</b>km)</div>
    <div class="muted" style="margin-left:auto">ì´ <b id="count">0</b>ê³³ Â· ì„ íƒ: <b id="sel">-</b></div>
  </div>

  <div class="row">
    <button class="btn" id="locBtn">í˜„ì¬ ìœ„ì¹˜</button>
    <button class="btn ghost" id="fitBtn">ì „ì²´ ë³´ê¸°</button>
    <span id="stat" class="muted" style="margin-left:auto">ìœ„ì¹˜ ëŒ€ê¸°â€¦</span>
  </div>

  <div class="chipbar" id="typeBar" role="group" aria-label="ì£¼ì°¨ì¥ í˜•íƒœ í•„í„°">
    <div class="chip active" data-type="">ì „ì²´</div>
    <div class="chip" data-type="ë…¸ìƒ">ë…¸ìƒ</div>
    <div class="chip" data-type="ë…¸ì™¸">ë…¸ì™¸</div>
    <div class="chip" data-type="ë¶€ì„¤">ë¶€ì„¤</div>
  </div>

  <!-- í–‰ì •ê²½ê³„ í† ê¸€ -->
  <div class="row" id="admToggles" style="gap:14px">
    <div class="muted" style="margin-right:4px">ê²½ê³„</div>
    <label class="muted"><input id="admSido" type="checkbox" checked> ì‹œë„</label>
    <label class="muted"><input id="admSigg" type="checkbox" checked> ì‹œêµ°êµ¬</label>
    <label class="muted"><input id="admEmd"  type="checkbox" checked> ìë©´ë™</label>
  </div>

  <div id="list" class="list" role="listbox" aria-label="ì£¼ì°¨ì¥ ëª©ë¡"></div>
</aside>

<!-- ì˜¤ë¥˜ ë¡œê·¸ ë„í¬ + FAB -->
<section class="errdock" id="errdock" aria-label="ì˜¤ë¥˜ ë¡œê·¸">
  <div class="hdr">
    <div class="title">ì˜¤ë¥˜ ë¡œê·¸</div>
    <div class="muted" id="errcount">0ê±´</div>
    <div class="grow"></div>
    <button class="btnsm" id="copyErr">ë³µì‚¬</button>
    <button class="btnsm red" id="clearErr">ì§€ìš°ê¸°</button>
    <button class="btnsm" id="closeErr">ë‹«ê¸°</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="ì˜¤ë¥˜ ë¡œê·¸ ì—´ê¸°">
  <span class="dot" aria-hidden="true"></span><span>ë¡œê·¸</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(function(){
  /* ===== ê¸°ë³¸ ì„¤ì • ===== */
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const DEMO_N = 100;
  const RADIUS_KM = 1.0;
  document.getElementById('radiusLabel').textContent = RADIUS_KM;

  const $ = (s)=>document.querySelector(s);
  const stat = $('#stat');
  const ok   = (m)=> stat.innerHTML = `<span style="color:#10b981">âœ”</span> ${m}`;
  const warn = (m)=> stat.innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

  /* ===== ì˜¤ë¥˜ ë¡œê·¸ UI ë³´ì¥ ===== */
  function ensureErrUI(){
    let dock = $('#errdock');
    let body = $('#errbody');
    let count= $('#errcount');
    let fab  = $('#errFab');
    let cntFab = $('#errCntFab');

    if(!dock){
      dock = document.createElement('section');
      dock.className='errdock'; dock.id='errdock'; dock.setAttribute('aria-label','ì˜¤ë¥˜ ë¡œê·¸');
      dock.innerHTML = `
        <div class="hdr">
          <div class="title">ì˜¤ë¥˜ ë¡œê·¸</div>
          <div class="muted" id="errcount">0ê±´</div>
          <div class="grow"></div>
          <button class="btnsm" id="copyErr">ë³µì‚¬</button>
          <button class="btnsm red" id="clearErr">ì§€ìš°ê¸°</button>
          <button class="btnsm" id="closeErr">ë‹«ê¸°</button>
        </div>
        <div class="body" id="errbody"></div>
      `;
      document.body.appendChild(dock);
      body = $('#errbody'); count = $('#errcount');
    }
    if(!fab){
      fab = document.createElement('button');
      fab.className='errfab'; fab.id='errFab'; fab.title='ì˜¤ë¥˜ ë¡œê·¸ ì—´ê¸°';
      fab.innerHTML = `<span class="dot" aria-hidden="true"></span><span>ë¡œê·¸</span><span class="cnt" id="errCntFab">0</span>`;
      document.body.appendChild(fab);
      cntFab = $('#errCntFab');
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $('#closeErr').onclick = ()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    $('#clearErr').onclick = ()=>{ body.innerHTML=''; count.textContent='0ê±´'; cntFab.textContent='0'; fab.classList.remove('error'); };
    $('#copyErr').onclick  = async ()=>{
      const txt = Array.from(body.querySelectorAll('.logrow')).map(el=>el.innerText).join('\n');
      try{ await navigator.clipboard.writeText(txt||'(ë¡œê·¸ ì—†ìŒ)'); }catch(e){}
    };
    fab.onclick = ()=>{
      const opened = dock.classList.toggle('open');
      fab.setAttribute('aria-expanded', String(opened));
    };
    return { dock, body, count, fab, cntFab };
  }
  const ERRUI = ensureErrUI();

  /* ===== ì˜¤ë¥˜ ë¡œê±° ===== */
  const logs = []; let autoOpened = false;
  const tstr = ()=> new Date().toLocaleTimeString();
  function appendRow(level, msg, extra){
    const div = document.createElement('div'); div.className='logrow';
    div.innerHTML = `<span class="time">[${tstr()}]</span><span class="lvl lvl-${level}">${level}</span><span>${msg}</span>` + (extra ? `<div class="muted" style="margin-left:8px;white-space:pre-wrap">${extra}</div>` : '');
    ERRUI.body.appendChild(div); ERRUI.body.scrollTop = ERRUI.body.scrollHeight;
  }
  function log(level, msg, detail){
    const text = typeof detail==='string' ? detail : (detail ? (detail.stack||JSON.stringify(detail)) : '');
    logs.push({t:Date.now(), level, msg, detail:text});
    appendRow(level, msg, text);
    const errCnt = logs.filter(x=>x.level==='ERR').length;
    ERRUI.count.textContent = `${logs.length}ê±´`;
    ERRUI.cntFab.textContent = String(errCnt);
    if(errCnt>0) ERRUI.fab.classList.add('error');
    if(level==='ERR' && !autoOpened){
      ERRUI.dock.classList.add('open'); ERRUI.fab.setAttribute('aria-expanded','true'); autoOpened = true;
    }
  }
  const logInfo=(m,d)=>log('INFO',m,d), logWarn=(m,d)=>log('WARN',m,d), logErr=(m,d)=>log('ERR',m,d);
  window.addEventListener('error', (e)=> logErr('window.onerror: '+e.message, e.error||e));
  window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', e.reason||e));

  /* ===== ì „ì—­ JSONP ì½œë°± (VW ì˜ˆì œ í¬ë§· ê·¸ëŒ€ë¡œ: callback:func_callback) ===== */
  const WFS_JSONP_QUEUE = []; // {layerKey, src, url}
  window.func_callback = function(payload){
    try{
      // VW ì˜ˆì œ OUTPUTì´ GMLì´ë¯€ë¡œ, payloadê°€ ë¬¸ìì—´(XML) ë˜ëŠ” ê°ì²´ì¼ ìˆ˜ ìˆìŒ.
      // ë¬¸ìì—´ì´ë©´ DOMParserë¡œ íŒŒì‹± â†’ ol.format.WFSë¡œ í”¼ì²˜ ì¶”ì¶œ
      let xmlText = '';
      if(typeof payload === 'string') xmlText = payload;
      else if(payload && payload.xml) xmlText = payload.xml;
      else if(payload && payload.responseText) xmlText = payload.responseText;
      else if(payload && typeof payload === 'object'){
        // ì¼ë¶€ í™˜ê²½ì—ì„œ {text:'<wfs:...'} ë¡œ ì˜¬ ìˆ˜ ìˆìŒ
        if(payload.text) xmlText = payload.text;
      }

      if(!xmlText || !xmlText.trim()){
        logErr('WFS(JS) JSONP payload empty');
        // ì•ˆì „ í´ë°±: ê°€ì¥ ìµœê·¼ ìš”ì²­ì„ ì‹¤íŒ¨ ì²˜ë¦¬
        const last = WFS_JSONP_QUEUE.pop();
        if(last && last.src) last.src.removeLoadedExtent_(last.url); // ë‚´ë¶€ API íšŒí”¼ìš©(ë¡œë“œì •ë„ë§Œ ë¦¬ì…‹)
        return;
      }

      const xml = new DOMParser().parseFromString(xmlText,'text/xml');
      const fmt = new ol.format.WFS(); // GML 2.1.2/3.x ìë™ íŒë³„
      const feats = fmt.readFeatures(xml, {
        dataProjection: 'EPSG:900913',
        featureProjection: 'EPSG:3857'
      });

      const last = WFS_JSONP_QUEUE.pop();
      if(last && last.src){
        last.src.addFeatures(feats);
        logInfo(`WFS(JSONPâ†’GML) parsed ${feats.length} feat(s)`);
      }
    }catch(err){
      logErr('WFS(JSONP) parse error', err);
    }
  };

  /* ===== ì•± ì‹œì‘: OpenLayers ë¡œë”© ì™„ë£Œ í›„ ì‹¤í–‰ ===== */
  function startApp(){
    ok('OpenLayers 10.6.1 ë¡œë“œ ì™„ë£Œ');

    /* ---- Base: ë¸Œì´ì›”ë“œ WMTS(Base) + OSM í´ë°± ---- */
    const vwBase = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: `https://api.vworld.kr/req/wmts/1.0.0/${VW_KEY}/Base/{z}/{y}/{x}.png?domain=${DOMAIN}`,
        maxZoom: 18, minZoom: 5
      }),
      zIndex: 0, visible: true
    });
    const osm = new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0, visible:false });

    const view = new ol.View({
      center: ol.proj.fromLonLat([127.5, 36.35]), // ì´ˆê¸°: ì„ì‹œ ì „êµ­ ì¤‘ì•™ (ê¹€ì²œ ì œê±°)
      zoom: 7, maxZoom: 18, minZoom: 5
    });
    const map = new ol.Map({ target:'map', layers:[ vwBase, osm ], view });

    // WMTS íƒ€ì¼ ì—ëŸ¬ â†’ OSM ì „í™˜(1íšŒ)
    let switchedBase = false;
    function switchToOSM(reason){
      if(switchedBase) return; switchedBase = true;
      vwBase.setVisible(false); osm.setVisible(true);
      warn(`ë¸Œì´ì›”ë“œ íƒ€ì¼ ë¬¸ì œ(${reason}) â†’ OSMë¡œ ì „í™˜`);
      logWarn('OSM fallback activated', reason);
    }
    vwBase.getSource().once('tileloaderror', (evt)=>{
      logErr('WMTS tile load error', evt && evt.tile && (evt.tile.getKey?.()||''));
      switchToOSM('tileloaderror');
    });

    /* ===== í–‰ì •ê²½ê³„: WMS(JS) ìš°ì„  â†’ ì‹¤íŒ¨ ì‹œ WFS(JS)(JSONP/GML) í´ë°± ===== */
    const VW_WMS_JS = 'https://map.vworld.kr/js/wms.do';
    const VW_WFS_JS = 'https://map.vworld.kr/js/wfs.do';

    const redLine = new ol.style.Style({ stroke:new ol.style.Stroke({ color:[239,68,68,0.95], width:2 }) });

    function buildWMSParams(layerName){
      return {
        SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
        LAYERS: layerName, STYLES:'',
        FORMAT:'image/png', TRANSPARENT:true,
        CRS:'EPSG:900913', APIKEY: VW_KEY, DOMAIN: DOMAIN
      };
    }

    // âœ… WMS ì—ëŸ¬ë¥¼ "ìµœì´ˆ 1íšŒë§Œ" ì²˜ë¦¬í•˜ê³ , ì¦‰ì‹œ ë¹ˆ ì†ŒìŠ¤ë¡œ ê°ˆì•„ë¼ì›Œ ì¶”ê°€ ì—ëŸ¬ ì°¨ë‹¨ â†’ WFS(JS) í´ë°±
    function makeAdmWMS_js(layerName, zIndex){
      const source = new ol.source.TileWMS({ url: VW_WMS_JS, params: buildWMSParams(layerName), crossOrigin:'anonymous' });
      const layer  = new ol.layer.Tile({ source, opacity:0.9, visible:true, zIndex });

      source.once('tileloaderror', ()=>{
        logErr(`WMS ${layerName} tile error â†’ WFS(JS) í´ë°±`);
        // ë‚¨ì€ íƒ€ì¼ ìš”ì²­ ì¦‰ì‹œ ì¤‘ë‹¨
        layer.setSource(new ol.source.TileImage({ tileUrlFunction: ()=>undefined }));
        layer.setVisible(false);
        activateWFS_js(layerName.toUpperCase(), zIndex + 100); // í´ë°±
      });

      return layer;
    }

    // âœ… VW ë¬¸ì„œ ì˜ˆì œ "ê·¸ëŒ€ë¡œ": OUTPUT=text/xml;subType=gml/2.1.2 & FORMAT_OPTIONS=callback:func_callback
    function buildWFS_ExampleURL(params){
      // params: {typename, bboxStr}
      // ì˜ˆì œ: https://map.vworld.kr/js/wfs.do?SERVICE=WFS&REQUEST=GetFeature&TYPENAME=LT_C_UQ111&BBOX=13987670,3912271,14359383,4642932&VERSION=1.1.0&MAXFEATURES=40&SRSNAME=EPSG:900913&PROPERTYNAME=mnum,std_sggcd,admin_cd,sido_cd,sigungu_cd,dyear,ag_geom&OUTPUT=text/xml;%20subType=gml/2.1.2&EXCEPTIONS=text/xml&FORMAT_OPTIONS=callback:func_callback&APIKEY=[APIKEY]&DOMAIN=[DOMAIN]
      const q = new URLSearchParams();
      q.set('SERVICE','WFS');
      q.set('REQUEST','GetFeature');
      q.set('TYPENAME', params.typename);     // ë ˆì´ì–´ë³„ë¡œ êµì²´
      q.set('BBOX',     params.bboxStr);      // EPSG:900913
      q.set('VERSION',  '1.1.0');
      q.set('MAXFEATURES','40');
      q.set('SRSNAME',  'EPSG:900913');
      q.set('PROPERTYNAME','mnum,std_sggcd,admin_cd,sido_cd,sigungu_cd,dyear,ag_geom');
      // ì•„ë˜ 2ê°œëŠ” ì˜ˆì œ í¬ë§· "ê·¸ëŒ€ë¡œ"
      q.set('OUTPUT','text/xml; subType=gml/2.1.2');
      q.set('EXCEPTIONS','text/xml');
      q.set('FORMAT_OPTIONS','callback:func_callback');
      q.set('APIKEY', VW_KEY);
      q.set('DOMAIN', DOMAIN);
      return `${VW_WFS_JS}?${q.toString()}`;
    }

    // BBOX ì „ëµ
    const bboxStrategy = ol.loadingstrategy.bbox;

    // WFS(JSONP/GML) on-demand
    const wfsLayers = {}; // cache by typename
    function activateWFS_js(wmsLayerName, zIndex){
      const mapTypename = {
        'LT_C_ADSIDO':'LT_C_ADSIDO_INFO',
        'LT_C_ADSIGG':'LT_C_ADSIGG_INFO',
        'LT_C_ADEMD':'LT_C_ADEMD_INFO'
      };
      const tname = mapTypename[wmsLayerName] || wmsLayerName;

      if(wfsLayers[tname]){ wfsLayers[tname].setVisible(true); return; }

      const src = new ol.source.Vector({
        format: new ol.format.WFS(), // GML íŒŒì„œ
        loader: (extent, resolution, projection)=>{
          const bboxStr = extent.join(','); // EPSG:3857 == 900913
          const url = buildWFS_ExampleURL({ typename:tname, bboxStr });
          logInfo('WFS request(JS)', url);

          // JSONP ë°©ì‹: <script> ì£¼ì… (VW ì˜ˆì œ í¬ë§· ê·¸ëŒ€ë¡œ)
          const s = document.createElement('script');
          s.src = url;
          s.onerror = ()=> logErr(`${tname} JSONP script error`);
          document.head.appendChild(s);
          // ì½œë°±ì´ ì–´ë–¤ ìˆœì„œë¡œ ì˜¤ë”ë¼ë„ ë§ˆì§€ë§‰ ìš”ì²­ë¶€í„° ì†Œë¹„í•˜ê¸° ìœ„í•´ push
          WFS_JSONP_QUEUE.push({ layerKey:tname, src, url });
        },
        strategy: bboxStrategy
      });

      const layer = new ol.layer.Vector({ source: src, style: redLine, zIndex, visible:true });
      wfsLayers[tname] = layer;
      map.addLayer(layer);

      src.on('featuresloaderror', (e)=> logErr(`WFS ${tname} load error`, JSON.stringify(e)));
    }

    // ê²½ê³„ ë ˆì´ì–´ (WMS â†’ í•„ìš” ì‹œ WFS)
    const wmsSido = makeAdmWMS_js('LT_C_ADSIDO', 201);
    const wmsSigg = makeAdmWMS_js('LT_C_ADSIGG', 202);
    const wmsEmd  = makeAdmWMS_js('LT_C_ADEMD',  203);
    map.addLayer(wmsSido); map.addLayer(wmsSigg); map.addLayer(wmsEmd);

    // ğŸ“‰ ì‹œêµ°êµ¬ëŠ” ê³ ë°°ìœ¨ì—ì„œ ì„œë²„ ì—ëŸ¬ê°€ ì¦ì•„ WMS ìì²´ë¥¼ ìˆ¨ê¹€(ìë™)
    const zHideOver = 16;
    wmsSigg.setMinResolution(view.getResolutionForZoom(zHideOver)); // z>=16ì—ì„œ WMS ë¹„ê°€ì‹œ
    // í•„ìš”ì‹œ: ë„ˆë¬´ ë©€ë¦¬ì„œë„ ìˆ¨ê¸°ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    // wmsSigg.setMaxResolution(view.getResolutionForZoom(5));

    // UI í† ê¸€
    const getLayerPair = (name)=>({wms: name==='sido'?wmsSido:name==='sigg'?wmsSigg:wmsEmd, wfs:wfsLayers});
    $('#admSido').addEventListener('change', e=>{
      if(e.target.checked){
        wmsSido.setVisible(true);
      }else{
        wmsSido.setVisible(false);
        const t='LT_C_ADSIDO_INFO'; if(wfsLayers[t]) wfsLayers[t].setVisible(false);
      }
    });
    $('#admSigg').addEventListener('change', e=>{
      if(e.target.checked){
        wmsSigg.setVisible(true);
      }else{
        wmsSigg.setVisible(false);
        const t='LT_C_ADSIGG_INFO'; if(wfsLayers[t]) wfsLayers[t].setVisible(false);
      }
    });
    $('#admEmd').addEventListener('change', e=>{
      if(e.target.checked){
        wmsEmd.setVisible(true);
      }else{
        wmsEmd.setVisible(false);
        const t='LT_C_ADEMD_INFO'; if(wfsLayers[t]) wfsLayers[t].setVisible(false);
      }
    });

    /* ---- ì•„ì´ì½˜/ìŠ¤íƒ€ì¼ (ì£¼ì°¨ì¥/í˜„ì¬ìœ„ì¹˜/ë°˜ê²½) ---- */
    const PARK_SVG =
      `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
         <circle cx='18' cy='18' r='16' fill='#2563eb'/>
         <text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
       </svg>`;
    const ME_SVG =
      `<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>
         <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
         <path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>
         <circle cx='19' cy='12' r='5' fill='#fff'/>
         <path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>
       </svg>`;

    const stylePark = new ol.style.Style({
      image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(PARK_SVG), anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1 })
    });
    const styleMe = new ol.style.Style({
      image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(ME_SVG), anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1 })
    });
    const styleCircle = new ol.style.Style({
      stroke:new ol.style.Stroke({ color:[239,68,68,0.9], width:2 }),
      fill:  new ol.style.Fill({ color:[239,68,68,0.08] })
    });

    /* ---- ì†ŒìŠ¤/ë ˆì´ì–´ ---- */
    const meSrc   = new ol.source.Vector();           // í˜„ì¬ ìœ„ì¹˜ + ë°˜ê²½ ì›
    const meLayer = new ol.layer.Vector({ source: meSrc, zIndex: 120 });
    map.addLayer(meLayer);

    const rawSrc  = new ol.source.Vector();           // ë”ë¯¸
    const clusterSrc = new ol.source.Cluster({ distance: 40, minDistance: 10, source: rawSrc });
    const clusterLy  = new ol.layer.Vector({
      source: clusterSrc,
      style: (feature)=>{
        const members = feature.get('features')||[];
        const size = members.length;
        if(size>1){
          return new ol.style.Style({
            image:new ol.style.Circle({
              radius: Math.max(12, Math.min(28, 10 + Math.log(size)*8)),
              fill: new ol.style.Fill({color:[37,99,235,0.92]}),
              stroke:new ol.style.Stroke({color:'#fff',width:2})
            }),
            text:new ol.style.Text({
              text:String(size),
              fill:new ol.style.Fill({color:'#fff'}),
              stroke:new ol.style.Stroke({color:'#000',width:3})
            })
          });
        }
        const m = members[0];
        return (m && m.getStyle && m.getStyle()) || stylePark;
      },
      zIndex: 110
    });
    map.addLayer(clusterLy);

    /* ---- íŒì—…/ë¦¬ìŠ¤íŠ¸ ---- */
    const popupEl = document.createElement('div');
    popupEl.className='ol-popup';
    popupEl.innerHTML = `<button class="x" aria-label="ë‹«ê¸°">Ã—</button><div class="tit"></div><div class="sub2 addr"></div><div class="sub2 meta"></div>`;
    const overlay = new ol.Overlay({ element: popupEl, positioning:'bottom-center', stopEvent:true, offset:[0,-14] });
    map.addOverlay(overlay);
    const closePopup = ()=> overlay.setPosition(undefined);
    popupEl.querySelector('.x').addEventListener('click', closePopup);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePopup(); });

    function openPopupForFeature(f, coord){
      const p=f.getProperties();
      popupEl.querySelector('.tit').textContent  = p.nm || 'ì£¼ì°¨ì¥';
      popupEl.querySelector('.addr').textContent = p.addr || '';
      popupEl.querySelector('.meta').textContent = `í˜•íƒœ: ${p.type||'-'} Â· ì¢Œí‘œ: ${Number(p.lat).toFixed(5)}, ${Number(p.lng).toFixed(5)}`;
      overlay.setPosition(coord);
      $('#sel').textContent = p.nm || '-';
    }

    map.on('singleclick', (evt)=>{
      let handled=false;
      map.forEachFeatureAtPixel(evt.pixel,(feature, layer)=>{
        if(layer!==clusterLy) return;
        const members = feature.get('features')||[];
        if(members.length>1){
          const ex=ol.extent.createEmpty(); members.forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
          map.getView().fit(ex,{duration:250,maxZoom:17,padding:[30,380,30,30]});
        }else if(members.length===1){
          const f=members[0], coord=f.getGeometry().getCoordinates();
          openPopupForFeature(f, coord);
          highlightList(f.get('__id'));
        }
        handled=true; return true;
      },{hitTolerance:6});
      if(!handled) closePopup();
    });

    function haversineKm(a,b){
      const R=6371,toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const t=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(t));
    }
    function generateDummyAround(lng, lat, n=DEMO_N, rKm=RADIUS_KM){
      const types=['ë…¸ìƒ','ë…¸ì™¸','ë¶€ì„¤']; const rows=[];
      for(let i=0;i<n;i++){
        const rkm=Math.random()*rKm, ang=Math.random()*Math.PI*2;
        const dLat=(rkm/111)*Math.sin(ang);
        const dLng=(rkm/(111*Math.cos(lat*Math.PI/180)))*Math.cos(ang);
        const y=lat+dLat, x=lng+dLng;
        const type = types[i%3];
        rows.push({ id:'DM-'+i, nm:`ë”ë¯¸ ${type} ì£¼ì°¨ì¥ ${i+1}`, addr:`ë°˜ê²½ ${rkm.toFixed(2)}km`, type, lng:x, lat:y });
      }
      return rows.map(r=>({ ...r, distKm: haversineKm({lng,lat},{lng:r.lng,lat:r.lat}) }));
    }
    function rebuildFeatures(rows){
      rawSrc.clear();
      const feats = rows.map(r=>{
        const coord=ol.proj.fromLonLat([r.lng,r.lat]);
        const f=new ol.Feature({ geometry:new ol.geom.Point(coord), __id:r.id, ...r });
        f.setStyle(stylePark);
        return f;
      });
      rawSrc.addFeatures(feats);
    }

    // ì¢Œì¸¡ ëª©ë¡
    let ROWS_ALL=[], ROWS_VIEW=[], currentType="";
    function buildList(rows){
      const listEl=$('#list'), countEl=$('#count');
      countEl.textContent = String(rows.length);
      if(rows.length===0){
        listEl.innerHTML = `<div class="item"><div class="nm">ê²°ê³¼ ì—†ìŒ</div><div class="sub">ë°˜ê²½ ${RADIUS_KM}km / í˜•íƒœ: ${currentType||'ì „ì²´'}</div></div>`;
        return;
      }
      listEl.innerHTML = rows.map((r,i)=>`
        <div class="item" data-id="${r.id}" role="option" tabindex="0">
          <div class="nm">${i+1}. ${r.nm}</div>
          <div class="sub"><span class="badge">${r.type}</span><span class="dist">${r.distKm.toFixed(2)} km</span><span>${r.addr}</span></div>
        </div>`).join('');
      listEl.querySelectorAll('.item').forEach(el=>{
        el.addEventListener('click', ()=> focusItem(el.dataset.id));
        el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ focusItem(el.dataset.id); e.preventDefault(); }});
      });
    }
    function highlightList(id){
      $('#list').querySelectorAll('.item').forEach(el=> el.classList.toggle('active', el.dataset.id===id));
    }
    function focusItem(id){
      const r = ROWS_VIEW.find(x=>x.id===id) || ROWS_ALL.find(x=>x.id===id);
      if(!r) return;
      const coord=ol.proj.fromLonLat([r.lng,r.lat]);
      map.getView().setCenter(coord); map.getView().setZoom(16);
      openPopupForFeature(new ol.Feature({geometry:new ol.geom.Point(coord), ...r}), coord);
      highlightList(id);
    }
    function applyFilter(){
      ROWS_VIEW = ROWS_ALL.filter(r=>!currentType || r.type===currentType).sort((a,b)=>a.distKm-b.distKm);
      buildList(ROWS_VIEW);
      rebuildFeatures(ROWS_VIEW);
    }
    $('#typeBar').addEventListener('click', (e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      chip.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      currentType = chip.dataset.type || "";
      closePopup();
      applyFilter();
    });

    // í˜„ì¬ ìœ„ì¹˜/ë°˜ê²½ ì›/ì‹œë“œ
    function setMeAndSeed(lng, lat, msg){
      meSrc.clear();
      const center = ol.proj.fromLonLat([lng,lat]);
      const me = new ol.Feature({ geometry:new ol.geom.Point(center) }); me.setStyle(styleMe); meSrc.addFeature(me);
      const circle = new ol.Feature({ geometry:new ol.geom.Circle(center, RADIUS_KM*1000) }); circle.setStyle(styleCircle); meSrc.addFeature(circle);

      ROWS_ALL = generateDummyAround(lng, lat, DEMO_N, RADIUS_KM);
      applyFilter();

      map.getView().setCenter(center); map.getView().setZoom(15);
      ok(`${msg} Â· ë°˜ê²½ ${RADIUS_KM}km Â· ë”ë¯¸ ${DEMO_N}ê°œ`);

      // ğŸ“¦ í˜„ ìœ„ì¹˜ ê¸°ì¤€ ë·° ë²”ìœ„ â†’ ê²½ê³„ëŠ” í´ë°± ì¤€ë¹„
      // ì²˜ìŒë¶€í„° ê³¼í™•ëŒ€ì¼ ìˆ˜ ìˆì–´ WMSê°€ ê¸ˆë°© ì—ëŸ¬ë‚˜ë©´ ìë™ í´ë°±ë¨
    }
    function fitAll(){
      const ex=ol.extent.createEmpty();
      meSrc.getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
      rawSrc.getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
      if(!ol.extent.isEmpty(ex)) map.getView().fit(ex,{duration:400, padding:[30,380,30,30], maxZoom:17});
    }
    $('#locBtn').addEventListener('click', ()=> autoLocate(true));
    $('#fitBtn').addEventListener('click', fitAll);

    function autoLocate(fly=false){
      const isSecure = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!isSecure || !navigator.geolocation){
        warn('ìœ„ì¹˜ ê¶Œí•œ/ë³´ì•ˆ ë¬¸ì œë¡œ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        logWarn('geolocation unsupported or insecure origin', location.origin);
        return; // âœ… ê¹€ì²œ ë“± ì´ˆê¸° ê³ ì • ìœ„ì¹˜ ì œê±°
      }
      const opts={ enableHighAccuracy:true, maximumAge:5000, timeout:9000 };
      const apply=(lng,lat)=>{
        setMeAndSeed(lng,lat,'í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€');
        if(fly){ map.getView().animate({center:ol.proj.fromLonLat([lng,lat]), zoom:15, duration:400}); }
        logInfo('geolocated', JSON.stringify({lng,lat}));
      };
      const wid=navigator.geolocation.watchPosition(
        p=>{ apply(p.coords.longitude,p.coords.latitude); navigator.geolocation.clearWatch(wid); },
        err=>{ logErr('watchPosition error', `${err.code} ${err.message}`); },
        opts
      );
      navigator.geolocation.getCurrentPosition(
        p=>{ apply(p.coords.longitude,p.coords.latitude); navigator.geolocation.clearWatch(wid); },
        err=>{ logErr('getCurrentPosition error', `${err.code} ${err.message}`); warn('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.'); },
        opts
      );
    }

    // ì‹œì‘: ìœ„ì¹˜ë§Œ ëŒ€ê¸°(ê¹€ì²œ ì œê±°)
    autoLocate(false);
  }

  function domReady(cb){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', cb); else cb(); }
  window.OL_READY.then(()=> domReady(()=> startApp())).catch(err=>{
    const msg = 'OpenLayers 10.6.1 ë¡œë”© ì‹¤íŒ¨ (ë¡œì»¬+CDN ëª¨ë‘ ì‹¤íŒ¨)';
    warn(msg);
    logErr(msg, (err && (err.stack||err.message)) || String(err));
  });
})();
</script>
</body>
</html>