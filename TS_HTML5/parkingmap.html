<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>행정구역도 · VWorld WFS(JSONP) · 에러로그(URL 포함) · OL 10.6.1</title>

<!-- OpenLayers 동적 로더 (로컬 → CDN 폴백) -->
<script>
(function(){
  const basePath = location.pathname.replace(/\/[^/]*$/, '');
  const localCSS = basePath + '/vendor/ol/10.6.1/ol.css';
  const localJS  = basePath + '/vendor/ol/10.6.1/ol.js';
  const repoCSS  = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.css';
  const repoJS   = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.js';
  const cssSrcs = [localCSS, repoCSS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'];
  const jsSrcs  = [localJS, repoJS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js'];

  function loadCSS(list,i=0){ if(i>=list.length) return; const l=document.createElement('link');
    l.rel='stylesheet'; l.href=list[i]; l.onerror=()=>loadCSS(list,i+1); document.head.appendChild(l); }
  function loadJS(list,i,resolve,reject){
    if(i>=list.length) return reject(new Error('OpenLayers JS load failed'));
    const s=document.createElement('script'); s.src=list[i]; s.defer=false; s.async=false; s.crossOrigin='anonymous';
    let done=false;
    const next=()=>{ if(done) return; done=true; s.remove(); loadJS(list,i+1,resolve,reject); };
    s.onload=()=> setTimeout(()=> (window.ol&&ol.Map)?(done=true,resolve(list[i])):next(),0);
    s.onerror=next; document.head.appendChild(s);
  }
  loadCSS(cssSrcs,0);
  window.OL_READY=new Promise((res,rej)=>{ if(window.ol&&ol.Map){res('(preloaded)');}else{loadJS(jsSrcs,0,res,rej);} });
})();
</script>

<style>
  html,body{height:100%;margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}
  .toolbar{
    position:fixed; left:12px; top:12px; z-index:20;
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .btn{border:1px solid #334155;background:#0f172a;color:#c7d2fe;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .muted{color:#94a3b8}

  /* 오류 로그(FAB + 도크) — ERR만 표시 */
  .errdock{ position:fixed; right:12px; bottom:68px; z-index:1000;
    width:min(560px, calc(100% - 24px)); background:#0f172a; border:1px solid #20304f; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; flex-direction:column }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid #20304f }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{ max-height:38vh; overflow:auto; padding:8px 10px;
    font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.86rem; background:#0b1220 }
  .logrow{ border-bottom:1px dashed #1d2741; padding:6px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px; color:#fca5a5 }
  .url{ color:#60a5fa; word-break:break-all; }
  .btnsm{ border:1px solid #20304f; background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }
  .errfab{ position:fixed; right:12px; bottom:12px; z-index:1001; background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px; box-shadow:0 8px 20px rgba(0,0,0,.35) }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}
  @media (max-width:480px){ .errdock{ left:8px; right:8px; width:auto } .toolbar{ left:8px; right:8px } }
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<div class="toolbar">
  <button class="btn" id="locBtn">현재 위치</button>
  <span class="muted" id="stat">초기화 중…</span>
</div>

<!-- 오류 로그 도크 + FAB (ERR 전용, URL 표시) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div class="grow"></div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm red" id="clearErr">지우기</button>
    <button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(function(){
  /* ===== 기본 설정 ===== */
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const WFS_API = 'https://api.vworld.kr/req/wfs';
  const SRS = 'EPSG:900913';

  const $ = (s)=>document.querySelector(s);
  const stat = $('#stat');
  const ok   = (m)=> stat.innerHTML = `<span style="color:#10b981">✔</span> ${m}`;
  const warn = (m)=> stat.innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

  /* ===== 오류 로그(UI에는 ERR만) ===== */
  const ERRUI = (function ensureErrUI(){
    let dock=$('#errdock'), body=$('#errbody'), count=$('#errcount'), fab=$('#errFab'), cntFab=$('#errCntFab');
    $('#closeErr').onclick = ()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    $('#clearErr').onclick = ()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
    $('#copyErr').onclick  = async ()=>{ const txt=[...body.querySelectorAll('.logrow')].map(el=>el.innerText).join('\n'); try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch{} };
    fab.onclick = ()=>{ const opened=dock.classList.toggle('open'); fab.setAttribute('aria-expanded', String(opened)); };
    return {dock,body,count,fab,cntFab};
  })();
  const LAST_ERR_AT = new Map();
  const ERR_THROTTLE = 1500;
  const nowStr = ()=> new Date().toLocaleTimeString();
  function logErr(msg, url, detail){
    const key = msg + '|' + (url||'');
    const now = Date.now(), prev = LAST_ERR_AT.get(key)||0;
    if (now - prev < ERR_THROTTLE) return;
    LAST_ERR_AT.set(key, now);

    const row=document.createElement('div'); row.className='logrow';
    row.innerHTML = `<span class="time">[${nowStr()}]</span><span class="lvl">ERR</span><span>${msg}</span>` +
                    (url?`<div class="url">${url}</div>`:'') +
                    (detail?`<div class="muted" style="white-space:pre-wrap">${detail}</div>`:'');
    ERRUI.body.appendChild(row); ERRUI.body.scrollTop = ERRUI.body.scrollHeight;
    const n=(Number(ERRUI.cntFab.textContent)||0)+1; ERRUI.cntFab.textContent=String(n); ERRUI.fab.classList.add('error');
    ERRUI.count.textContent = `${ERRUI.body.querySelectorAll('.logrow').length}건`;
  }
  window.addEventListener('error', (e)=> logErr('window.onerror: '+e.message, '', e.error?.stack||''));
  window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', '', (e.reason&&e.reason.stack)||String(e.reason||'')));

  /* ===== WFS(JSONP) URL 빌더 ===== */
  function buildWFSUrlJSONP(typename, bbox, cbName){
    const p = new URLSearchParams({
      SERVICE:'WFS', REQUEST:'GetFeature', VERSION:'1.1.0',
      TYPENAME: typename,
      SRSNAME: SRS,
      BBOX: bbox.join(','),            // xmin,ymin,xmax,ymax (EPSG:900913)
      MAXFEATURES:'1000',
      OUTPUT:'text/javascript',        // JSONP
      EXCEPTIONS:'text/xml',
      FORMAT_OPTIONS:`callback:${cbName}`,
      KEY: VW_KEY, DOMAIN: DOMAIN
    });
    return `${WFS_API}?${p.toString()}`;
  }

  /* ===== JSONP 로더 (GeoJSON 기대) ===== */
  function jsonpLoadGeoJSON(url, cbName){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      let timeout=setTimeout(()=>{ cleanup(); reject(new Error('jsonp_timeout')); }, 12000);
      function cleanup(){ clearTimeout(timeout); try{s.remove();}catch{} try{delete window[cbName];}catch{} }
      window[cbName]=function(payload){
        try{
          const json = (typeof payload==='string') ? JSON.parse(payload) : payload;
          cleanup(); resolve(json);
        }catch(e){ cleanup(); reject(e); }
      };
      s.src=url; s.onerror=()=>{ cleanup(); reject(new Error('JSONP script_error')); };
      document.head.appendChild(s);
    });
  }

  /* ===== 행정구역 레이어(줌별 자동전환) ===== */
  const ADMIN_LAYERS = [
    { tn:'lt_c_adsido_info', name:'시도',   minZ:0,  maxZ:8,  stroke:[59,130,246,1.0],  fillA:0.03, z:240 },
    { tn:'lt_c_adsigg_info', name:'시군구', minZ:8,  maxZ:12, stroke:[16,185,129,1.0],  fillA:0.03, z:241 },
    { tn:'lt_c_ademd_info',  name:'읍면동', minZ:12, maxZ:16, stroke:[234,179,8,1.0],   fillA:0.025,z:242 },
    { tn:'lt_c_adri_info',   name:'리',     minZ:16, maxZ:22, stroke:[244,63,94,1.0],   fillA:0.02, z:243 }
  ];

  function makeAdminLayer(def, map){
    const src = new ol.source.Vector({ strategy: ol.loadingstrategy.bbox, wrapX:true });
    const lyr = new ol.layer.Vector({
      source: src, zIndex:def.z,
      style: new ol.style.Style({
        stroke:new ol.style.Stroke({ color:def.stroke, width:1.5 }),
        fill:new ol.style.Fill({ color:[def.stroke[0],def.stroke[1],def.stroke[2], def.fillA] })
      }),
      visible:true
    });

    // bbox 로더
    src.setLoader((extent,resolution,projection)=>{
      const z = map.getView().getZoom();
      if (z < def.minZ || z >= def.maxZ){ src.clear(true); return; }

      // 중복 과요청 방지: 간단히 clear 후 현재 화면만
      src.clear(true);

      const cb = `vw_cb_${def.tn}_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      const url = buildWFSUrlJSONP(def.tn, extent, cb);
      jsonpLoadGeoJSON(url, cb)
        .then(json=>{
          const fmt = new ol.format.GeoJSON();
          const feats = fmt.readFeatures(json, { dataProjection:SRS, featureProjection:'EPSG:3857' });
          if (feats && feats.length) src.addFeatures(feats);
          else {
            // 빈 결과는 오류 아님. 필요시 아래 주석 해제
            // logErr(`WFS 응답 0건(${def.tn})`, url);
          }
        })
        .catch(err=>{
          logErr(`WFS 로드 실패(${def.tn})`, url, err && (err.stack||err.message)||String(err));
        });
    });

    // 화면 이동/줌 변경 시 250ms 디바운스 재요청
    let deb;
    function reload(){
      clearTimeout(deb);
      deb = setTimeout(()=>{
        const ex = map.getView().calculateExtent(map.getSize());
        src.loader_(ex, map.getView().getResolution(), map.getView().getProjection());
      }, 250);
    }
    map.on('moveend', reload);
    map.getView().on('change:resolution', reload);

    // 초기 1회 로드
    setTimeout(()=> reload(), 0);
    return lyr;
  }

  /* ===== 앱 시작 ===== */
  function startApp(){
    const view = new ol.View({
      center: ol.proj.fromLonLat([127.5,36.4]),
      zoom: 7, minZoom:4, maxZoom:19
    });
    const base = new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0 });
    window.map = new ol.Map({ target:'map', layers:[base], view });

    // 현재 위치(표시용)
    const meSrc=new ol.source.Vector(), meLy=new ol.layer.Vector({source:meSrc, zIndex:700});
    map.addLayer(meLy);
    const ME_SVG =
      `<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>
         <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
         <path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>
         <circle cx='19' cy='12' r='5' fill='#fff'/><path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>
       </svg>`;
    const meStyle=new ol.style.Style({ image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(ME_SVG), anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction' }) });

    function setMe(lng,lat){
      meSrc.clear();
      const p=ol.proj.fromLonLat([lng,lat]);
      const f=new ol.Feature({ geometry:new ol.geom.Point(p) }); f.setStyle(meStyle); meSrc.addFeature(f);
      map.getView().animate({center:p, zoom:14, duration:350});
      ok('현재 위치 표시 완료');
    }

    // 행정구역 레이어 장착
    ADMIN_LAYERS.forEach(def=> map.addLayer( makeAdminLayer(def, map) ));

    // 위치 버튼
    $('#locBtn').addEventListener('click', ()=>{
      const httpsOK = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!httpsOK || !navigator.geolocation){ warn('위치 권한/환경 문제(https 필요)'); return; }
      navigator.geolocation.getCurrentPosition(
        p=> setMe(p.coords.longitude, p.coords.latitude),
        e=> logErr('geolocation 실패', '', `${e.code} ${e.message}`),
        { enableHighAccuracy:true, maximumAge:5000, timeout:9000 }
      );
    });

    ok('OpenLayers 10.6.1 로드 완료');
  }

  function domReady(cb){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', cb); else cb(); }
  window.OL_READY.then(()=> domReady(startApp)).catch(err=>{
    logErr('OpenLayers 로딩 실패', '', (err && (err.stack||err.message))||String(err));
  });
})();
</script>
</body>
</html>