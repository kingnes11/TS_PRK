<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>브이월드 WMTS + 경계 WMS/WFS 폴백 · 리스트/필터 · 오류로그(FAB) · OL 10.6.1</title>

<!-- ① 플랫폼/폼팩터 감지: html에 platform-xxx / ff-xxx 클래스 부여 -->
<script>
(function(){
  const html = document.documentElement;
  const ua = (navigator.userAgent || navigator.vendor || '').toLowerCase();
  const isIOS = /iphone|ipad|ipod/.test(ua) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
  const isAndroid = /android/.test(ua);
  html.classList.add(isIOS ? 'platform-ios' : (isAndroid ? 'platform-android' : 'platform-other'));

  // 물리 픽셀 기준 최소 변(가로·세로 중 작은 값)으로 폼팩터 추정
  const minPx = Math.min(screen.width, screen.height) / (window.devicePixelRatio || 1);
  const isTablet = minPx >= 600 && minPx < 1025;
  const isDesktop = minPx >= 1025;
  html.classList.add(isDesktop ? 'ff-desktop' : (isTablet ? 'ff-tablet' : 'ff-phone'));
})();
</script>

<!-- ✅ OpenLayers 동적 로더: 10.6.1 (로컬 → CDN 폴백) -->
<script>
(function(){
  const basePath = location.pathname.replace(/\/[^/]*$/, '');
  const localCSS = basePath + '/vendor/ol/10.6.1/ol.css';
  const localJS  = basePath + '/vendor/ol/10.6.1/ol.js';
  const repoCSS  = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.css';
  const repoJS   = '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.js';

  const cssSrcs = [
    localCSS, repoCSS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'
  ];
  const jsSrcs = [
    localJS, repoJS,
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js'
  ];

  function loadCSS(list, i=0){
    if(i>=list.length) return;
    const link=document.createElement('link');
    link.rel='stylesheet'; link.href=list[i];
    link.onerror=()=>loadCSS(list, i+1);
    document.head.appendChild(link);
  }
  function loadJS(list, i, resolve, reject){
    if(i>=list.length) return reject(new Error('OpenLayers JS load failed (all sources)'));
    const s=document.createElement('script');
    s.src=list[i]; s.defer=false; s.async=false; s.crossOrigin='anonymous';
    let done=false;
    const next=()=>{ if(done) return; done=true; s.remove(); loadJS(list, i+1, resolve, reject); };
    s.onload=()=>{ setTimeout(()=>{ (window.ol && typeof ol.Map==='function') ? (done=true, resolve(list[i])) : next(); },0); };
    s.onerror=next;
    document.head.appendChild(s);
  }

  loadCSS(cssSrcs, 0);
  window.OL_READY = new Promise((resolve,reject)=>{
    if(window.ol && typeof ol.Map==='function'){ resolve('(preloaded)'); return; }
    loadJS(jsSrcs, 0, resolve, reject);
  });
})();
</script>

<!-- ② 스타일(리스트/오류로그가 기기별로 자동 리사이즈) -->
<style>
  :root{
    /* 공통 테마 */
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;

    /* 데스크탑 기본값 */
    --side-w: 360px;
    --side-gap: 12px;
    --side-top: 12px;
    --side-bottom: 12px;
    --list-max-h: 62vh;
    --errdock-w: 560px;
    --errdock-max-h: 50vh;
    --err-right: 12px;
    --err-bottom: 68px;
  }

  /* 작은 폰(갤럭시/아이폰 공통) */
  @media (max-width: 430px){
    :root{
      --side-w: calc(100% - 16px);
      --side-gap: 8px;
      --side-top: 8px;
      --side-bottom: calc(8px + env(safe-area-inset-bottom));
      --list-max-h: 42svh;
      --errdock-w: calc(100% - 16px);
      --errdock-max-h: 48svh;
      --err-right: 8px;
      --err-bottom: calc(10px + env(safe-area-inset-bottom));
    }
  }

  /* 큰 폰/패블릿 */
  @media (min-width: 431px) and (max-width: 599px){
    :root{
      --side-w: min(440px, calc(100% - 20px));
      --list-max-h: 50svh;
      --errdock-w: min(520px, calc(100% - 20px));
      --errdock-max-h: 52svh;
    }
  }

  /* 태블릿 세로 */
  @media (min-width: 600px) and (max-width: 1024px) and (orientation: portrait){
    :root{
      --side-w: 420px;
      --list-max-h: 58svh;
      --errdock-w: 560px;
      --errdock-max-h: 52svh;
    }
  }

  /* 태블릿 가로(높이가 낮으니 더 줄임) */
  @media (min-width: 800px) and (orientation: landscape){
    :root{
      --list-max-h: 46svh;
      --errdock-max-h: 46svh;
    }
  }

  /* iOS 전용(노치/홈바 여백 고려: 살짝 더 보수적으로) */
  html.platform-ios.ff-phone{
    --list-max-h: 40svh;
    --errdock-max-h: 46svh;
  }
  html.platform-ios.ff-tablet{
    --list-max-h: 50svh;
    --errdock-max-h: 50svh;
  }

  /* ===== 레이아웃 ===== */
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0;height:100dvh;width:100vw}

  /* 좌측 패널(리스트) */
  .side{
    position:fixed; left:12px; top:var(--side-top); bottom:var(--side-bottom); width:var(--side-w); z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media (max-width:960px){ .side{ right:12px; width:auto } }

  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent}

  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#c7d2fe; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem}
  .chip.active{background:var(--chipOn); color:#fff; border-color:transparent}

  .list{
    overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530;
    max-height: var(--list-max-h);
  }
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}
  .dist{color:#9ca3af}

  /* 팝업 */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  /* 오류 로그 도크 + FAB (오류만 표시 로직은 기존 JS 유지) */
  .errdock{
    position:fixed; right:var(--err-right); bottom:var(--err-bottom); z-index:1000;
    width:var(--errdock-w);
    max-height:var(--errdock-max-h);
    background:#0f172a; border:1px solid var(--border); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:none; flex-direction:column;
  }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{
    overflow:auto; padding:8px 10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem;
    background:#0b1220
  }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px }
  .lvl-INFO{ color:#93c5fd } .lvl-WARN{ color:#fbbf24 } .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }

  .errfab{
    position:fixed; right:var(--err-right);
    bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:1001;
    background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.35)
  }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}
</style>
</head>

<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널 -->
<aside class="side">
  <div class="row title">
    <div>주차장(반경 <b id="radiusLabel">5</b>km)</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
  </div>

  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn ghost" id="fitBtn">전체 보기</button>
    <span id="stat" class="muted" style="margin-left:auto">초기화 중…</span>
  </div>

  <div class="chipbar" id="typeBar" role="group" aria-label="주차장 형태 필터">
    <div class="chip active" data-type="">전체</div>
    <div class="chip" data-type="노상">노상</div>
    <div class="chip" data-type="노외">노외</div>
    <div class="chip" data-type="부설">부설</div>
  </div>

  <!-- ★ 행정경계 토글 -->
  <div class="row" id="admToggles" style="gap:14px">
    <div class="muted" style="margin-right:4px">경계</div>
    <label class="muted"><input id="admSido" type="checkbox" checked> 시도</label>
    <label class="muted"><input id="admSigg" type="checkbox" checked> 시군구</label>
    <label class="muted"><input id="admEmd"  type="checkbox" checked> 읍면동</label>
  </div>

  <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
</aside>

<!-- 오류 로그 도크 + FAB (기존 마크업 유지) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div class="grow"></div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm red" id="clearErr">지우기</button>
    <button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<!-- ====== 아래부터는 “기존 JS” 그대로 사용하세요 (지도/WMS/WFS/더미주차장/오류로거 등) ====== -->
<script>
/* ▶▶ 기존의 전체 앱 스크립트(startApp 포함) 그대로 붙여두세요.
   본 합본은 레이아웃/반응형만 건드렸고, 기능/로직은 변경하지 않았습니다. */
(function(){
  /* ===== 기본 설정 ===== */
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const INIT   = { lng:128.1136, lat:36.1398 };     // (초기 센터만 사용, 현재위치로 업그레이드)
  const DEMO_N = 1000;
  const RADIUS_KM = 5.0;
  document.getElementById('radiusLabel').textContent = RADIUS_KM;

  const $ = (s)=>document.querySelector(s);
  const stat = $('#stat');
  const ok   = (m)=> stat.innerHTML = `<span style="color:#10b981">✔</span> ${m}`;
  const warn = (m)=> stat.innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

  /* ===== 오류 로그 UI/로거: 기존 그대로 ===== */
  function ensureErrUI(){
    let dock = $('#errdock');
    let body = $('#errbody');
    let count= $('#errcount');
    let fab  = $('#errFab');
    let cntFab = $('#errCntFab');

    if(!dock){
      dock = document.createElement('section');
      dock.className='errdock'; dock.id='errdock'; dock.setAttribute('aria-label','오류 로그');
      dock.innerHTML = `
        <div class="hdr">
          <div class="title">오류 로그</div>
          <div class="muted" id="errcount">0건</div>
          <div class="grow"></div>
          <button class="btnsm" id="copyErr">복사</button>
          <button class="btnsm red" id="clearErr">지우기</button>
          <button class="btnsm" id="closeErr">닫기</button>
        </div>
        <div class="body" id="errbody"></div>
      `;
      document.body.appendChild(dock);
      body = $('#errbody'); count = $('#errcount');
    }
    if(!fab){
      fab = document.createElement('button');
      fab.className='errfab'; fab.id='errFab'; fab.title='오류 로그 열기';
      fab.innerHTML = `<span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>`;
      document.body.appendChild(fab);
      cntFab = $('#errCntFab');
    }

    $('#closeErr').onclick = ()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    $('#clearErr').onclick = ()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
    $('#copyErr').onclick  = async ()=>{
      const txt = Array.from(body.querySelectorAll('.logrow')).map(el=>el.innerText).join('\n');
      try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch(e){}
    };
    fab.onclick = ()=>{
      const opened = dock.classList.toggle('open');
      fab.setAttribute('aria-expanded', String(opened));
    };
    return { dock, body, count, fab, cntFab };
  }
  const ERRUI = ensureErrUI();

  const logs = []; let autoOpened = false;
  const tstr = ()=> new Date().toLocaleTimeString();
  function appendRow(level, msg, extra){
    const div = document.createElement('div'); div.className='logrow';
    div.innerHTML = `<span class="time">[${tstr()}]</span><span class="lvl lvl-${level}">${level}</span><span>${msg}</span>` + (extra ? `<div class="muted" style="margin-left:8px;white-space:pre-wrap">${extra}</div>` : '');
    ERRUI.body.appendChild(div); ERRUI.body.scrollTop = ERRUI.body.scrollHeight;
  }
  function log(level, msg, detail){
    const text = typeof detail==='string' ? detail : (detail ? (detail.stack||JSON.stringify(detail)) : '');
    logs.push({t:Date.now(), level, msg, detail:text});
    appendRow(level, msg, text);
    const errCnt = logs.filter(x=>x.level==='ERR').length;
    ERRUI.count.textContent = `${logs.length}건`;
    ERRUI.cntFab.textContent = String(errCnt);
    if(errCnt>0) ERRUI.fab.classList.add('error');
    if(level==='ERR' && !autoOpened){
      ERRUI.dock.classList.add('open'); ERRUI.fab.setAttribute('aria-expanded','true'); autoOpened = true;
    }
  }
  const logInfo=(m,d)=>log('INFO',m,d), logWarn=(m,d)=>log('WARN',m,d), logErr=(m,d)=>log('ERR',m,d);
  window.addEventListener('error', (e)=> logErr('window.onerror: '+e.message, e.error||e));
  window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', e.reason||e));

  /* ===== 앱 시작 ===== */
  function startApp(olSrc){
    logInfo('OpenLayers loaded', olSrc); ok('OpenLayers 10.6.1 로드 완료');

    /* ---- 브이월드 WMTS(Base) + OSM 폴백 ---- */
    const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
    const DOMAIN = 'kingnes11.github.io';

    const vwBase = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: `https://api.vworld.kr/req/wmts/1.0.0/${VW_KEY}/Base/{z}/{y}/{x}.png?domain=${DOMAIN}`,
        maxZoom: 18, minZoom: 5
      }),
      zIndex: 0, visible: true
    });
    const osm = new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0, visible:false });

    const map = new ol.Map({
      target:'map',
      layers:[ vwBase, osm ],
      view: new ol.View({
        center: ol.proj.fromLonLat([INIT.lng, INIT.lat]),
        zoom: 15, maxZoom: 18, minZoom: 5
      })
    });

    let switched = false;
    function switchToOSM(reason){
      if(switched) return; switched = true;
      vwBase.setVisible(false); osm.setVisible(true);
      warn(`브이월드 타일 문제(${reason}) → OSM로 전환`);
      logWarn('OSM fallback activated', reason);
    }
    vwBase.getSource().on('tileloaderror', (evt)=>{
      const key = evt && evt.tile && (evt.tile.getKey?.()||'');
      logErr('WMTS tile load error', key);
      switchToOSM('tileloaderror');
    });

    /* ---- 이하: 경계 WMS/WFS, 더미 주차장, 팝업/리스트 등 기존 코드 그대로 ---- */
    // ... (여기에 사용 중인 WMS/WFS 레이어 생성/폴백, 주차장 클러스터/목록/필터/팝업 로직이 그대로 이어집니다)
    // ▶ 원본 파일의 나머지 JS를 그대로 두세요 ◀

    // 시작: 초기 센터 → 현재위치 업그레이드 (원본 로직 유지)
    // ...
  }

  function domReady(cb){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', cb); else cb(); }
  window.OL_READY.then((src)=> domReady(()=> startApp(src))).catch(err=>{
    const msg = 'OpenLayers 10.6.1 로딩 실패 (로컬+CDN 모두 실패)';
    warn(msg);
    logErr(msg, (err && (err.stack||err.message)) || String(err));
  });
})();
</script>
</body>
</html>