<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>김천시 주차장 지도 · 현재위치 중심 + 사람 아이콘</title>

<!-- VWorld 2D API (도메인 등록 必) -->
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=YOUR_API_KEY&domain=YOUR_DOMAIN"></script>

<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#2563eb; --accent2:#1d4ed8; --ok:#10b981; --ring:rgba(59,130,246,.35);
    --border:#20304f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}
  header{position:fixed;inset-inline:0;top:0;z-index:10;padding:10px 12px;
    background:linear-gradient(180deg,#0b1220cc,#0b122000);display:flex;gap:8px;align-items:center}
  header .title{font-weight:700}
  header .pill{margin-left:auto;color:var(--muted);font-size:.9rem;display:flex;gap:10px;align-items:center}
  .panel{position:fixed;left:12px;right:12px;bottom:12px;z-index:20;display:grid;gap:8px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:0 4px 24px rgba(0,0,0,.35)}
  .controls{display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px}
  .control{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .control:focus-within{outline:3px solid var(--ring);outline-offset:1px}
  input,select{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-size:1rem}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;
    background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--border)}
  .hint{color:var(--muted);font-size:.85rem}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;z-index:30;background:#111827;color:#fff;
    border:1px solid #374151;padding:10px 12px;border-radius:10px;display:none}

  /* 팝업 */
  .ol-popup{position:absolute;background:#111827;color:#e5e7eb;padding:8px 10px;border:1px solid #374151;border-radius:10px;
    min-width:180px;transform:translate(-50%,-110%);pointer-events:none}
  .ol-popup .tit{font-weight:700}
  .ol-popup .sub{color:#9ca3af;font-size:.9rem}
</style>
</head>
<body>
  <div id="map" aria-label="브이월드 2D 지도"></div>

  <header>
    <div class="title">주차장 지도 · 김천시(클러스터)</div>
    <div class="pill">
      <span><b id="count">0</b>개</span>
      <span class="hint">선택: <b id="sel">-</b></span>
    </div>
  </header>

  <div class="panel">
    <div class="card">
      <div class="controls">
        <div class="control"><input id="q" type="search" placeholder="주차장명 검색 (예: 혁신도시)" /></div>
        <div class="control">
          <select id="type">
            <option value="">형태(전체)</option>
            <option value="노상">노상</option>
            <option value="노외">노외</option>
            <option value="부설">부설</option>
          </select>
        </div>
        <div class="control">
          <select id="distance">
            <option value="40">클러스터 간격(기본)</option>
            <option value="20">20 (촘촘)</option>
            <option value="60">60 (성김)</option>
          </select>
        </div>
      </div>
      <div class="btns">
        <button class="btn" id="fitBtn">전체 보기</button>
        <button class="btn ghost" id="locBtn">내 위치 다시 잡기</button>
        <button class="btn ghost" id="resetBtn">초기화</button>
        <span class="hint">※ `apiKey`/`domain`은 VWorld 서비스 URL과 일치해야 합니다.</span>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* --------------------------
   0) 상수/유틸
--------------------------- */
const VWORLD_KEY = "YOUR_API_KEY";
const VWORLD_DOMAIN = location.hostname;
const GIMCHEON_CENTER = { lng:128.1136, lat:36.1398 }; // 김천시 중심 근사
const GIMCHEON_RADIUS_M = 5000;                        // 5km
const $ = (s)=>document.querySelector(s);
const countEl = $('#count'), selEl = $('#sel');
const toast = $('#toast');

let USER_CENTER_LOCK = false; // ★ 내 위치를 잡은 뒤엔 fitAll로 지도를 덮어쓰지 않게 하는 플래그
let TS_COORD = { lng:128.1765, lat:36.1219 }; // 참고(한국교통안전공단, 사용 안 해도 무방)

function showToast(msg, ms=2400){
  toast.textContent = msg; toast.style.display='block';
  clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none', ms);
}
function km(a,b){
  const R=6371,toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const t=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.sqrt(t));
}
function inferType(name="", category="", addr=""){
  if(/노상/.test(name)||/노상/.test(category)) return "노상";
  if(/노외|공영|타워|주차타워/.test(name)||/노외|공영|타워/.test(category)) return "노외";
  if(/부설|몰|백화점|병원|학교|아파트/.test(name+addr)) return "부설";
  return "노외";
}

/* --------------------------
   ★ 아이콘 교체 지점
--------------------------- */
/* 1) 주차장 아이콘(기본: 파란 P 원) */
const PARK_ICON_URL = "";     // 예) "https://your.cdn/parking-pin.png" (비워두면 SVG 사용)
const PARK_ICON_SCALE = 1.0;
const PARK_ICON_ANCHOR = [0.5, 0.5];
const PARK_ICON_SVG = `
<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
  <circle cx='18' cy='18' r='16' fill='#2563eb'/>
  <text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
</svg>`;
function PARK_ICON_SRC(){
  return PARK_ICON_URL || ('data:image/svg+xml;utf8,' + encodeURIComponent(PARK_ICON_SVG.trim()));
}

/* 2) 사람(내 위치) 아이콘(기본: 사람 실루엣) */
const PERSON_ICON_URL = "";   // 예) "https://your.cdn/person-pin.png" (비워두면 SVG 사용)
const PERSON_ICON_SCALE = 1.0;
const PERSON_ICON_ANCHOR = [0.5, 1]; // 핀형일 때 바닥이 기준
const PERSON_ICON_SVG = `
<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>
  <defs>
    <linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
      <stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/>
    </linearGradient>
  </defs>
  <path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>
  <circle cx='19' cy='12' r='5' fill='#fff'/>
  <path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>
</svg>`;
function PERSON_ICON_SRC(){
  return PERSON_ICON_URL || ('data:image/svg+xml;utf8,' + encodeURIComponent(PERSON_ICON_SVG.trim()));
}

/* --------------------------
   1) 지도/레이어/팝업 (EPSG:3857)
--------------------------- */
let vmap;
let vectorSrc;      // 주차장 원본 포인트
let clusterSrc;     // 클러스터
let clusterLayer;   // 클러스터 레이어
let overlay;        // 주차장 정보 팝업
let meLayer;        // ★ 내 위치 레이어

function initMap(){
  if(!(window.vw && vw.ol3 && window.ol)){
    showToast('VWorld 라이브러리 로드 실패(apiKey/domain 확인)');
    return;
  }
  vw.ol3.MapOptions = {
    basemapType: vw.ol3.BasemapType.GRAPHIC,
    controlDensity: vw.ol3.DensityType.EMPTY,
    interactionDensity: vw.ol3.DensityType.BASIC,
    controlsAutoArrange: true,
    homePosition: vw.ol3.CameraPosition,
    initPosition: vw.ol3.CameraPosition
  };
  vmap = new vw.ol3.Map("map", vw.ol3.MapOptions);

  // 초기: 김천 중심(곧바로 내 위치를 시도하며 성공 시 덮어씀)
  const center3857 = ol.proj.transform([GIMCHEON_CENTER.lng, GIMCHEON_CENTER.lat], 'EPSG:4326', 'EPSG:3857');
  vmap.getView().setCenter(center3857);
  vmap.getView().setZoom(13);

  vectorSrc   = new ol.source.Vector({ features: [] });
  clusterSrc  = new ol.source.Cluster({ distance: 40, minDistance: 10, source: vectorSrc });
  clusterLayer= new ol.layer.Vector({ source: clusterSrc, style: clusterStyle });
  meLayer     = new ol.layer.Vector({ source: new ol.source.Vector() }); // ★ 내 위치 전용

  try { vmap.addLayer(clusterLayer); } catch(e){ (vmap.getMap? vmap.getMap():vmap.map).addLayer(clusterLayer); }
  try { vmap.addLayer(meLayer); }     catch(e){ (vmap.getMap? vmap.getMap():vmap.map).addLayer(meLayer); }

  // 팝업
  const el = document.createElement('div');
  el.className = 'ol-popup';
  overlay = new ol.Overlay({ element: el, positioning: 'bottom-center', stopEvent: false, offset: [0, -12] });
  (vmap.addOverlay ? vmap.addOverlay(overlay) : (vmap.getMap ? vmap.getMap() : vmap.map).addOverlay(overlay));

  // 클릭: 클러스터는 확대, 단일은 팝업
  vmap.on('click', function(evt){
    let handled = false;
    vmap.forEachFeatureAtPixel(evt.pixel, function(feature, layer){
      if(layer !== clusterLayer) return;
      const members = feature.get('features') || [];
      if(members.length > 1){
        const extent = ol.extent.createEmpty();
        members.forEach(f => ol.extent.extend(extent, f.getGeometry().getExtent()));
        vmap.getView().fit(extent, { duration: 300, maxZoom: 17, padding: [80,20,80,20] });
      }else if(members.length === 1){
        const f = members[0];
        const p = f.getProperties();
        overlay.setPosition(evt.coordinate);
        overlay.getElement().innerHTML =
          `<div class="tit">${p.nm || '주차장'}</div>
           <div class="sub">${p.addr || ''}</div>
           <div class="sub">형태: ${p.type || '주차장'} · 좌표: ${Number(p.lat).toFixed(5)}, ${Number(p.lng).toFixed(5)}</div>`;
        selEl.textContent = p.nm || '주차장';
        showToast(`선택: ${p.nm || '주차장'}`);
      }
      handled = true;
      return true;
    });
    if(!handled){ overlay.setPosition(undefined); }
  });
}

function clusterStyle(feature){
  const size = (feature.get('features')||[]).length;
  if(size > 1){
    return new ol.style.Style({
      image: new ol.style.Circle({
        radius: Math.max(12, Math.min(28, 10 + Math.log(size)*8)),
        fill: new ol.style.Fill({ color: [37,99,235,0.85] }),
        stroke: new ol.style.Stroke({ color: '#ffffff', width: 2 })
      }),
      text: new ol.style.Text({
        text: String(size),
        fill: new ol.style.Fill({ color: '#ffffff' }),
        stroke: new ol.style.Stroke({ color: '#000000', width: 3 })
      })
    });
  }
  // 단일 포인트: 주차장 아이콘
  return new ol.style.Style({
    image: new ol.style.Icon({
      src: PARK_ICON_SRC(),
      scale: PARK_ICON_SCALE,
      anchor: PARK_ICON_ANCHOR,
      anchorXUnits: 'fraction',
      anchorYUnits: 'fraction'
    })
  });
}

/* --------------------------
   2) VWorld 검색 API (place)
--------------------------- */
async function vworldPlaceSearch(query, page=1, size=100){
  const url = `https://api.vworld.kr/req/search?service=search&request=search&version=2.0`
            + `&format=json&errorformat=json&crs=EPSG:4326&type=place`
            + `&size=${size}&page=${page}&key=${encodeURIComponent(VWORLD_KEY)}`
            + `&domain=${encodeURIComponent(VWORLD_DOMAIN)}`
            + `&query=${encodeURIComponent(query)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('VWorld 요청 실패');
  const json = await res.json();
  if(json.response && json.response.status === 'OK') return json.response.result.items || [];
  return [];
}

let RAW = []; // {id,nm,lng,lat,addr,type}

/* 5km 반경 + 타입추론 */
async function loadGimcheonParking(){
  try{
    let items = [];
    items = items.concat(await vworldPlaceSearch('김천시 주차장',1,100));
    items = items.concat(await vworldPlaceSearch('김천 주차',1,100));

    const center=GIMCHEON_CENTER, filtered=[], seen=new Set();
    for(const it of items){
      const lng = Number(it.point?.x), lat = Number(it.point?.y);
      if(!isFinite(lng)||!isFinite(lat)) continue;
      const d = km({lng:center.lng,lat:center.lat},{lng,lat})*1000;
      if(d > GIMCHEON_RADIUS_M) continue;
      const title = String(it.title||'');
      const road  = it.address?.road || it.address?.parcel || '';
      const cat   = it.category || '';
      if(!(/김천/.test(road)||/김천/.test(title))) continue;
      if(!(/주차/.test(road)||/주차/.test(title))) continue;
      const t = inferType(title, cat, road);
      const key = `${title}@${lng.toFixed(6)},${lat.toFixed(6)}`;
      if(seen.has(key)) continue; seen.add(key);
      filtered.push({ id:key, nm:title, lng, lat, addr:road, type: t });
    }
    RAW = filtered;
  }catch(e){
    console.warn('검색 실패, 데모 사용', e);
    RAW = [
      {id:'TS-DEMO', nm:'TS 본사 제1주차장(데모)', lng:128.1765, lat:36.1219, addr:'김천시 혁신6로 17', type:'부설'},
      {id:'KTX-DEMO', nm:'김천(구미)역 공영주차장(데모)', lng:128.1842, lat:36.1127, addr:'김천시 남면 혁신1로 51', type:'노외'},
      {id:'CITY-DEMO', nm:'김천시청 공영주차장(데모)', lng:128.1170, lat:36.1305, addr:'김천시 시청1길 1', type:'노외'}
    ];
  }
  rebuildFeatures(RAW);
}

/* --------------------------
   3) 피처/클러스터 재구성
--------------------------- */
function rebuildFeatures(rows){
  if(!vectorSrc) return;
  const feats = rows.map(r=>{
    const coord = ol.proj.transform([r.lng, r.lat], 'EPSG:4326', 'EPSG:3857');
    const f = new ol.Feature({ geometry: new ol.geom.Point(coord) });
    f.setProperties({ nm:r.nm, addr:r.addr, type:r.type, lng:r.lng, lat:r.lat });
    return f;
  });
  vectorSrc.clear();
  vectorSrc.addFeatures(feats);

  // 내 위치를 이미 잡았다면 중심을 유지 / 아니면 전체 보기
  if(!USER_CENTER_LOCK){
    fitAll();
  }
  countEl.textContent = rows.length;
}
function fitAll(){
  const extent = ol.extent.createEmpty(); let any=false;
  vectorSrc.getFeatures().forEach(f=>{ ol.extent.extend(extent, f.getGeometry().getExtent()); any=true; });
  if(any) vmap.getView().fit(extent, {duration:500, padding:[80,20,220,20], maxZoom:16});
}

/* --------------------------
   4) 현재 위치(사람 아이콘) 표시 + 중심 이동
--------------------------- */
function setUserMarker(lng, lat){
  const coord3857 = ol.proj.transform([lng, lat], 'EPSG:4326', 'EPSG:3857');
  const f = new ol.Feature({ geometry:new ol.geom.Point(coord3857) });
  f.setStyle(new ol.style.Style({
    image:new ol.style.Icon({
      src: PERSON_ICON_SRC(),
      scale: PERSON_ICON_SCALE,
      anchor: PERSON_ICON_ANCHOR,
      anchorXUnits: 'fraction',
      anchorYUnits: 'fraction'
    })
  }));
  meLayer.getSource().clear();
  meLayer.getSource().addFeature(f);
  // ★ 중심을 “현재 위치”로 이동하고 잠금
  vmap.getView().setCenter(coord3857);
  vmap.getView().setZoom(16);
  USER_CENTER_LOCK = true;
}

function getMyLocation(){
  const secureOK = (location.protocol==='https:') || ['localhost','127.0.0.1','::1'].includes(location.hostname);
  if(!secureOK){
    showToast('현재 위치는 HTTPS 또는 localhost에서만 사용 가능합니다.');
    return;
  }
  if(!navigator.geolocation){ showToast('이 기기에서 위치를 지원하지 않습니다.'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    setUserMarker(pos.coords.longitude, pos.coords.latitude);
  }, _=>{
    showToast('위치 접근 거부/실패');
  }, { enableHighAccuracy:true, timeout:8000, maximumAge:10000 });
}

/* --------------------------
   5) UI
--------------------------- */
const q = $('#q'), typeSel = $('#type'), distSel = $('#distance');

function applyFilter(){
  const kw = q.value.trim();
  const t  = typeSel.value;
  let rows = RAW.filter(r => (!kw || r.nm.includes(kw)) && (!t || r.type===t));
  // 노상/노외 선택 시 0건이면 판별불가 항목(주차장/빈 타입)도 보정 포함
  if(rows.length === 0 && (t==='노상' || t==='노외')){
    rows = RAW.filter(r => (!kw || r.nm.includes(kw)) && (r.type===t || r.type==='주차장' || !r.type));
  }
  rebuildFeatures(rows);
  overlay && overlay.setPosition(undefined);
}
function changeClusterDistance(){ clusterSrc.setDistance(Number(distSel.value||40)); }

function initUI(){
  $('#fitBtn').addEventListener('click', ()=>{ USER_CENTER_LOCK=false; fitAll(); });
  $('#locBtn').addEventListener('click', getMyLocation);
  $('#resetBtn').addEventListener('click', ()=>{
    q.value=''; typeSel.value=''; distSel.value='40'; changeClusterDistance();
    USER_CENTER_LOCK=false; rebuildFeatures(RAW); overlay.setPosition(undefined); selEl.textContent='-';
  });
  q.addEventListener('input', debounce(applyFilter, 150));
  typeSel.addEventListener('change', applyFilter);
  distSel.addEventListener('change', changeClusterDistance);
}
function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

/* --------------------------
   6) 시작: 지도 → UI → ★현재 위치 먼저 시도 → 데이터 로드
--------------------------- */
(async function start(){
  initMap();
  initUI();
  // ★ 페이지 로드 시 바로 “현재 위치” 요청해 중심/사람아이콘 표시
  getMyLocation();
  await loadGimcheonParking();
})();
</script>
</body>
</html>