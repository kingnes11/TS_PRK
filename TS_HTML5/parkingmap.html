<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>행정구역(JSONP) + 현재위치 + 더미10 + 클릭팝업 · 반응형 패널/에러도크 · OL 10.6.1</title>

<!-- OpenLayers (CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --vh: 1vh; /* 모바일 주소창 변동 보정 */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed; inset:0}

  /* 좌측 패널(반응형) */
  .side{
    position:fixed; z-index:30;
    left:calc(12px + var(--safe-left));
    top:calc(12px + var(--safe-top));
    bottom:calc(12px + var(--safe-bottom));
    width:clamp(300px, 30vw, 460px);
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent}
  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:120px; background:#0c1530}
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}

  /* 팝업(Overlay) */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px; max-width:min(72vw, 360px);
    padding:10px 12px; transform:translate(-50%,-110%); box-shadow:0 10px 20px rgba(0,0,0,.25); pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  /* 오류 로그 도크 + FAB */
  .errdock{
    position:fixed; z-index:1000;
    right:calc(12px + var(--safe-right));
    bottom:calc(68px + var(--safe-bottom));
    width:clamp(300px, 46vw, 560px);
    max-height:calc(min(38vh, 38 * var(--vh)));
    background:#0f172a; border:1px solid var(--border); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:none; flex-direction:column;
  }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{
    overflow:auto; padding:8px 10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem;
    background:#0b1220
  }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px }
  .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }
  .errfab{
    position:fixed; z-index:1001;
    right:calc(12px + var(--safe-right));
    bottom:calc(12px + var(--safe-bottom));
    background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.35)
  }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}

  /* 모바일 최적화 */
  @media (max-width:360px){
    .side{ left:calc(8px + var(--safe-left)); right:calc(8px + var(--safe-right)); width:auto; top:calc(8px + var(--safe-top)); bottom:auto; max-height:58vh; overflow:auto }
    .list{ max-height:36vh }
    .errdock{ left:calc(8px + var(--safe-left)); right:calc(8px + var(--safe-right)); width:auto }
  }
  @media (min-width:361px) and (max-width:480px){
    .side{ left:calc(10px + var(--safe-left)); right:calc(10px + var(--safe-right)); width:auto; top:calc(10px + var(--safe-top)); bottom:auto; max-height:62vh; overflow:auto }
    .list{ max-height:40vh }
    .errdock{ left:calc(10px + var(--safe-left)); right:calc(10px + var(--safe-right)); width:auto }
  }
  @media (min-width:481px) and (max-width:768px){
    .side{ width:clamp(320px, 48vw, 400px) }
    .list{ min-height:160px }
    .errdock{ width:clamp(300px, 60vw, 540px) }
  }
  @media (min-width:769px) and (max-width:1024px){
    .side{ width:clamp(360px, 34vw, 440px) }
    .errdock{ width:clamp(320px, 48vw, 560px) }
  }
  @media (orientation:landscape) and (max-height:480px){
    .side{ max-height:52vh }
    .list{ max-height:32vh }
    .errdock{ max-height:34vh }
  }
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널 -->
<aside class="side" id="side">
  <div class="row title">
    <div>주차장(더미 10)</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
  </div>
  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn ghost" id="fitBtn">전체 보기</button>
    <span id="stat" class="muted" style="margin-left:auto">초기화 중…</span>
  </div>
  <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
</aside>

<!-- 오류 로그 도크 + FAB (에러만, URL 포함) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div class="grow"></div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm red" id="clearErr">지우기</button>
    <button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
/* ===== 공통 상수/유틸 ===== */
const VW_KEY   = 'CF9A371B-35A6-3822-8315-6592C8342E82';
const DOMAIN   = 'kingnes11.github.io';
const SRS      = 'EPSG:900913';
const WMS_API  = 'https://api.vworld.kr/req/wms';
const WFS_API  = 'https://api.vworld.kr/req/wfs';
const RADIUS_KM= 5;
const $ = (s)=>document.querySelector(s);

function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
window.addEventListener('resize', setVH, {passive:true}); setVH();

/* ===== 에러 로그(에러만, URL 표시) ===== */
const ERRUI = (function(){
  const dock=$('#errdock'), body=$('#errbody'), count=$('#errcount'), fab=$('#errFab'), cntFab=$('#errCntFab');
  $('#closeErr').onclick=()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
  $('#clearErr').onclick=()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
  $('#copyErr').onclick=async()=>{ try{await navigator.clipboard.writeText(body.innerText||'(로그 없음)');}catch(e){} };
  fab.onclick=()=>{ const opened=dock.classList.toggle('open'); fab.setAttribute('aria-expanded', String(opened)); };
  return {dock,body,count,fab,cntFab};
})();
const lastErrTime = new Map();
function tstr(){ return new Date().toLocaleTimeString(); }
function logErr(msg, urlOrDetail){
  const key = msg + '::' + (urlOrDetail||'');
  const now = Date.now(), prev = lastErrTime.get(key)||0;
  if(now - prev < 1500) return;
  lastErrTime.set(key, now);
  const row = document.createElement('div');
  row.className='logrow';
  row.innerHTML = `<span class="time">[${tstr()}]</span><span class="lvl lvl-ERR">ERR</span> ${msg}`
                + (urlOrDetail? `<div class="muted" style="margin-left:8px;word-break:break-all">${urlOrDetail}</div>`:'');
  ERRUI.body.appendChild(row); ERRUI.body.scrollTop = ERRUI.body.scrollHeight;
  const total = ERRUI.body.querySelectorAll('.logrow').length;
  ERRUI.count.textContent = `${total}건`;
  const cur = (Number(ERRUI.cntFab.textContent)||0)+1; ERRUI.cntFab.textContent = String(cur);
  ERRUI.fab.classList.add('error');
}
window.addEventListener('error', e=> logErr('window.onerror: '+e.message));
window.addEventListener('unhandledrejection', e=> logErr('unhandledrejection', (e && e.reason && (e.reason.stack||e.reason.message)) || String(e)));

/* ===== 지도 ===== */
const base = new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0 });
const view = new ol.View({ center: ol.proj.fromLonLat([127.5,36.4]), zoom: 7, minZoom:4, maxZoom:18 });
const map = new ol.Map({ target:'map', layers:[base], view });

/* ===== WMS (타일 오류시 URL 표시) ===== */
const wms = new ol.source.TileWMS({
  url: WMS_API,
  params:{
    SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
    LAYERS:'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
    STYLES:'lp_pa_cbnd_bonbun_line,lp_pa_cbnd_bubun_line',
    CRS:SRS, FORMAT:'image/png', TRANSPARENT:false, BGCOLOR:'0xFFFFFF',
    KEY:VW_KEY, DOMAIN:DOMAIN
  },
  crossOrigin:'anonymous'
});
const wmsLayer = new ol.layer.Tile({ source:wms, zIndex:50, opacity:.9, visible:true });
map.addLayer(wmsLayer);
wms.on('tileloaderror', (evt)=>{
  const img = evt && evt.tile && evt.tile.getImage && evt.tile.getImage();
  const src = img && img.src ? img.src : '(이미지 src 미확인)';
  logErr('WMS 타일 오류', src);
});

/* ===== 행정구역 WFS(JSONP) 4종 ===== */
const adminLayers = [
  {tn:'lt_c_adsido_info', title:'시도'},
  {tn:'lt_c_adsigg_info', title:'시군구'},
  {tn:'lt_c_ademd_info',  title:'읍면동'},
  {tn:'lt_c_adri_info',   title:'리'}
];
function buildWFSUrlJSONP(typename, bbox, cbName){
  const p = new URLSearchParams({
    SERVICE:'WFS', REQUEST:'GetFeature', VERSION:'1.1.0',
    TYPENAME: typename,
    SRSNAME: SRS,
    BBOX: bbox.join(','),        // xmin,ymin,xmax,ymax (900913)
    MAXFEATURES:'1000',
    OUTPUT:'text/javascript',    // JSONP
    EXCEPTIONS:'text/xml',
    FORMAT_OPTIONS:`callback:${cbName}`,
    KEY: VW_KEY, DOMAIN: DOMAIN
  });
  return `${WFS_API}?${p.toString()}`;
}
function jsonp(url, cbName, onload, onerror){
  const s=document.createElement('script'); let done=false;
  const clear=()=>{ if(done) return; done=true; s.remove(); try{ delete window[cbName]; }catch(_){} };
  const timeout = setTimeout(()=>{ clear(); onerror && onerror(new Error('jsonp_timeout'), url); }, 12000);
  window[cbName]=function(payload){ clear(); clearTimeout(timeout); onload && onload(payload, url); };
  s.src=url; s.onerror=()=>{ clear(); clearTimeout(timeout); onerror && onerror(new Error('JSONP script_error'), url); };
  document.head.appendChild(s);
}
function styleFor(tn){
  const color = ({
    lt_c_adsido_info:[37,99,235,1],
    lt_c_adsigg_info:[34,197,94,1],
    lt_c_ademd_info:[244,114,182,1],
    lt_c_adri_info :[234,179,8,1]
  })[tn] || [148,163,184,1];
  return new ol.style.Style({
    stroke:new ol.style.Stroke({ color, width: tn==='lt_c_adsido_info'? 2.2 : tn==='lt_c_adsigg_info'? 1.8 : 1.4 }),
    fill:new ol.style.Fill({ color:[color[0], color[1], color[2], 0.04] })
  });
}
const adminVectorLayers = {};
for(const {tn} of adminLayers){
  const src = new ol.source.Vector({wrapX:true});
  adminVectorLayers[tn] = new ol.layer.Vector({ source:src, style:styleFor(tn), zIndex: 80 });
  map.addLayer(adminVectorLayers[tn]);
}
let wfsReqId = 0;
function loadAdminJSONP(extent3857){
  const ex = extent3857.slice(0);
  for(const {tn} of adminLayers){
    const cb = `vw_cb_${tn}_${wfsReqId++}_${Math.floor(Math.random()*1000)}`;
    const url = buildWFSUrlJSONP(tn, ex, cb);
    jsonp(url, cb, (payload)=>{
      try{
        if(!payload || !payload.features){ throw new Error('invalid_jsonp_payload'); }
        const fmt = new ol.format.GeoJSON();
        const feats = fmt.readFeatures(payload, {dataProjection:SRS, featureProjection:'EPSG:3857'});
        const src = adminVectorLayers[tn].getSource();
        src.clear(true); src.addFeatures(feats);
      }catch(e){
        logErr(`WFS 파싱 실패(${tn})`, url);
      }
    }, (err, badUrl)=>{
      logErr(`WFS 로드 실패(${tn})`, badUrl);
    });
  }
}
let lastLoad = 0;
map.on('moveend', ()=>{
  const now=Date.now(); if(now-lastLoad<500) return; lastLoad=now;
  loadAdminJSONP(map.getView().calculateExtent(map.getSize()));
});

/* ===== 현재 위치 + 더미 10 + 팝업 ===== */
const meSrc = new ol.source.Vector();
const meLayer = new ol.layer.Vector({ source:meSrc, zIndex:120 });
map.addLayer(meLayer);

const dummySrc = new ol.source.Vector();
const dummyLy  = new ol.layer.Vector({ source:dummySrc, zIndex:110 });
map.addLayer(dummyLy);

/* 아이콘 스타일 */
const PARK_SVG = `<svg xmlns='http://www.w3.org/2000/svg' width='34' height='34' viewBox='0 0 36 36'><circle cx='18' cy='18' r='16' fill='#2563eb'/><text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text></svg>`;
const ME_SVG   = `<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs><path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/><circle cx='19' cy='12' r='5' fill='#fff'/><path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/></svg>`;
const stylePark = new ol.style.Style({ image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(PARK_SVG), anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction' }) });
const styleMe   = new ol.style.Style({ image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(ME_SVG), anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction' }) });
dummyLy.setStyle(stylePark);
meLayer.setStyle(styleMe);

/* 팝업(Overlay) 구성 */
const popupEl = document.createElement('div');
popupEl.className='ol-popup';
popupEl.innerHTML = `<button class="x" aria-label="닫기">×</button><div class="tit"></div><div class="sub2 addr"></div><div class="sub2 meta"></div>`;
const overlay = new ol.Overlay({ element: popupEl, positioning:'bottom-center', stopEvent:true, offset:[0,-14] });
map.addOverlay(overlay);
popupEl.querySelector('.x').addEventListener('click', ()=> overlay.setPosition(undefined));
document.addEventListener('keydown', e=>{ if(e.key==='Escape') overlay.setPosition(undefined); });

function openPopupFor(r, coord){
  popupEl.querySelector('.tit').textContent  = r.nm || '주차장';
  popupEl.querySelector('.addr').textContent = r.addr || '';
  popupEl.querySelector('.meta').textContent = `좌표: ${Number(r.lat).toFixed(5)}, ${Number(r.lng).toFixed(5)}`;
  overlay.setPosition(coord);
  $('#sel').textContent = r.nm || '-';
}
function highlightList(id){
  $('#list').querySelectorAll('.item').forEach(el=> el.classList.toggle('active', el.dataset.id===id));
}

/* 더미 10 생성/목록 */
let DUMMY_ROWS = [];
const id2feat = new Map();

function genDummy10(lng,lat){
  const out=[]; const r=RADIUS_KM;
  for(let i=0;i<10;i++){
    const ang=Math.random()*Math.PI*2;
    const dKm=Math.random()*r;
    const dLat=(dKm/111)*Math.sin(ang);
    const dLng=(dKm/(111*Math.cos(lat*Math.PI/180)))*Math.cos(ang);
    out.push({ id:'DM-'+i, nm:`더미 주차장 ${i+1}`, addr:`반경 ${dKm.toFixed(2)}km`, lng:lng+dLng, lat:lat+dLat });
  }
  return out;
}
function buildList(rows){
  const listEl=$('#list'), countEl=$('#count');
  countEl.textContent = String(rows.length);
  listEl.innerHTML = rows.map((r,i)=>`
    <div class="item" data-id="${r.id}" role="option" tabindex="0">
      <div class="nm">${i+1}. ${r.nm}</div>
      <div class="sub">${r.addr||''} · 좌표: ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
    </div>`).join('');
  listEl.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', ()=> focusItem(el.dataset.id));
    el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ focusItem(el.dataset.id); e.preventDefault(); }});
  });
}
function focusItem(id){
  const r = DUMMY_ROWS.find(x=>x.id===id); if(!r) return;
  const f = id2feat.get(id);
  const coord = f ? f.getGeometry().getCoordinates() : ol.proj.fromLonLat([r.lng,r.lat]);
  view.animate({center:coord, zoom:16, duration:250});
  openPopupFor(r, coord);
  highlightList(id);
}

/* 현재 위치 + 더미(10) 반영 */
function setMeAndDummy(lng, lat){
  // 위치 마커
  meSrc.clear();
  const c = ol.proj.fromLonLat([lng,lat]);
  meSrc.addFeature(new ol.Feature({ geometry:new ol.geom.Point(c) }));

  // 더미 10
  dummySrc.clear(); id2feat.clear();
  DUMMY_ROWS = genDummy10(lng,lat);
  DUMMY_ROWS.forEach(r=>{
    const f=new ol.Feature({ geometry:new ol.geom.Point(ol.proj.fromLonLat([r.lng,r.lat])), ...r });
    id2feat.set(r.id, f);
    dummySrc.addFeature(f);
  });
  buildList(DUMMY_ROWS);
  view.animate({center:c, zoom:15, duration:300});
  $('#stat').textContent = '현재 위치 반영';
}

/* 더미/리스트/팝업: 지도 클릭 처리 */
map.on('singleclick', (evt)=>{
  let handled=false;
  map.forEachFeatureAtPixel(evt.pixel,(feature, layer)=>{
    if(layer!==dummyLy) return;
    const p=feature.getProperties();
    const coord=feature.getGeometry().getCoordinates();
    openPopupFor(p, coord);
    highlightList(p.id);
    handled=true; return true;
  },{hitTolerance:6});
  if(!handled) overlay.setPosition(undefined);
});

/* 현재 위치 */
function autoLocate(){
  const isSecure = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
  if(!isSecure || !navigator.geolocation){
    $('#stat').textContent = '위치 권한/환경 문제(https 필요)';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    p=> setMeAndDummy(p.coords.longitude, p.coords.latitude),
    e=> logErr('geolocation 실패', `${e.code} ${e.message}`),
    { enableHighAccuracy:true, maximumAge:5000, timeout:9000 }
  );
}
$('#locBtn').onclick = autoLocate;
$('#fitBtn').onclick = ()=>{
  const ex=ol.extent.createEmpty();
  meSrc.getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
  dummySrc.getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
  if(!ol.extent.isEmpty(ex)) map.getView().fit(ex,{duration:350, padding:[30, Math.max(380, document.getElementById('side').offsetWidth+20), 30, 30], maxZoom:17});
};

/* 시작 */
autoLocate();                                                   // 현재 위치 시도
loadAdminJSONP(view.calculateExtent(map.getSize()));            // 초기 행정구역 로드
</script>
</body>
</html>