<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>브이월드 v1.0 · 리스트 + 필터 + 더미1000</title>

<!-- ★ VWorld MapInit v1.0 (도메인/키는 콘솔 등록값과 동일해야 함) -->
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=1.0&apiKey=CF9A371B-35A6-3822-8315-6592C8342E82&domain=kingnes11.github.io"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb; --accent2:#1d4ed8;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  /* 좌측 패널 */
  .side{
    position:fixed; left:12px; top:12px; bottom:12px; width:360px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media (max-width:960px){ .side{ right:12px; width:auto } }

  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent2)); border-color:transparent; color:#fff}
  .btn.ghost{background:transparent}
  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#c7d2fe; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem}
  .chip.active{background:var(--chipOn); color:#fff; border-color:transparent}

  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530}
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}
  .dist{color:#9ca3af}

  /* 팝업 */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널 -->
<aside class="side">
  <div class="row title">
    <div>주차장(반경 <b id="radiusLabel">5</b>km)</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
  </div>

  <div class="row">
    <button class="btn primary" id="baseBtn">기본지도</button>
    <button class="btn" id="satBtn">항공+문자</button>
    <span id="stat" class="muted" style="margin-left:auto">지도 준비 중…</span>
  </div>

  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn ghost" id="fitBtn">전체 보기</button>
  </div>

  <div class="chipbar" id="typeBar" role="group" aria-label="주차장 형태 필터">
    <div class="chip active" data-type="">전체</div>
    <div class="chip" data-type="노상">노상</div>
    <div class="chip" data-type="노외">노외</div>
    <div class="chip" data-type="부설">부설</div>
  </div>

  <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
</aside>

<script>
(function(){
  /* ===== 설정 ===== */
  var INIT   = { lng:128.1136, lat:36.1398 };   // 김천(한국교통안전공단)
  var DEMO_N = 1000;                            // 더미 개수
  var RADIUS_KM = 5.0;                          // 반경
  document.getElementById('radiusLabel').textContent = RADIUS_KM;

  var $ = function(s){ return document.querySelector(s); };
  var stat = $('#stat');
  var ok   = function(m){ stat.innerHTML = '<span style="color:#10b981">✔</span> '+m; };
  var warn = function(m){ stat.innerHTML = '<span style="color:#f59e0b">!</span> '+m; };
  var bad  = function(m){ stat.innerHTML = '<span style="color:#ef4444">✖</span> '+m; };

  /* ===== vw.ol3 준비 대기 ===== */
  function ready(cb){
    var t0 = Date.now();
    (function tick(){
      if (window.vw && vw.ol3 && vw.ol3.Map && window.ol) return cb();
      if (Date.now() - t0 > 8000){ bad('브이월드 엔진 준비 실패'); return; }
      setTimeout(tick, 100);
    })();
  }

  ready(function(){
    /* ===== 브이월드 맵 생성 ===== */
    var vmap = new vw.ol3.Map("map", {
      basemapType: vw.ol3.BasemapType.GRAPHIC,   // 기본 배경
      controlDensity: vw.ol3.DensityType.BASIC,
      interactionDensity: vw.ol3.DensityType.BASIC,
      controlsAutoArrange: true
    });

    // OpenLayers 핸들
    var map = vmap.getMap ? vmap.getMap() : (vmap.map || vmap);

    // 초기 뷰(김천)
    var center3857 = ol.proj.fromLonLat([INIT.lng, INIT.lat]);
    map.getView().setCenter(center3857);
    map.getView().setZoom(14);

    // 베이스/항공 토글
    $('#baseBtn').addEventListener('click', function(){
      vmap.setBasemapType(vw.ol3.BasemapType.GRAPHIC);
      $('#baseBtn').classList.add('primary'); $('#satBtn').classList.remove('primary');
    });
    $('#satBtn').addEventListener('click', function(){
      vmap.setBasemapType(vw.ol3.BasemapType.HYBRID); // 위성+문자
      $('#satBtn').classList.add('primary'); $('#baseBtn').classList.remove('primary');
    });

    /* ===== 아이콘/스타일 ===== */
    var PARK_SVG =
      "<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>"
      +"<circle cx='18' cy='18' r='16' fill='#2563eb'/>"
      +"<text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>"
      +"</svg>";
    var ME_SVG =
      "<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>"
      +"<defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>"
      +"<path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>"
      +"<circle cx='19' cy='12' r='5' fill='#fff'/>"
      +"<path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>"
      +"</svg>";

    var stylePark = new ol.style.Style({
      image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(PARK_SVG), anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1 })
    });
    var styleMe = new ol.style.Style({
      image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(ME_SVG), anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1 })
    });
    var styleCircle = new ol.style.Style({
      stroke:new ol.style.Stroke({ color:[239,68,68,0.9], width:2 }),
      fill:  new ol.style.Fill({ color:[239,68,68,0.08] })
    });

    /* ===== 소스/레이어 ===== */
    var meSrc   = new ol.source.Vector();                         // 현재 위치 + 반경 원
    var meLayer = new ol.layer.Vector({ source: meSrc, zIndex: 120 });
    map.addLayer(meLayer);

    var rawSrc  = new ol.source.Vector();                         // 원시 더미
    var clusterSrc = new ol.source.Cluster({ distance: 40, minDistance: 10, source: rawSrc });
    var clusterLy  = new ol.layer.Vector({
      source: clusterSrc,
      style: function(feature){
        var members = feature.get('features')||[];
        var size = members.length;
        if(size>1){
          return new ol.style.Style({
            image:new ol.style.Circle({
              radius: Math.max(12, Math.min(28, 10 + Math.log(size)*8)),
              fill: new ol.style.Fill({color:[37,99,235,0.92]}),
              stroke:new ol.style.Stroke({color:'#fff',width:2})
            }),
            text:new ol.style.Text({
              text:String(size),
              fill:new ol.style.Fill({color:'#fff'}),
              stroke:new ol.style.Stroke({color:'#000',width:3})
            })
          });
        }
        var m = members[0];
        return (m && m.getStyle && m.getStyle()) || stylePark;
      },
      zIndex: 110
    });
    map.addLayer(clusterLy);

    /* ===== 팝업 ===== */
    var popupEl = document.createElement('div');
    popupEl.className='ol-popup';
    popupEl.innerHTML = '<button class="x" aria-label="닫기">×</button><div class="tit"></div><div class="sub2 addr"></div><div class="sub2 meta"></div>';
    var overlay = new ol.Overlay({ element: popupEl, positioning:'bottom-center', stopEvent:true, offset:[0,-14] });
    map.addOverlay(overlay);
    var closePopup = function(){ overlay.setPosition(undefined); };
    popupEl.querySelector('.x').addEventListener('click', closePopup);
    document.addEventListener('keydown', function(e){ if(e.key==='Escape') closePopup(); });

    function openPopupForFeature(f, coord){
      var p=f.getProperties();
      popupEl.querySelector('.tit').textContent  = p.nm || '주차장';
      popupEl.querySelector('.addr').textContent = p.addr || '';
      popupEl.querySelector('.meta').textContent = '형태: '+(p.type||'-')+' · 좌표: '+Number(p.lat).toFixed(5)+', '+Number(p.lng).toFixed(5);
      overlay.setPosition(coord);
      $('#sel').textContent = p.nm || '-';
    }

    map.on('singleclick', function(evt){
      var handled=false;
      map.forEachFeatureAtPixel(evt.pixel, function(feature, layer){
        if(layer!==clusterLy) return;
        var members = feature.get('features')||[];
        if(members.length>1){
          var ex=ol.extent.createEmpty(); members.forEach(function(f){ ol.extent.extend(ex, f.getGeometry().getExtent()); });
          map.getView().fit(ex,{duration:250,maxZoom:17,padding:[30,380,30,30]});
        }else if(members.length===1){
          var f=members[0], coord=f.getGeometry().getCoordinates();
          openPopupForFeature(f, coord);
          highlightList(f.get('__id'));
        }
        handled=true; return true;
      },{hitTolerance:6});
      if(!handled) closePopup();
    });

    /* ===== 거리/더미/리스트 ===== */
    function haversineKm(a,b){
      var R=6371, toRad=function(d){return d*Math.PI/180;};
      var dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      var s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      var t=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(t));
    }
    function generateDummyAround(lng, lat, n, rKm){
      var types=['노상','노외','부설'];
      var rows=[], i;
      for(i=0;i<n;i++){
        var rkm=Math.random()*rKm, ang=Math.random()*Math.PI*2;
        var dLat=(rkm/111)*Math.sin(ang);
        var dLng=(rkm/(111*Math.cos(lat*Math.PI/180)))*Math.cos(ang);
        var y=lat+dLat, x=lng+dLng;
        var type = types[i%3];
        rows.push({ id:'DM-'+i, nm:'더미 '+type+' 주차장 '+(i+1), addr:'반경 '+rkm.toFixed(2)+'km', type:type, lng:x, lat:y });
      }
      return rows.map(function(r){ return Object.assign({}, r, { distKm: haversineKm({lng:lng,lat:lat},{lng:r.lng,lat:r.lat}) }); });
    }

    function rebuildFeatures(rows){
      rawSrc.clear();
      var feats = rows.map(function(r){
        var coord=ol.proj.fromLonLat([r.lng,r.lat]);
        var f=new ol.Feature({ geometry:new ol.geom.Point(coord), __id:r.id, nm:r.nm, addr:r.addr, type:r.type, lng:r.lng, lat:r.lat });
        f.setStyle(stylePark);
        return f;
      });
      rawSrc.addFeatures(feats);
    }

    /* ===== 좌측 목록 ===== */
    var ROWS_ALL=[], ROWS_VIEW=[], currentType="";
    function buildList(rows){
      var listEl=$('#list'), countEl=$('#count');
      countEl.textContent = String(rows.length);
      if(rows.length===0){
        listEl.innerHTML = '<div class="item"><div class="nm">결과 없음</div><div class="sub">반경 '+RADIUS_KM+'km / 형태: '+(currentType||'전체')+'</div></div>';
        return;
      }
      var html = rows.map(function(r,i){
        return '<div class="item" data-id="'+r.id+'" role="option" tabindex="0">'
             +   '<div class="nm">'+(i+1)+'. '+r.nm+'</div>'
             +   '<div class="sub"><span class="badge">'+r.type+'</span><span class="dist">'+r.distKm.toFixed(2)+' km</span><span>'+r.addr+'</span></div>'
             + '</div>';
      }).join('');
      listEl.innerHTML = html;
      Array.prototype.forEach.call(listEl.querySelectorAll('.item'), function(el){
        el.addEventListener('click', function(){ focusItem(el.dataset.id); });
        el.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' '){ focusItem(el.dataset.id); e.preventDefault(); }});
      });
    }
    function highlightList(id){
      Array.prototype.forEach.call($('#list').querySelectorAll('.item'), function(el){
        el.classList.toggle('active', el.dataset.id===id);
      });
    }
    function focusItem(id){
      var r = ROWS_VIEW.find(function(x){return x.id===id;}) || ROWS_ALL.find(function(x){return x.id===id;});
      if(!r) return;
      var coord=ol.proj.fromLonLat([r.lng,r.lat]);
      map.getView().setCenter(coord); map.getView().setZoom(16);
      openPopupForFeature(new ol.Feature({geometry:new ol.geom.Point(coord), nm:r.nm, addr:r.addr, type:r.type, lng:r.lng, lat:r.lat}), coord);
      highlightList(id);
    }
    function applyFilter(){
      ROWS_VIEW = ROWS_ALL.filter(function(r){return !currentType || r.type===currentType;})
                           .sort(function(a,b){return a.distKm-b.distKm;});
      buildList(ROWS_VIEW);
      rebuildFeatures(ROWS_VIEW);
    }

    $('#typeBar').addEventListener('click', function(e){
      var chip=e.target.closest('.chip'); if(!chip) return;
      chip.parentElement.querySelectorAll('.chip').forEach(function(c){ c.classList.remove('active'); });
      chip.classList.add('active');
      currentType = chip.dataset.type || "";
      closePopup();
      applyFilter();
    });

    /* ===== 현재 위치/반경 원/시드 ===== */
    function setMeAndSeed(lng, lat, msg){
      // 현재 위치 + 반경
      meSrc.clear();
      var center = ol.proj.fromLonLat([lng,lat]);
      var me = new ol.Feature({ geometry:new ol.geom.Point(center) }); me.setStyle(styleMe); meSrc.addFeature(me);
      var circle = new ol.Feature({ geometry:new ol.geom.Circle(center, RADIUS_KM*1000) }); circle.setStyle(styleCircle); meSrc.addFeature(circle);

      // 더미/리스트
      ROWS_ALL = generateDummyAround(lng, lat, DEMO_N, RADIUS_KM);
      applyFilter();

      // 뷰
      map.getView().setCenter(center); map.getView().setZoom(15);
      ok(msg+' · 반경 '+RADIUS_KM+'km · 더미 '+DEMO_N+'개');
    }

    function fitAll(){
      var ex=ol.extent.createEmpty();
      meSrc.getFeatures().forEach(function(f){ ol.extent.extend(ex, f.getGeometry().getExtent()); });
      rawSrc.getFeatures().forEach(function(f){ ol.extent.extend(ex, f.getGeometry().getExtent()); });
      if(!ol.extent.isEmpty(ex)) map.getView().fit(ex,{duration:400, padding:[30,380,30,30], maxZoom:16});
    }

    $('#locBtn').addEventListener('click', function(){ autoLocateUpgrade(true); });
    $('#fitBtn').addEventListener('click', fitAll);

    // ★ 즉시 표시: 김천 기준으로 먼저 렌더링
    setMeAndSeed(INIT.lng, INIT.lat, '김천 기준 시작');
    // 이후 백그라운드에서 현재 위치로 업그레이드
    autoLocateUpgrade(false);

    function autoLocateUpgrade(fly){
      try{
        if(!('geolocation' in navigator)) { warn('지오로케이션 미지원 · 김천 유지'); return; }
        var done=false;
        var opts={ enableHighAccuracy:true, maximumAge:5000, timeout:9000 };
        var timer = setTimeout(function(){ if(!done){ warn('위치 응답 지연 · 김천 유지'); done=true; } }, 10000);

        var apply=function(lng,lat){
          if(done) return; done=true; clearTimeout(timer);
          setMeAndSeed(lng,lat,'현재 위치로 업데이트');
          if(fly){ map.getView().animate({center:ol.proj.fromLonLat([lng,lat]), zoom:15, duration:400}); }
        };

        var wid=navigator.geolocation.watchPosition(
          function(p){ apply(p.coords.longitude,p.coords.latitude); navigator.geolocation.clearWatch(wid); },
          function(){}, opts
        );
        navigator.geolocation.getCurrentPosition(
          function(p){ apply(p.coords.longitude,p.coords.latitude); navigator.geolocation.clearWatch(wid); },
          function(){ if(!done){ warn('위치 거부/실패 · 김천 유지'); done=true; clearTimeout(timer); } },
          opts
        );
      }catch(e){
        console.error(e);
        warn('위치 처리 오류 · 김천 유지');
      }
    }
  }); // ready

})();
</script>
</body>
</html>