<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>행정구역도(WFS GML2) · 시도/시군구/읍면동/리 · BBOX(현재화면) · 에러로그(URL표시)</title>

<!-- OpenLayers 10.6.1 동적 로더 -->
<script>
(function(){
  const cssList=['https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css','https://unpkg.com/ol@10.6.1/ol.css'];
  const jsList =['https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js','https://unpkg.com/ol@10.6.1/dist/ol.js'];
  function loadCSS(i=0){ if(i>=cssList.length) return; const l=document.createElement('link'); l.rel='stylesheet'; l.href=cssList[i]; l.onerror=()=>loadCSS(i+1); document.head.appendChild(l); }
  function loadJS(i=0){ if(i>=jsList.length) throw new Error('OpenLayers load failed'); const s=document.createElement('script'); s.src=jsList[i]; s.async=false; s.onload=()=>{ if(window.ol) return; s.remove(); loadJS(i+1); }; s.onerror=()=>{ s.remove(); loadJS(i+1); }; document.head.appendChild(s); }
  loadCSS(); loadJS();
})();
</script>

<style>
  :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#20304f; --accent:#2563eb }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}
  .side{position:fixed;left:12px;top:12px;bottom:12px;width:360px;z-index:30;background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;gap:10px;flex-direction:column}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .title{font-weight:800}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border);background:transparent;color:#c7d2fe;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .list{flex:1;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:#0c1530}
  .chip{display:inline-flex;gap:6px;align-items:center;margin-right:10px}
  .chip input{accent-color:#3b82f6}
  /* 에러 로그 도크 + FAB(에러만) */
  .errdock{position:fixed;right:12px;bottom:72px;z-index:1000;width:min(560px,calc(100% - 24px));background:#0f172a;border:1px solid var(--border);border-radius:12px;display:none;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .errdock.open{display:flex}
  .errdock .hdr{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid var(--border)}
  .errdock .body{max-height:38vh;overflow:auto;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.86rem;background:#0b1220}
  .logrow{border-bottom:1px dashed #1d2741;padding:4px 0}
  .time{color:#9ca3af;margin-right:6px}
  .lvl{font-weight:800;margin-right:6px;color:#fca5a5}
  .btnsm{border:1px solid var(--border);background:#0b1530;color:#c7d2fe;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
  .btnsm.red{background:#391d1d;border-color:#5c2a2a;color:#fecaca}
  .errfab{position:fixed;right:12px;bottom:12px;z-index:1001;background:#1e293b;color:#e5e7eb;border:1px solid #334155;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer;display:flex;gap:8px;align-items:center;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{display:none;background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem}
  .errfab.error .cnt{display:inline-block}
  @media (max-width:480px){ .side{left:8px;right:8px;top:8px;bottom:auto;width:auto;max-height:60vh;overflow:auto} .errdock{left:8px;right:8px;width:auto} }
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<aside class="side">
  <div class="row"><div class="title">행정구역도(WFS GML2) <span class="muted" id="stat">초기화 중…</span></div></div>
  <div class="row">
    <button class="btn" id="btnLoc">현재 위치</button>
    <button class="btn" id="btnFit">전체 보기</button>
    <span class="muted" style="margin-left:auto">표시: <b id="cntSido">0</b>/<b id="cntSigg">0</b>/<b id="cntAemd">0</b>/<b id="cntRi">0</b></span>
  </div>
  <div class="row">
    <label class="chip"><input type="checkbox" id="chkSido" checked> 시도</label>
    <label class="chip"><input type="checkbox" id="chkSigg" checked> 시군구</label>
    <label class="chip"><input type="checkbox" id="chkAemd" checked> 읍면동</label>
    <label class="chip"><input type="checkbox" id="chkRi"   checked> 리</label>
  </div>
  <div class="list">
    <div class="muted">현재 화면(BBOX, EPSG:900913) 기준으로 GML2로 가져옵니다. 실패 시 에러로그에 URL 그대로 남깁니다.</div>
  </div>
</aside>

<!-- 오류 로그 도크 + FAB -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div style="font-weight:800">오류 로그</div>
    <div class="muted" id="errcount" style="margin-left:6px">0건</div>
    <div style="flex:1"></div>
    <button class="btnsm" id="btnCopy">복사</button>
    <button class="btnsm red" id="btnClear">지우기</button>
    <button class="btnsm" id="btnClose">닫기</button>
  </div>
  <div class="body" id="errBody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false">
  <span class="dot"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(function(){
  /* ===== 사용자 설정 ===== */
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const MODE = 'vworld'; // 'vworld' | 'ogc'
  const OGC_BASE = '';   // OGC 서버 쓰실 때 입력

  /* ===== 에러 로그 ===== */
  const errUI = {
    dock: document.getElementById('errdock'),
    body: document.getElementById('errBody'),
    fab:  document.getElementById('errFab'),
    cnt:  document.getElementById('errCntFab'),
    count:document.getElementById('errcount')
  };
  document.getElementById('btnClose').onclick=()=>{errUI.dock.classList.remove('open');errUI.fab.setAttribute('aria-expanded','false');};
  document.getElementById('btnClear').onclick=()=>{errUI.body.innerHTML='';errUI.count.textContent='0건';errUI.cnt.textContent='0';errUI.fab.classList.remove('error');};
  document.getElementById('btnCopy').onclick=async ()=>{const txt=[...errUI.body.querySelectorAll('.logrow')].map(el=>el.innerText).join('\n');try{await navigator.clipboard.writeText(txt||'(로그 없음)');}catch(e){}};
  errUI.fab.onclick=()=>{ const o=errUI.dock.classList.toggle('open'); errUI.fab.setAttribute('aria-expanded', String(o)); };
  function tstr(){ return new Date().toLocaleTimeString(); }
  function logERR(msg, urlOrDetail){
    const div=document.createElement('div'); div.className='logrow';
    const detail=typeof urlOrDetail==='string'?urlOrDetail:(urlOrDetail?.stack||urlOrDetail?.message||'');
    div.innerHTML=`<span class="time">[${tstr()}]</span><span class="lvl">ERR</span> ${msg}`+(detail?`<div style="color:#9ca3af;white-space:pre-wrap;margin-left:6px">${detail}</div>`:'');
    errUI.body.appendChild(div); errUI.body.scrollTop=errUI.body.scrollHeight;
    const n=(Number(errUI.cnt.textContent)||0)+1; errUI.cnt.textContent=String(n); errUI.fab.classList.add('error');
    errUI.count.textContent=`${errUI.body.querySelectorAll('.logrow').length}건`;
  }
  window.addEventListener('error',(e)=>logERR('window.onerror',e.message));
  window.addEventListener('unhandledrejection',(e)=>logERR('unhandledrejection',e.reason?.message||String(e.reason)));

  /* ===== URL 빌더(GML2) ===== */
  function vwBuildWfsUrlGML2(typename, bbox3857){
    const p=new URLSearchParams({
      SERVICE:'WFS', REQUEST:'GetFeature', VERSION:'1.1.0',
      TYPENAME:typename, SRSNAME:'EPSG:900913',
      BBOX:bbox3857.join(','), MAXFEATURES:'1000',
      OUTPUT:'text/xml; subType=gml/2.1.2',   // ★ GML2
      EXCEPTIONS:'text/xml',
      KEY:VW_KEY, DOMAIN:DOMAIN
    });
    return `https://api.vworld.kr/req/wfs?${p.toString()}`;
  }
  // (선택) 표준 OGC WFS 서버용 GML2 — 서버마다 outputFormat 값이 다를 수 있음(GML2, GML2-L2, application/gml+xml 등)
  function ogcBuildWfsUrlGML2(typename, bbox3857){
    const p=new URLSearchParams({
      service:'WFS', request:'GetFeature', version:'1.1.0',
      typeName:typename, srsName:'EPSG:3857',
      bbox:bbox3857.join(','), maxFeatures:'1000',
      outputFormat:'text/xml; subType=gml/2.1.2'
    });
    return `${OGC_BASE}?${p.toString()}`;
  }

  /* ===== 상태 표시 ===== */
  const stat=document.getElementById('stat');
  const ok =(m)=> stat.innerHTML=`· <span style="color:#10b981">OK</span> ${m}`;
  const warn=(m)=> stat.innerHTML=`· <span style="color:#f59e0b">WARN</span> ${m}`;

  /* ===== OpenLayers 준비 후 시작 ===== */
  const waitOL=setInterval(()=>{
    if(!window.ol) return;
    clearInterval(waitOL);

    const map=new ol.Map({
      target:'map',
      layers:[ new ol.layer.Tile({ source:new ol.source.OSM() }) ],
      view:new ol.View({ center:ol.proj.fromLonLat([127.5,36.4]), zoom:7, minZoom:4, maxZoom:19 })
    });

    // 스타일
    const lyStyle={
      sido:new ol.style.Style({ stroke:new ol.style.Stroke({color:[246,86,114,1],width:2.8}), fill:new ol.style.Fill({color:[246,86,114,0.06]}) }),
      sigg:new ol.style.Style({ stroke:new ol.style.Stroke({color:[37,99,235,1], width:2.2}), fill:new ol.style.Fill({color:[37,99,235,0.05]}) }),
      aemd:new ol.style.Style({ stroke:new ol.style.Stroke({color:[16,185,129,1], width:1.6}), fill:new ol.style.Fill({color:[16,185,129,0.05]}) }),
      ri  :new ol.style.Style({ stroke:new ol.style.Stroke({color:[234,179,8,1],  width:1.2, lineDash:[6,6]}), fill:new ol.style.Fill({color:[234,179,8,0.03]}) })
    };

    // 레이어 생성기
    function makeLayer(label, typename, style, counterEl){
      const src=new ol.source.Vector({wrapX:true});
      const ly =new ol.layer.Vector({source:src, style, visible:true, zIndex:100});
      ly.__typename=typename; ly.__label=label; ly.__counterEl=counterEl;
      ly.__zoomGate={ min: label==='시도'?0 : label==='시군구'?7 : label==='읍면동'?10 : 12 };
      map.addLayer(ly);
      return ly;
    }
    const lySido=makeLayer('시도','lt_c_adsido_info',lyStyle.sido,document.getElementById('cntSido'));
    const lySigg=makeLayer('시군구','lt_c_adsigg_info',lyStyle.sigg,document.getElementById('cntSigg'));
    const lyAemd=makeLayer('읍면동','lt_c_ademd_info',lyStyle.aemd,document.getElementById('cntAemd'));
    const lyRi  =makeLayer('리'  ,'lt_c_adri_info'  ,lyStyle.ri  ,document.getElementById('cntRi'));

    // GML2 파서(WFS)
    const wfsFmtGml2 = new ol.format.WFS({ gmlFormat: new ol.format.GML2() });

    async function loadLayerGML2(ly){
      try{
        const z=map.getView().getZoom();
        if(z < ly.__zoomGate.min || !ly.getVisible()){ ly.getSource().clear(); ly.__counterEl.textContent='0'; return; }

        const extent=map.getView().calculateExtent(map.getSize());
        const bbox=[extent[0],extent[1],extent[2],extent[3]];
        const url = (MODE==='vworld') ? vwBuildWfsUrlGML2(ly.__typename, bbox)
                                      : ogcBuildWfsUrlGML2(ly.__typename, bbox);

        const res=await fetch(url,{mode:'cors'});
        if(!res.ok){ logERR(`WFS 로드 실패(${ly.__typename})`, `${url}\nHTTP ${res.status}`); return; }

        const xmlText = await res.text();
        const xmlDoc  = new DOMParser().parseFromString(xmlText,'text/xml');

        const feats = wfsFmtGml2.readFeatures(xmlDoc, { dataProjection:'EPSG:3857', featureProjection:'EPSG:3857' });
        ly.getSource().clear(true);
        if(feats && feats.length) ly.getSource().addFeatures(feats);
        ly.__counterEl.textContent = String(feats?.length||0);

        console.info(`[WFS OK GML2] ${ly.__typename}`, url, feats?.length||0);
      }catch(e){
        const extent=map.getView().calculateExtent(map.getSize());
        const url=(MODE==='vworld')?vwBuildWfsUrlGML2(ly.__typename,[extent[0],extent[1],extent[2],extent[3]])
                                    :ogcBuildWfsUrlGML2(ly.__typename,[extent[0],extent[1],extent[2],extent[3]]);
        logERR(`WFS 로드 실패(${ly.__typename})`, `${url}\n${e?.message||e}`);
      }
    }

    // 디바운스 로드
    let timer=null;
    function reloadAll(){ clearTimeout(timer); timer=setTimeout(()=>{ [lySido,lySigg,lyAemd,lyRi].forEach(loadLayerGML2); }, 250); }

    // 체크박스
    document.getElementById('chkSido').onchange=(e)=>{ lySido.setVisible(e.target.checked); reloadAll(); };
    document.getElementById('chkSigg').onchange=(e)=>{ lySigg.setVisible(e.target.checked); reloadAll(); };
    document.getElementById('chkAemd').onchange=(e)=>{ lyAemd.setVisible(e.target.checked); reloadAll(); };
    document.getElementById('chkRi').onchange  =(e)=>{ lyRi.setVisible(e.target.checked);  reloadAll(); };

    // 현재 위치
    document.getElementById('btnLoc').onclick=()=>{
      const secure=location.protocol==='https:'||['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!secure||!navigator.geolocation){ warn('위치 권한/환경 문제(https 필요)'); return; }
      navigator.geolocation.getCurrentPosition(
        p=>{ const c=ol.proj.fromLonLat([p.coords.longitude,p.coords.latitude]); map.getView().animate({center:c,zoom:12,duration:350}); },
        err=>{ logERR('geolocation 실패', `${err.code} ${err.message}`); }
      );
    };

    // 전체 보기
    document.getElementById('btnFit').onclick=()=>{
      const ex=ol.extent.createEmpty();
      [lySido,lySigg,lyAemd,lyRi].forEach(ly=> ly.getSource().getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent())));
      if(!ol.extent.isEmpty(ex)) map.getView().fit(ex,{duration:450,padding:[20,20,20,380],maxZoom:16});
    };

    // 지도 이벤트
    map.on('moveend', reloadAll);

    // 초기 로드
    document.getElementById('stat').innerHTML='· <span style="color:#10b981">OK</span> OpenLayers · VWorld WFS(GML2)';
    reloadAll();
  },40);
})();
</script>
</body>
</html>