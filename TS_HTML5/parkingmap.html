<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>브이월드 WMS → WFS(JSONP) 폴백 · 오류로그(에러만) · OL 10.6.1</title>

<!-- OpenLayers 동적 로더 -->
<script>
(function(){
  const cssList=[
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'
  ];
  const jsList=[
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js',
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js'
  ];
  const link=document.createElement('link'); link.rel='stylesheet'; link.href=cssList[0];
  link.onerror=()=>{ const l=document.createElement('link'); l.rel='stylesheet'; l.href=cssList[1]; document.head.appendChild(l); };
  document.head.appendChild(link);
  function loadJS(list,i,resolve,reject){
    if(i>=list.length) return reject(new Error('ol load fail'));
    const s=document.createElement('script'); s.src=list[i]; s.async=false; s.crossOrigin='anonymous';
    let done=false;
    const next=()=>{ if(done) return; done=true; s.remove(); loadJS(list,i+1,resolve,reject); };
    s.onload=()=> setTimeout(()=> (window.ol&&ol.Map)?(done=true,resolve(list[i])):next(),0);
    s.onerror=next; document.head.appendChild(s);
  }
  window.OL_READY=new Promise((res,rej)=> loadJS(jsList,0,res,rej));
})();
</script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  /* 좌측 패널 (원본 유지 + 모바일 대응) */
  .side{
    position:fixed; left:12px; top:12px; bottom:12px; width:360px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media (max-width:960px){
    .side{ right:12px; width:auto; max-width:calc(100% - 24px) }
  }
  @media (max-width:600px){
    .side{ left:0; right:0; top:auto; bottom:0; width:100%; border-radius:14px 14px 0 0; }
    #map{ padding-bottom:280px } /* 아이폰/갤럭시에서 패널 높이만큼 여백 */
  }

  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent}

  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530}
  .item{padding:10px 12px; border-bottom:1px solid var(--border); display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}

  /* 오류 로그(에러만 표기) */
  .errdock{
    position:fixed; right:12px; bottom:68px; z-index:1000;
    width:min(560px, calc(100% - 24px));
    background:#0f172a; border:1px solid var(--border); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:none; flex-direction:column;
  }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .body{
    max-height:38vh; overflow:auto; padding:8px 10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem;
    background:#0b1220
  }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px }
  .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }

  .errfab{
    position:fixed; right:12px; bottom:12px; z-index:1001;
    background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.35)
  }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem}
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널(유지) -->
<aside class="side">
  <div class="row title">
    <div>목록</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>건</div>
  </div>

  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn ghost" id="fitBtn">전체 보기</button>
    <span id="stat" class="muted" style="margin-left:auto">초기화 중…</span>
  </div>

  <div id="list" class="list" role="listbox" aria-label="목록"></div>
</aside>

<!-- 오류 로그(에러만) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div style="flex:1"></div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(async function(){
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';

  /* ===== 오류 로그(에러만) ===== */
  const ERRUI = (()=> {
    const dock=document.getElementById('errdock');
    const body=document.getElementById('errbody');
    const count=document.getElementById('errcount');
    const fab=document.getElementById('errFab');
    const cntFab=document.getElementById('errCntFab');
    document.getElementById('closeErr').onclick=()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    document.getElementById('copyErr').onclick=async()=> {
      const txt=[...body.querySelectorAll('.logrow')].map(el=>el.innerText).join('\n');
      try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch(_){}
    };
    fab.onclick=()=>{ const o=dock.classList.toggle('open'); fab.setAttribute('aria-expanded',String(o)); };
    return { dock, body, count, fab, cntFab, add(level,msg,detail){
      if(level!=='ERR') return; // ★ 에러만
      const row=document.createElement('div'); row.className='logrow';
      const t=new Date().toLocaleTimeString();
      row.innerHTML=`<span class="time">[${t}]</span><span class="lvl lvl-ERR">ERR</span><span>${msg}</span>`+(detail?`<div class="muted" style="margin-left:8px;white-space:pre-wrap">${detail}</div>`:'');
      body.appendChild(row); body.scrollTop=body.scrollHeight;
      const n=body.querySelectorAll('.logrow').length; count.textContent=`${n}건`; cntFab.textContent=String(n);
    }};
  })();
  const logErr=(m,d)=>ERRUI.add('ERR',m,d);
  window.addEventListener('error', (e)=> logErr('window.onerror', e.message||''));
  window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', (e.reason&&e.reason.message)||''));

  /* ===== OpenLayers 준비 ===== */
  let olSrc=''; try{ olSrc = await window.OL_READY; }catch(e){ logErr('OpenLayers 로드 실패', e&&e.message); return; }
  const $ = (s)=>document.querySelector(s);
  const stat = $('#stat'); const ok=(m)=> stat.textContent=m;

  /* ===== 지도 ===== */
  const map = new ol.Map({
    target:'map',
    layers:[],
    view:new ol.View({
      center: ol.proj.fromLonLat([127.5, 36.0]), // 초기 임시(김천 고정 제거)
      zoom: 7, minZoom:4, maxZoom:18
    })
  });

  // Base: 브이월드(문제시 OSM)
  const baseVW = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: `https://api.vworld.kr/req/wmts/1.0.0/${VW_KEY}/Base/{z}/{y}/{x}.png?domain=${DOMAIN}`,
      maxZoom: 18, minZoom: 4, crossOrigin:'anonymous'
    }), zIndex:0, visible:true
  });
  const baseOSM = new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0, visible:false });
  map.addLayer(baseVW); map.addLayer(baseOSM);
  baseVW.getSource().on('tileloaderror', ()=>{ baseVW.setVisible(false); baseOSM.setVisible(true); });

  /* ===== 지적선 WMS (에러 → JSONP WFS 폴백) ===== */
  const cbndWms = new ol.layer.Tile({
    source: new ol.source.TileWMS({
      url: 'https://api.vworld.kr/req/wms',
      params: {
        SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
        LAYERS:'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
        STYLES:'lp_pa_cbnd_bonbun_line,lp_pa_cbnd_bubun_line',
        CRS:'EPSG:900913', FORMAT:'image/png',
        TRANSPARENT:false, BGCOLOR:'0xFFFFFF',
        KEY: VW_KEY, DOMAIN: DOMAIN
      },
      crossOrigin:'anonymous'
    }),
    opacity:0.9, zIndex:50, visible:true
  });
  map.addLayer(cbndWms);

  // 폴백용 벡터 레이어
  const wfsLayer = new ol.layer.Vector({
    source: new ol.source.Vector(),
    style: new ol.style.Style({ stroke:new ol.style.Stroke({color:'#ef4444', width:2}) }),
    zIndex:80, visible:false
  });
  map.addLayer(wfsLayer);

  /* ===== JSONP WFS 호출 (가이드 고정 형식) ===== */
  const VW_WFS_JSONP = 'https://map.vworld.kr/js/wfs.do';
  let jsonpBusy=false, jsonpTimer=null, fallbackArmed=false, lastBoxKey='';
  function requestWFSJsonp(bbox3857, onDone){
    if(jsonpBusy) return;
    jsonpBusy=true;

    const CB='func_callback'; // 고정
    // 콜백: GML2 파싱 → featureProjection 변환
    window[CB]=function(payload){
      cleanup();
      try{
        const xml = (typeof payload==='string')
          ? new DOMParser().parseFromString(payload,'text/xml') : payload;
        const feats = new ol.format.WFS().readFeatures(xml,{
          dataProjection: 'EPSG:900913',
          featureProjection: 'EPSG:3857'
        });
        onDone && onDone(null, feats);
      }catch(e){ logErr('WFS JSONP parse_error', e.message||''); onDone && onDone(e); }
    };

    const params = [
      'SERVICE=WFS','REQUEST=GetFeature','VERSION=1.1.0',
      'TYPENAME=LT_C_UQ111',
      `BBOX=${bbox3857.join(',')}`,
      'SRSNAME=EPSG:900913','MAXFEATURES=400',
      'PROPERTYNAME=' + [
        'mnum','sido_cd','sigungu_cd','dyear','dnum','ucode',
        'bon_bun','bu_bun','uname','sido_name','sigg_name','ag_geom'
      ].join(','),
      // ★ 가이드 예제 그대로
      'OUTPUT=' + encodeURIComponent('text/xml; subType=gml/2.1.2'),
      'EXCEPTIONS=text/xml',
      'FORMAT_OPTIONS=' + encodeURIComponent('callback:func_callback'),
      'APIKEY=' + encodeURIComponent(VW_KEY),
      'DOMAIN=' + encodeURIComponent(DOMAIN)
    ].join('&');

    const s=document.createElement('script');
    s.async=true; s.crossOrigin='anonymous'; s.src = `${VW_WFS_JSONP}?${params}`;
    s.onerror=()=>{ cleanup(); logErr('WFS JSONP script_error', s.src); onDone && onDone(new Error('script_error')); };
    jsonpTimer=setTimeout(()=>{ cleanup(); logErr('WFS JSONP jsonp_timeout', s.src); onDone && onDone(new Error('jsonp_timeout')); }, 12000);
    document.head.appendChild(s);

    function cleanup(){
      if(jsonpTimer){ clearTimeout(jsonpTimer); jsonpTimer=null; }
      try{ delete window[CB]; }catch(_){ window[CB]=undefined; }
      if(s.parentNode) s.parentNode.removeChild(s);
      jsonpBusy=false;
    }
  }

  // WMS 타일 에러 1회만 처리 → 레이어 숨김 + moveend로만 재시도
  let wmsErrored=false;
  function onWmsErr(){
    if(wmsErrored) return;
    wmsErrored=true;
    logErr('WMS cbnd tile error → WFS(JSONP) 폴백');
    cbndWms.setVisible(false);
    cbndWms.getSource().un('tileloaderror', onWmsErr);
    wfsLayer.setVisible(true);
    fallbackArmed=true;           // ★ 폴백 가동
    kickFallbackNow();            // 첫 1회 즉시
  }
  cbndWms.getSource().on('tileloaderror', onWmsErr);

  // bbox key
  function boxKey(b){ return b.map(v=>v.toFixed(0)).join(','); }

  // 현재 뷰 bbox로 즉시 폴백 1회
  function kickFallbackNow(){
    if(!fallbackArmed) return;
    const b = ol.proj.transformExtent(map.getView().calculateExtent(map.getSize()), 'EPSG:3857','EPSG:3857');
    const key = boxKey(b);
    if(key===lastBoxKey) return;
    lastBoxKey=key;
    requestWFSJsonp(b, (err,feats)=>{
      if(err) return; // 에러는 로그에만 남김
      const src=wfsLayer.getSource(); src.clear(true); src.addFeatures(feats);
      $('#count').textContent = String(feats.length);
      buildList(feats); // 좌측 리스트 유지(간단 표기)
    });
  }

  // 지도 이동/확대 시에만 재시도(디바운스)
  let moveTimer=null;
  map.on('moveend', ()=>{
    if(!fallbackArmed) return;
    if(moveTimer) clearTimeout(moveTimer);
    moveTimer=setTimeout(kickFallbackNow, 400);
  });

  /* ===== 좌측 목록(유지) ===== */
  function buildList(features){
    const list=$('#list'); const rows = (features||[]).slice(0,200);
    if(rows.length===0){ list.innerHTML = `<div class="item"><div class="nm">결과 없음</div><div class="sub">WFS(JSONP) 폴백 데이터 없음</div></div>`; return; }
    list.innerHTML = rows.map((f,i)=>{
      const p=f.getProperties();
      const nm = `${p.sido_name||''} ${p.sigg_name||''}`.trim() || (p.uname||'지적');
      const etc = [`본번:${p.bon_bun||'-'}`, `부번:${p.bu_bun||'-'}`, `연도:${p.dyear||'-'}`].join(' · ');
      return `<div class="item"><div class="nm">${i+1}. ${nm}</div><div class="sub">${etc}</div></div>`;
    }).join('');
  }

  /* ===== 현재 위치 ===== */
  function locate(){
    const isSecure = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
    if(!isSecure || !navigator.geolocation){
      ok('위치 권한 불가(비보안/미지원)'); return;
    }
    const opts={ enableHighAccuracy:true, maximumAge:5000, timeout:9000 };
    navigator.geolocation.getCurrentPosition(
      p=>{
        const lon=p.coords.longitude, lat=p.coords.latitude;
        const c=ol.proj.fromLonLat([lon,lat]);
        map.getView().animate({center:c, zoom:15, duration:400});
        ok('현재 위치 설정 완료');
      },
      err=>{ logErr('geolocation error', `${err.code} ${err.message}`); ok('위치 실패'); },
      opts
    );
  }
  document.getElementById('locBtn').onclick=locate;
  document.getElementById('fitBtn').onclick=()=> {
    const ex=ol.extent.createEmpty();
    wfsLayer.getSource().getFeatures().forEach(f=> ol.extent.extend(ex, f.getGeometry().getExtent()));
    if(!ol.extent.isEmpty(ex)) map.getView().fit(ex,{duration:400, padding:[30,380,30,30], maxZoom:17});
  };

  // 처음엔 위치 시도
  locate();
  ok('초기화 완료');
})();
</script>
</body>
</html>