<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>주차장 지도 · 현재위치 자동 · 반경 3km · 행정경계</title>

<!-- VWorld 2D API (도메인 등록 必: 제공값 사용) -->
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=CF9A371B-35A6-3822-8315-6592C8342E82&domain=psychic-pancake-r7q577jxr6ghwx9g-8080.app.github.dev"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#2563eb; --accent2:#1d4ed8; --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}

  .layout{display:grid; grid-template-columns: 360px 1fr; height:100vh}
  @media (max-width: 960px){
    .layout{ grid-template-columns: 1fr }
    .side{ position:fixed; z-index:30; left:12px; right:12px; top:12px }
    .mapwrap{ height:100vh }
  }
  .side{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; margin:12px; padding:12px;
    display:flex; flex-direction:column; gap:10px; max-height: calc(100vh - 24px);
  }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .title{ font-weight:800; display:flex; gap:8px; align-items:center; }
  .muted{ color:var(--muted) }
  .btn{ border:0; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer;
    background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff }
  .btn.ghost{ background:transparent; color:#c7d2fe; border:1px solid var(--border) }
  .chipbar{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{
    background:var(--chip); border:1px solid var(--border); color:#c7d2fe;
    padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem;
  }
  .chip.active{ background:var(--chipOn); color:#fff; border-color:transparent }
  .list{ overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height: 140px }
  .item{ padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px }
  .item:last-child{ border-bottom:0 }
  .item:hover{ background:rgba(37,99,235,.08) }
  .item.active{ outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12) }
  .nm{ font-weight:700 }
  .sub{ color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap }
  .badge{ display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c }
  .dist{ color:#9ca3af }

  .mapwrap{ position:relative; }
  #map{ position:absolute; inset:0 }

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:40;background:#111827;color:#fff;border:1px solid #374151;padding:10px 12px;border-radius:10px;display:none}

  /* 팝업 (닫기 버튼 포함, 클릭 가능) */
  .ol-popup{position:absolute;background:#111827;color:#e5e7eb;padding:10px 12px;border:1px solid #374151;border-radius:10px;
    min-width:220px;transform:translate(-50%,-110%);pointer-events:auto}
  .ol-popup .tit{font-weight:700;margin-right:26px}
  .ol-popup .sub2{color:#9ca3af;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#e5e7eb;font-size:18px;cursor:pointer;line-height:1}
</style>
</head>
<body>
  <div class="layout">
    <aside class="side">
      <div class="row title">
        <div>주차장(반경 <b>3km</b>)</div>
        <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
      </div>

      <div class="row">
        <button class="btn" id="locBtn">현재 위치</button>
        <button class="btn ghost" id="fitBtn">전체 보기</button>
        <button class="btn ghost" id="reloadAdminBtn">행정경계 갱신</button>
      </div>

      <div class="chipbar" id="typeBar" role="group" aria-label="주차장 형태 필터">
        <div class="chip active" data-type="">전체</div>
        <div class="chip" data-type="노상">노상</div>
        <div class="chip" data-type="노외">노외</div>
        <div class="chip" data-type="부설">부설</div>
      </div>

      <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
    </aside>

    <main class="mapwrap">
      <div id="map" aria-label="브이월드 2D 지도"></div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* =========================
   0) 상수/전역
   ========================= */
const VWORLD_KEY    = "CF9A371B-35A6-3822-8315-6592C8342E82";
const VWORLD_DOMAIN = "psychic-pancake-r7q577jxr6ghwx9g-8080.app.github.dev";

const FALLBACK_CENTER = { lng:128.1136, lat:36.1398 }; // 김천 기본점
const RADIUS_M = 3000; // 3km
const $ = (s)=>document.querySelector(s);
const countEl = $('#count'), selEl = $('#sel'), toast = $('#toast');

let ORIGIN = { ...FALLBACK_CENTER };
let currentType = ""; // '', '노상','노외','부설'

// 데이터 풀: LIVE(실검색) + DEMO(테스트) → VIEW(필터 결과)
let LIVE = [];
let DEMO = [];
let VIEW = [];

function showToast(msg, ms=2000){
  toast.textContent = msg; toast.style.display='block';
  clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.style.display='none', ms);
}
function km(a,b){
  const R=6371,toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const t=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.sqrt(t));
}
function degBoxAround(lng, lat, kmRadius){
  const dLat = kmRadius/111;
  const dLng = kmRadius/(111*Math.cos(lat*Math.PI/180));
  return [lng-dLng, lat-dLat, lng+dLng, lat+dLat];
}
function inferType(name="", category="", addr=""){
  if(/노상/.test(name)||/노상/.test(category)) return "노상";
  if(/노외|공영|타워|주차타워/.test(name)||/노외|공영|타워/.test(category)) return "노외";
  if(/부설|몰|백화점|병원|학교|아파트/.test(name+addr)) return "부설";
  return "노외";
}

/* =========================
   1) 지도/레이어
   ========================= */
let vmap, vectorSrc, clusterSrc, clusterLayer, overlay;
let meLayer, radiusLayer, adminLayer;
let popupEl; // 닫기 버튼이 있는 팝업 DOM

function initMap(){
  if(!(window.vw && vw.ol3 && window.ol)){ showToast('VWorld 로드 실패(apiKey/domain 확인)'); return; }

  vw.ol3.MapOptions = {
    basemapType: vw.ol3.BasemapType.GRAPHIC,
    controlDensity: vw.ol3.DensityType.EMPTY,
    interactionDensity: vw.ol3.DensityType.BASIC,
    controlsAutoArrange: true,
    homePosition: vw.ol3.CameraPosition,
    initPosition: vw.ol3.CameraPosition
  };
  vmap = new vw.ol3.Map("map", vw.ol3.MapOptions);

  const c = ol.proj.transform([ORIGIN.lng, ORIGIN.lat], 'EPSG:4326', 'EPSG:3857');
  vmap.getView().setCenter(c); vmap.getView().setZoom(14);

  vectorSrc   = new ol.source.Vector({ features: [] });
  clusterSrc  = new ol.source.Cluster({ distance: 40, minDistance: 10, source: vectorSrc });
  clusterLayer= new ol.layer.Vector({ source: clusterSrc, style: clusterStyle });
  meLayer     = new ol.layer.Vector({ source: new ol.source.Vector() });
  radiusLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
  adminLayer  = new ol.layer.Vector({ source: new ol.source.Vector() });

  const realMap = (vmap.addLayer ? vmap : (vmap.getMap? vmap.getMap():vmap.map));
  realMap.addLayer(clusterLayer);
  realMap.addLayer(adminLayer);  // bring to top
  realMap.removeLayer(adminLayer); realMap.addLayer(adminLayer);
  realMap.addLayer(radiusLayer);
  realMap.addLayer(meLayer);

  // 닫기 버튼 있는 팝업 생성 (pointer-events: auto, stopEvent: true)
  popupEl = document.createElement('div');
  popupEl.className = 'ol-popup';
  popupEl.innerHTML = `
    <button class="x" aria-label="닫기">×</button>
    <div class="tit"></div>
    <div class="sub2 addr"></div>
    <div class="sub2 meta"></div>
  `;
  overlay = new ol.Overlay({ element: popupEl, positioning: 'bottom-center', stopEvent: true, offset: [0, -12] });
  (vmap.addOverlay ? vmap.addOverlay(overlay) : realMap).addOverlay?.(overlay);

  popupEl.querySelector('.x').addEventListener('click', ()=> overlay.setPosition(undefined));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') overlay.setPosition(undefined); });

  vmap.on('click', function(evt){
    let handled = false;
    vmap.forEachFeatureAtPixel(evt.pixel, function(feature, layer){
      if(layer !== clusterLayer) return;
      const members = feature.get('features') || [];
      if(members.length > 1){
        const extent = ol.extent.createEmpty();
        members.forEach(f => ol.extent.extend(extent, f.getGeometry().getExtent()));
        vmap.getView().fit(extent, { duration: 300, maxZoom: 17, padding: [40,20,40,380] });
      }else if(members.length === 1){
        const f = members[0]; const p = f.getProperties();
        popupEl.querySelector('.tit').textContent  = p.nm || '주차장';
        popupEl.querySelector('.addr').textContent = p.addr || '';
        popupEl.querySelector('.meta').textContent = `형태: ${p.type || '주차장'} · 좌표: ${Number(p.lat).toFixed(5)}, ${Number(p.lng).toFixed(5)}`;
        overlay.setPosition(evt.coordinate);
        selEl.textContent = p.nm || '주차장';
        highlightListItem(p.nm);
      }
      handled = true; return true;
    });
    if(!handled) overlay.setPosition(undefined);
  });
}

const PARK_ICON_SVG = `
<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
  <circle cx='18' cy='18' r='16' fill='#2563eb'/>
  <text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
</svg>`;
function clusterStyle(feature){
  const size = (feature.get('features')||[]).length;
  if(size > 1){
    return new ol.style.Style({
      image: new ol.style.Circle({
        radius: Math.max(12, Math.min(28, 10 + Math.log(size)*8)),
        fill: new ol.style.Fill({ color: [37,99,235,0.85] }),
        stroke: new ol.style.Stroke({ color: '#ffffff', width: 2 })
      }),
      text: new ol.style.Text({
        text: String(size),
        fill: new ol.style.Fill({ color: '#ffffff' }),
        stroke: new ol.style.Stroke({ color: '#000000', width: 3 })
      })
    });
  }
  return new ol.style.Style({
    image: new ol.style.Icon({
      src: 'data:image/svg+xml;utf8,' + encodeURIComponent(PARK_ICON_SVG.trim()),
      scale: 1.0, anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction'
    })
  });
}

/* =========================
   2) 실데이터 + 데모데이터
   ========================= */
async function vworldPlaceSearch(query, page=1, size=100){
  const url = `https://api.vworld.kr/req/search?service=search&request=search&version=2.0`
            + `&format=json&errorformat=json&crs=EPSG:4326&type=place`
            + `&size=${size}&page=${page}&key=${encodeURIComponent(VWORLD_KEY)}`
            + `&domain=${encodeURIComponent(VWORLD_DOMAIN)}`
            + `&query=${encodeURIComponent(query)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('VWorld 요청 실패');
  const json = await res.json();
  if(json.response && json.response.status==='OK') return json.response.result.items||[];
  return [];
}
function generateDemo(n=50){
  const out=[];
  for(let i=0;i<n;i++){
    const r = (Math.random()*2.6 + 0.2); // 0.2~2.8 km (3km 안쪽 보장)
    const ang = Math.random()*Math.PI*2;
    const dLat = (r/111)*Math.sin(ang);
    const dLng = (r/(111*Math.cos(ORIGIN.lat*Math.PI/180)))*Math.cos(ang);
    const lat = ORIGIN.lat + dLat, lng = ORIGIN.lng + dLng;
    const types = ['노상','노외','부설'];
    const t = types[i%3];
    out.push({
      id:`DEMO-${ORIGIN.lng.toFixed(4)}-${ORIGIN.lat.toFixed(4)}-${i}`,
      nm:`데모 ${t} 주차장 ${i+1}`,
      lng, lat,
      addr:`데모로 ${i+1} (반경 ${r.toFixed(1)}km)`,
      type:t
    });
  }
  return out;
}
async function loadLive(){
  let rows = [];
  try{
    const live = []
      .concat(await vworldPlaceSearch('김천시 주차장',1,100))
      .concat(await vworldPlaceSearch('김천 주차',1,100));
    const seen = new Set();
    for(const it of live){
      const lng = Number(it.point?.x), lat = Number(it.point?.y);
      if(!isFinite(lng)||!isFinite(lat)) continue;
      const title = String(it.title||'');
      const road  = it.address?.road || it.address?.parcel || '';
      const cat   = it.category || '';
      if(!(/주차/.test(road)||/주차/.test(title))) continue;
      const key = `${title}@${lng.toFixed(6)},${lat.toFixed(6)}`;
      if(seen.has(key)) continue; seen.add(key);
      rows.push({ id:key, nm:title, lng, lat, addr:road, type:inferType(title,cat,road) });
    }
  }catch(e){ console.warn('검색 실패(무시):', e); }
  LIVE = rows;
  recompute();
}

/* ORIGIN 기준 3km + 타입 필터 */
function recompute(){
  const ALL = LIVE.concat(DEMO); // 항상 DEMO 포함
  const within = ALL.map(r=>{
    const dkm = km(ORIGIN, {lng:r.lng, lat:r.lat});
    return { ...r, distKm: dkm };
  }).filter(r => r.distKm*1000 <= RADIUS_M);

  const rows = within
    .filter(r => !currentType || r.type===currentType)
    .sort((a,b)=>a.distKm - b.distKm);

  VIEW = rows;
  buildList(rows);
  rebuildMarkers(rows);
}

/* =========================
   3) 리스트 UI
   ========================= */
function buildList(rows){
  const list = $('#list');
  if(rows.length===0){
    list.innerHTML = `<div class="item"><div class="nm">결과 없음</div><div class="sub">반경 3km / 형태: ${currentType||'전체'}</div></div>`;
    countEl.textContent = '0';
    return;
  }
  list.innerHTML = rows.map((r,i)=>`
    <div class="item" data-id="${r.id}" role="option" tabindex="0">
      <div class="nm">${i+1}. ${r.nm}</div>
      <div class="sub">
        <span class="badge">${r.type}</span>
        <span class="dist">${r.distKm.toFixed(2)} km</span>
        <span>${r.addr||''}</span>
      </div>
    </div>
  `).join('');
  countEl.textContent = String(rows.length);

  list.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', ()=> focusItem(el.dataset.id));
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ focusItem(el.dataset.id); e.preventDefault(); } });
  });
}
function highlightListItem(name){
  const list = $('#list');
  list.querySelectorAll('.item').forEach(el=> el.classList.remove('active'));
  const el = Array.from(list.querySelectorAll('.item')).find(x => x.querySelector('.nm')?.textContent.includes(name));
  if(el){ el.classList.add('active'); el.scrollIntoView({block:'nearest', behavior:'smooth'}); }
}
function focusItem(id){
  const r = VIEW.find(x => x.id===id);
  if(!r) return;
  const coord = ol.proj.transform([r.lng, r.lat],'EPSG:4326','EPSG:3857');
  vmap.getView().setCenter(coord); vmap.getView().setZoom(16);
  popupEl.querySelector('.tit').textContent  = r.nm;
  popupEl.querySelector('.addr').textContent = r.addr || '';
  popupEl.querySelector('.meta').textContent = `형태: ${r.type} · 좌표: ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}`;
  overlay.setPosition(coord);
  selEl.textContent = r.nm;
  highlightListItem(r.nm);
}

/* =========================
   4) 마커(클러스터)
   ========================= */
function rebuildMarkers(rows){
  const feats = rows.map(r=>{
    const coord = ol.proj.transform([r.lng, r.lat], 'EPSG:4326', 'EPSG:3857');
    const f = new ol.Feature({ geometry:new ol.geom.Point(coord) });
    f.setProperties({ nm:r.nm, addr:r.addr, type:r.type, lng:r.lng, lat:r.lat });
    return f;
  });
  vectorSrc.clear(); vectorSrc.addFeatures(feats);
}

/* =========================
   5) 현재 위치 & 3km 원
   ========================= */
function drawOrigin(lng, lat){
  const PERSON_ICON_SVG = `
  <svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
      <stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
    <path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>
    <circle cx='19' cy='12' r='5' fill='#fff'/>
    <path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>
  </svg>`;
  const c = ol.proj.transform([lng, lat], 'EPSG:4326', 'EPSG:3857');
  const me = new ol.Feature({ geometry: new ol.geom.Point(c) });
  me.setStyle(new ol.style.Style({
    image:new ol.style.Icon({
      src: 'data:image/svg+xml;utf8,'+encodeURIComponent(PERSON_ICON_SVG.trim()),
      scale:1.0, anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction'
    })
  }));
  meLayer.getSource().clear(); meLayer.getSource().addFeature(me);

  const circle = new ol.geom.Circle(c, RADIUS_M);
  const feat = new ol.Feature(circle);
  feat.setStyle(new ol.style.Style({
    stroke:new ol.style.Stroke({ color:[220,38,38,0.9], width:2 }),
    fill:new ol.style.Fill({ color:[220,38,38,0.12] })
  }));
  radiusLayer.getSource().clear(); radiusLayer.getSource().addFeature(feat);
}

/* ORIGIN 설정: 데모 재생성하여 항상 보이게 */
function setOrigin(lng, lat, fly=true){
  ORIGIN = {lng, lat};
  drawOrigin(lng, lat);
  DEMO = generateDemo(50); // ★ 중심 바뀔 때마다 재생성
  if(fly){
    const c = ol.proj.transform([lng,lat],'EPSG:4326','EPSG:3857');
    vmap.getView().setCenter(c); vmap.getView().setZoom(15);
  }
  recompute();
  loadAdminBoundaries(); // 경계 갱신
}

/* =========================
   6) 자동 현재위치 (버튼 누르지 않아도 시도)
   - getCurrentPosition으로 즉시 요청 + watchPosition으로 ‘늦게 오는’ 좌표도 1회 반영
   ========================= */
async function autoLocateAtStart(){
  const secureOK = (location.protocol==='https:') || ['localhost','127.0.0.1','::1'].includes(location.hostname);
  if(!secureOK || !navigator.geolocation){
    // 보안 문맥 아님 → 기본점으로 즉시 표시
    setOrigin(FALLBACK_CENTER.lng, FALLBACK_CENTER.lat, true);
    showToast('HTTPS가 아니므로 기본 위치를 사용합니다');
    return;
  }

  // 1) 우선 기본점으로 즉시 화면 구성(데모 보장)
  setOrigin(FALLBACK_CENTER.lng, FALLBACK_CENTER.lat, true);

  // 2) 권한 상태 확인 후 요청
  try{
    if(navigator.permissions && navigator.permissions.query){
      const st = await navigator.permissions.query({name:'geolocation'});
      // granted면 바로 호출, prompt여도 호출하면 브라우저가 묻고 OK 시 성공 콜백
    }
  }catch(_){}

  let fixed = false;
  const opts = { enableHighAccuracy:true, maximumAge:5000, timeout:8000 };

  // watch로 '조금 늦게 도착하는' 좌표를 1회 반영
  const wid = navigator.geolocation.watchPosition(pos=>{
    if(fixed) return;
    fixed = true;
    navigator.geolocation.clearWatch(wid);
    setOrigin(pos.coords.longitude, pos.coords.latitude, true);
  }, _=>{
    // 무시 (getCurrentPosition이 아래에서 백업)
  }, opts);

  // 동시에 즉시 1회 요청 (일부 브라우저는 watch가 느림)
  navigator.geolocation.getCurrentPosition(pos=>{
    if(fixed) return;
    fixed = true;
    navigator.geolocation.clearWatch(wid);
    setOrigin(pos.coords.longitude, pos.coords.latitude, true);
  }, _=>{
    // 실패시 그대로 기본점 유지
  }, opts);
}

/* =========================
   7) 행정경계 (시/구) – 붉은 선
   ========================= */
async function fetchWFS(typename, bbox4326){
  const url = `https://api.vworld.kr/req/wfs?service=WFS&request=GetFeature&version=1.0.0`
            + `&typename=${encodeURIComponent(typename)}`
            + `&outputFormat=application/json&srsName=EPSG:4326`
            + `&bbox=${bbox4326.join(',')},EPSG:4326`
            + `&key=${encodeURIComponent(VWORLD_KEY)}&domain=${encodeURIComponent(VWORLD_DOMAIN)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('WFS 요청 실패');
  return await res.json();
}
function degBoxAround(lng, lat, kmRadius){
  const dLat = kmRadius/111;
  const dLng = kmRadius/(111*Math.cos(lat*Math.PI/180));
  return [lng-dLng, lat-dLat, lng+dLng, lat+dLat];
}
async function loadAdminBoundaries(){
  try{
    const bbox = degBoxAround(ORIGIN.lng, ORIGIN.lat, 12);
    const T_SIDO = 'lt_c_adsido';
    const T_SIGG = 'lt_c_adsigg';

    const [sido, sigg] = await Promise.all([
      fetchWFS(T_SIDO, bbox).catch(_=>null),
      fetchWFS(T_SIGG, bbox).catch(_=>null),
    ]);

    const fmt = new ol.format.GeoJSON();
    const src = adminLayer.getSource();
    src.clear();

    const add = (geojson, color) =>{
      if(!geojson) return;
      const feats = fmt.readFeatures(geojson, { dataProjection:'EPSG:4326', featureProjection:'EPSG:3857' });
      feats.forEach(f=>{
        f.setStyle(new ol.style.Style({
          stroke:new ol.style.Stroke({ color, width:2.2 }),
          fill: null
        }));
      });
      src.addFeatures(feats);
    };
    add(sido, 'rgba(239,68,68,0.95)');
    add(sigg, 'rgba(239,68,68,0.95)');
  }catch(e){
    console.warn('행정경계 로드 실패', e);
    showToast('행정경계 로드 실패(계정/도메인/레이어명 확인)');
  }
}

/* =========================
   8) 타입 칩
   ========================= */
function initTypeBar(){
  const bar = $('#typeBar');
  bar.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    bar.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentType = chip.dataset.type || "";
    recompute();
  });
}

/* =========================
   9) 시작 (자동 현재위치 + 데모 보장)
   ========================= */
async function start(){
  initMap();
  initTypeBar();

  // ★ 자동 현재위치: 버튼 없이도 시도 → 성공 시 즉시 재중심
  await autoLocateAtStart();

  // LIVE는 백그라운드로 추가
  loadLive();

  showToast('주변 주차장을 불러왔습니다');
}

/* 좌측 버튼 보조 */
document.getElementById('locBtn').addEventListener('click', autoLocateAtStart);
document.getElementById('fitBtn').addEventListener('click', ()=>{
  const extent = ol.extent.createEmpty();
  radiusLayer.getSource().getFeatures().forEach(f=> ol.extent.extend(extent, f.getGeometry().getExtent()));
  vectorSrc.getFeatures().forEach(f=> ol.extent.extend(extent, f.getGeometry().getExtent()));
  if(!ol.extent.isEmpty(extent)){
    vmap.getView().fit(extent, {duration:400, padding:[40,20,40,380], maxZoom:16});
  }
});
document.getElementById('reloadAdminBtn').addEventListener('click', loadAdminBoundaries);

window.addEventListener('load', start);
</script>
</body>
</html>