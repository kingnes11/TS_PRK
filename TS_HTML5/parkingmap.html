<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>김천 주차·행정경계 데모 (모바일 대응 + 로그)</title>

<!-- OpenLayers 10.6.1 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  .panel{
    position:fixed;z-index:20;background:#0b1220cc;color:#e5e7eb;border:1px solid #20304f;border-radius:10px;
    padding:10px;backdrop-filter: blur(6px)
  }
  /* 툴바(데스크톱 기본 노출) */
  #toolbar{left:12px;top:12px;min-width:260px}
  label{display:flex;align-items:center;gap:6px;margin:6px 0}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#111827;border:1px solid #374151;font-size:12px;margin-left:6px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#1f2937;border:1px solid #334155;font-size:12px}

  /* 로그 패널 */
  #logs{right:12px;top:12px;width:360px;max-height:46vh;overflow:auto}
  #logs h3{margin:0 0 6px 0;font-size:14px;color:#93c5fd}
  .log{font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .log .t{opacity:.7;margin-right:6px}
  .log.info{color:#a7f3d0}.log.err{color:#fecaca}.log.warn{color:#fde68a}
  .legend{margin-top:8px;font-size:12px;color:#cbd5e1}
  .legend .chip{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}

  /* FAB(모바일에서만 보이는 토글 버튼) */
  #fab{
    position:fixed;left:12px;top:12px;z-index:30;width:44px;height:44px;border-radius:10px;border:1px solid #20304f;
    background:#0b1220cc;color:#93c5fd;display:none;align-items:center;justify-content:center;font-size:22px;line-height:1
  }
  #shade{position:fixed;inset:0;background:rgba(2,6,23,.45);backdrop-filter: blur(1px);z-index:15;display:none}

  /* 모바일 최적화: 툴바 기본 닫힘(슬라이드 인), 로그 위치도 아래로 */
  @media (max-width: 768px){
    #toolbar{
      left:8px;top:8px;width:calc(100vw - 24px);max-width:420px;max-height:65vh;overflow:auto;
      transform: translateX(-110%);opacity:0;pointer-events:none;
      transition: transform .2s ease, opacity .2s ease;
    }
    #toolbar.open{ transform: translateX(0); opacity:1; pointer-events:auto; }
    #fab{ display:flex; }
    #logs{right:8px;left:8px;width:auto;bottom:8px;top:auto;max-height:32vh}
  }

  /* 팝업 */
  .popup{
    position:absolute;background:#111827;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px;min-width:220px
  }
  .popup .title{font-weight:700;margin-bottom:6px}
  .popup .close{cursor:pointer;float:right;border:none;background:transparent;color:#9ca3af;font-size:16px}
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 모바일: 패널 열기 버튼 -->
<button id="fab" aria-label="레이어 열기" title="레이어">≡</button>
<div id="shade"></div>

<!-- 툴바(레이어 목록) -->
<div id="toolbar" class="panel">
  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
    <strong>레이어</strong>
    <span class="badge">현재위치 자동</span>
  </div>
  <label><input type="checkbox" id="chk-sido" checked> 시도 경계 (붉은선)</label>
  <label><input type="checkbox" id="chk-sigg" checked> 시군구 경계 (붉은선)</label>
  <label><input type="checkbox" id="chk-emd"  checked> 읍면동 경계 (붉은선)</label>
  <label><input type="checkbox" id="chk-dummy" checked> 더미 주차장(클러스터)</label>
  <div class="legend" style="margin-top:8px">
    <div><span class="chip" style="background:#ef4444"></span>행정경계(윤곽)</div>
    <div><span class="chip" style="background:#60a5fa"></span>현재 위치</div>
    <div><span class="chip" style="background:#22c55e"></span>주차장 클러스터</div>
  </div>
  <div style="margin-top:8px">
    반경: <span id="radius-km" class="pill">3 km</span>
  </div>
</div>

<!-- 로그 패널 -->
<div id="logs" class="panel">
  <h3>오류/진단 로그</h3>
  <div id="logbox" class="log"></div>
</div>

<script>
(function(){
  // ---- 설정 ----
  const VW_KEY   = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const VW_DOMAIN= 'kingnes11.github.io';
  const RADIUS_KM_DEFAULT = 3;
  const FALLBACK_CENTER = [128.1136, 36.1398]; // 김천

  // ---- 로그 유틸 ----
  const logbox = document.getElementById('logbox');
  function ts(){ return new Date().toTimeString().slice(0,8); }
  function pushLog(type, msg){
    const div = document.createElement('div');
    div.className = `log ${type}`;
    div.innerHTML = `<span class="t">[${ts()}]</span><span class="u">${type.toUpperCase()}</span> ${msg}`;
    logbox.appendChild(div);
    logbox.scrollTop = logbox.scrollHeight;
    console[type==='err'?'error':(type==='warn'?'warn':'log')](msg);
  }
  const info=(m)=>pushLog('info',m);
  const warn=(m)=>pushLog('warn',m);
  const err =(m)=>pushLog('err', m);

  // ---- 모바일 패널 토글 ----
  const toolbar = document.getElementById('toolbar');
  const fab     = document.getElementById('fab');
  const shade   = document.getElementById('shade');
  function openToolbar(open){
    if(open){ toolbar.classList.add('open'); shade.style.display='block'; }
    else    { toolbar.classList.remove('open'); shade.style.display='none'; }
  }
  fab.addEventListener('click', ()=> openToolbar(!toolbar.classList.contains('open')));
  shade.addEventListener('click', ()=> openToolbar(false));

  // ---- 지도 초기화 ----
  if(!window.ol){ err('OpenLayers 로드 실패'); return; }
  info('OpenLayers loaded\nhttps://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js');

  const view = new ol.View({ center: ol.proj.fromLonLat(FALLBACK_CENTER), zoom: 14 });

  const baseOSM = new ol.layer.Tile({ source: new ol.source.OSM(), zIndex: 0 });
  const map = new ol.Map({ target: 'map', layers: [ baseOSM ], view });

  // ---- 현재 위치 + 반경원 ----
  const personSVG = `
  <svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'>
    <circle cx='20' cy='20' r='20' fill='#1f2937'/>
    <path d='M20 10a5 5 0 110 10 5 5 0 010-10zm0 12c6 0 10 3 10 7v1H10v-1c0-4 4-7 10-7z' fill='#60a5fa'/>
  </svg>`.trim();
  const meStyle = new ol.style.Style({ image: new ol.style.Icon({ src: 'data:image/svg+xml;utf8,'+encodeURIComponent(personSVG), anchor:[0.5,0.5] })});
  const meSource = new ol.source.Vector();
  const meLayer  = new ol.layer.Vector({ source: meSource, zIndex: 90 });
  map.addLayer(meLayer);

  let radiusKm = RADIUS_KM_DEFAULT;
  document.getElementById('radius-km').textContent = radiusKm+' km';
  function drawMe(lon,lat){
    meSource.clear();
    const p3857 = ol.proj.fromLonLat([lon,lat]);
    meSource.addFeature(new ol.Feature({ geometry: new ol.geom.Point(p3857), style: meStyle })).getStyle = ()=>meStyle;

    const r = radiusKm*1000;
    const circle = ol.geom.Polygon.circular(ol.proj.get('EPSG:3857'), p3857, r, 64);
    const cf = new ol.Feature(circle);
    cf.setStyle(new ol.style.Style({
      stroke: new ol.style.Stroke({ color:'#60a5fa', width:2 }),
      fill:   new ol.style.Fill({ color:'rgba(96,165,250,0.10)' })
    }));
    meSource.addFeature(cf);
  }

  // ---- 더미 주차장 + 클러스터 ----
  const P_SVG = `<svg xmlns='http://www.w3.org/2000/svg' width='34' height='34' viewBox='0 0 36 36'>
    <circle cx='18' cy='18' r='16' fill='#22c55e'/>
    <text x='18' y='22' font-size='16' text-anchor='middle' fill='#0b1220' font-weight='700'>P</text>
  </svg>`;
  const iconP = new ol.style.Icon({ src: 'data:image/svg+xml;utf8,'+encodeURIComponent(P_SVG), anchor:[0.5,0.5] });
  const parkingRaw = new ol.source.Vector();
  const cluster = new ol.source.Cluster({ distance: 40, source: parkingRaw });
  const parkingLayer = new ol.layer.Vector({
    source: cluster, zIndex: 80,
    style: (feature)=>{
      const size = feature.get('features').length;
      if(size===1) return new ol.style.Style({ image: iconP });
      const radius = Math.max(16, Math.min(28, 10 + Math.log(size)*6));
      return new ol.style.Style({
        image: new ol.style.Circle({
          radius, fill: new ol.style.Fill({ color:'#22c55e' }),
          stroke: new ol.style.Stroke({ color:'#065f46', width:2 })
        }),
        text: new ol.style.Text({ text:String(size), fill:new ol.style.Fill({color:'#062c22'}), font:'600 12px system-ui,sans-serif' })
      });
    }
  });
  map.addLayer(parkingLayer);

  function seedParkingAround(lon,lat,count=1000, radiusMeters=3000){
    parkingRaw.clear();
    const center = ol.proj.fromLonLat([lon,lat]);
    for(let i=0;i<count;i++){
      const t = 2*Math.PI*Math.random();
      const u = Math.random()+Math.random();
      const r = (u>1?2-u:u)*radiusMeters;
      const p = [center[0]+Math.cos(t)*r, center[1]+Math.sin(t)*r];
      const f = new ol.Feature(new ol.geom.Point(p));
      f.set('name', `더미주차장 #${i+1}`);
      f.set('type', ['노상','노외','부설'][Math.floor(Math.random()*3)]);
      parkingRaw.addFeature(f);
    }
    info(`seeded\n현재 위치 기준 @ ${lon.toFixed(5)}, ${lat.toFixed(5)}`);
  }

  // ---- 팝업 ----
  const popup = document.createElement('div');
  popup.className = 'popup'; popup.style.display = 'none';
  popup.innerHTML = `<button class="close" title="닫기">×</button><div class="title"></div><div class="body" style="font-size:13px"></div>`;
  document.body.appendChild(popup);
  popup.querySelector('.close').addEventListener('click', ()=> popup.style.display='none');
  const overlay = new ol.Overlay({ element: popup, positioning:'bottom-center', stopEvent:true, offset:[0,-10] });
  map.addOverlay(overlay);
  map.on('singleclick', (evt)=>{
    const features = map.getFeaturesAtPixel(evt.pixel);
    if(!features?.length){ popup.style.display='none'; return; }
    const f = features[0];
    const target = (f.get('features')||[f])[0];
    const coord = target.getGeometry().getCoordinates();
    overlay.setPosition(coord);
    popup.querySelector('.title').textContent = target.get('name') || '주차장';
    popup.querySelector('.body').innerHTML = `형태: <b>${target.get('type')||'-'}</b><br/>좌표: <small>${ol.proj.toLonLat(coord).map(v=>v.toFixed(5)).join(', ')}</small>`;
    popup.style.display='block';
  });

  // ---- 행정경계: WFS 우선, 실패 시 WMS 폴백 ----
  function wfsUrl(typeName, extent3857){
    const q = new URLSearchParams({
      service: 'WFS', request: 'GetFeature', version: '1.1.0',
      typeName, srsName: 'EPSG:3857',
      bbox: `${extent3857.join(',')},EPSG:3857`,
      output: 'json',
      exceptions: 'application/json',
      key: VW_KEY, domain: VW_DOMAIN
    });
    const u = `https://api.vworld.kr/req/wfs?${q.toString()}`;
    info(`WFS request\n${u}`);
    return u;
  }
  function makeBoundaryLayer(name, color, width){
    const source = new ol.source.Vector({
      format: new ol.format.GeoJSON(),
      url: (extent)=> wfsUrl(name, extent),
      strategy: ol.loadingstrategy.bbox
    });
    const vector = new ol.layer.Vector({
      source,
      style: new ol.style.Style({ stroke: new ol.style.Stroke({ color, width }) }),
      zIndex: 50
    });
    source.on('featuresloaderror', ()=>{
      err(`WFS ${name} load error → WMS로 폴백`);
      const wms = new ol.layer.Tile({
        source: new ol.source.TileWMS({
          url: 'https://api.vworld.kr/req/wms',
          crossOrigin: 'anonymous', serverType: 'geoserver',
          params: {
            SERVICE:'WMS', VERSION:'1.3.0', REQUEST:'GetMap',
            FORMAT:'image/png', TRANSPARENT:true, CRS:'EPSG:3857',
            LAYERS:name, STYLES:'', key: VW_KEY, domain: VW_DOMAIN
          }
        }),
        zIndex: 40, opacity:.9
      });
      map.addLayer(wms);
    });
    return vector;
  }
  const lyrSido = makeBoundaryLayer('lt_c_adsido', '#ef4444', 2.5);
  const lyrSigg = makeBoundaryLayer('lt_c_adsigg', '#ef4444', 1.8);
  const lyrEmd  = makeBoundaryLayer('lt_c_ademd',  '#ef4444', 1.2);
  map.addLayer(lyrSido); map.addLayer(lyrSigg); map.addLayer(lyrEmd);

  // 체크박스 토글
  document.getElementById('chk-sido').addEventListener('change', e=>lyrSido.setVisible(e.target.checked));
  document.getElementById('chk-sigg').addEventListener('change', e=>lyrSigg.setVisible(e.target.checked));
  document.getElementById('chk-emd' ).addEventListener('change', e=>lyrEmd .setVisible(e.target.checked));
  document.getElementById('chk-dummy').addEventListener('change', e=>parkingLayer.setVisible(e.target.checked));

  // ---- 현재위치 자동 ----
  function centerAndSeed(lon,lat){
    drawMe(lon,lat);
    view.animate({center: ol.proj.fromLonLat([lon,lat]), zoom: 14, duration: 300});
    seedParkingAround(lon,lat,1000, radiusKm*1000);
  }
  (function setGeolocation(){
    if(!navigator.geolocation){
      warn('Geolocation 미지원 → 김천 기준 시작');
      info(`seeded\n김천 기준 시작 @ ${FALLBACK_CENTER[0].toFixed(5)}, ${FALLBACK_CENTER[1].toFixed(5)}`);
      centerAndSeed(FALLBACK_CENTER[0], FALLBACK_CENTER[1]);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ const {longitude:lon, latitude:lat} = pos.coords; centerAndSeed(lon,lat); },
      ()=>{ warn('위치획득 실패 → 김천 기준 시작'); info(`seeded\n김천 기준 시작 @ ${FALLBACK_CENTER[0].toFixed(5)}, ${FALLBACK_CENTER[1].toFixed(5)}`); centerAndSeed(FALLBACK_CENTER[0], FALLBACK_CENTER[1]); },
      { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
    );
  })();
})();
</script>
</body>
</html>