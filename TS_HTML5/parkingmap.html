<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>브이월드 WMS(지도만) + 행정구역 WFS(JSONP) · 에러로그(URL표시)</title>

<!-- OpenLayers 동적 로더 (버전태그 제거, 다중 CDN 폴백) -->
<link id="olcss" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
<script>
(function(){
  const srcs = [
    'https://cdn.jsdelivr.net/npm/ol/dist/ol.js',
    'https://unpkg.com/ol/dist/ol.js',
    'https://cdnjs.cloudflare.com/ajax/libs/ol/latest/ol.js' // 마지막 폴백
  ];
  function load(i=0){
    if(i>=srcs.length){ console.error('OpenLayers load failed'); return; }
    const s=document.createElement('script');
    // 캐시 강제 회피(태블릿/웹뷰 강력 새로고침 안됨 이슈 대응)
    s.src = srcs[i] + '?_=' + Date.now();
    s.async=false; s.defer=false; s.crossOrigin='anonymous';
    s.onload=()=>{ if(!window.ol) return load(i+1); };
    s.onerror=()=>load(i+1);
    document.head.appendChild(s);
  }
  load();
})();
</script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb;
    --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  /* 좌측 패널(간결: 베이스맵/경계 토글 + 현재위치) */
  .side{
    position:fixed; left:12px; top:12px; bottom:12px; width:340px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}

  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#c7d2fe; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem}
  .chip.active{background:var(--chipOn); color:#fff; border-color:transparent}

  /* 팝업 */
  .ol-popup{
    position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;
    min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto
  }
  .ol-popup:after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)
  }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  /* 오류 로그 도크 + FAB (에러만, URL 표기) */
  .errdock{
    position:fixed; right:12px; bottom:68px; z-index:1000;
    width:min(560px, calc(100% - 24px));
    background:#0f172a; border:1px solid var(--border); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:none; flex-direction:column;
  }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .grow{ flex:1 }
  .errdock .body{
    max-height:38vh; overflow:auto; padding:8px 10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem;
    background:#0b1220
  }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 }
  .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ font-weight:800; margin-right:6px }
  .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }
  .errfab{
    position:fixed; right:12px; bottom:12px; z-index:1001;
    background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.35)
  }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}

  /* 반응형(아이폰/갤럭시/태블릿/웹) */
  @media (max-width:380px){
    .side{ left:8px; right:8px; width:auto; top:8px; bottom:auto; max-height:60vh; overflow:auto }
    .errdock{ left:8px; right:8px; width:auto }
  }
  @media (min-width:381px) and (max-width:480px){
    .side{ left:10px; right:10px; width:auto; top:10px; bottom:auto; max-height:64vh; overflow:auto }
    .errdock{ left:10px; right:10px; width:auto }
  }
  @media (min-width:481px) and (max-width:768px){
    .side{ width:360px }
    .errdock{ width:min(520px, calc(100% - 20px)) }
  }
  @media (min-width:769px) and (max-width:1024px){
    .side{ width:400px }
  }
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 좌측 패널: 베이스맵 + 경계 토글 + 현재위치 -->
<aside class="side">
  <div class="title">
    <div>행정구역 경계 (WFS·JSONP)</div>
    <div class="muted" style="margin-left:auto" id="stat">초기화 중…</div>
  </div>

  <div class="row">
    <div class="muted">베이스맵</div>
    <div class="chipbar" id="baseBar" role="group" aria-label="베이스맵">
      <div class="chip" data-base="blank">Blank</div>
      <div class="chip" data-base="osm">OSM</div>
      <div class="chip" data-base="vworldgray">VWorld Gray</div>
      <div class="chip active" data-base="vworldwms">VWorld WMS</div>
    </div>
  </div>

  <div class="row">
    <div class="muted">경계표시</div>
    <div class="chipbar" id="admBar" role="group" aria-label="행정구역">
      <div class="chip" data-lyr="sido">시·도</div>
      <div class="chip" data-lyr="sigg">시·군·구</div>
      <div class="chip" data-lyr="emd">읍·면·동</div>
      <div class="chip" data-lyr="ri">리</div>
    </div>
  </div>

  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <span class="muted" id="where" style="margin-left:auto"></span>
  </div>
</aside>

<!-- 오류 로그 도크 + FAB (에러만, URL 포함) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div>
    <div class="muted" id="errcount">0건</div>
    <div class="grow"></div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm red" id="clearErr">지우기</button>
    <button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(function(){
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const SRS    = 'EPSG:900913';
  const WMS_API = 'https://api.vworld.kr/req/wms';
  const WFS_API = 'https://api.vworld.kr/req/wfs';

  const $=(s)=>document.querySelector(s);
  const stat = $('#stat');
  const ok   =(m)=> stat.innerHTML = `<span style="color:#10b981">✔</span> ${m}`;
  const warn =(m)=> stat.innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

  /* ===== 오류 로그(에러만) + URL 표시 ===== */
  const ERRUI = (function ensureErrUI(){
    const dock=$('#errdock'), body=$('#errbody'), count=$('#errcount');
    const fab=$('#errFab'), cntFab=$('#errCntFab');
    $('#closeErr').onclick = ()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    $('#clearErr').onclick = ()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
    $('#copyErr').onclick  = async ()=>{
      const txt = Array.from(body.querySelectorAll('.logrow')).map(el=>el.innerText).join('\n');
      try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch(e){}
    };
    fab.onclick = ()=>{
      const opened = dock.classList.toggle('open');
      fab.setAttribute('aria-expanded', String(opened));
    };
    return { dock, body, count, fab, cntFab };
  })();
  const tstr = ()=> new Date().toLocaleTimeString();
  function logErr(title, urlOrMsg, extra){
    const div = document.createElement('div'); div.className='logrow';
    const urlBlock = urlOrMsg ? `<div class="muted" style="margin-left:8px;word-break:break-all">${urlOrMsg}</div>` : '';
    const extraBlock = extra ? `<div class="muted" style="margin-left:8px;white-space:pre-wrap">${extra}</div>` : '';
    div.innerHTML = `<span class="time">[${tstr()}]</span><span class="lvl lvl-ERR">ERR</span><span>${title}</span>${urlBlock}${extraBlock}`;
    ERRUI.body.appendChild(div); ERRUI.body.scrollTop = ERRUI.body.scrollHeight;
    const n = (Number(ERRUI.cntFab.textContent)||0)+1;
    ERRUI.cntFab.textContent = String(n); ERRUI.fab.classList.add('error');
    ERRUI.count.textContent = `${ERRUI.body.querySelectorAll('.logrow').length}건`;
  }
  window.addEventListener('error', (e)=> logErr('window.onerror: '+e.message, '', e.error?.stack||''));
  window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', '', (e.reason&& (e.reason.stack||e.reason.message))||String(e.reason)));

  /* ===== 지도 & 베이스맵 ===== */
  function start(){
    const view = new ol.View({ center: ol.proj.fromLonLat([127.5,36.4]), zoom: 7, minZoom:4, maxZoom:18 });
    const map  = new ol.Map({ target:'map', layers:[], view });

    // VWorld WMS (지도만) - Base 레이어
    const vwWmsBase = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: WMS_API,
        params: {
          SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
          LAYERS:'Base', STYLES:'',
          CRS: SRS, FORMAT:'image/png', TRANSPARENT:false, BGCOLOR:'0xFFFFFF',
          KEY: VW_KEY, DOMAIN: DOMAIN
        },
        crossOrigin:'anonymous'
      }),
      zIndex:0, visible:true
    });
    map.addLayer(vwWmsBase);
    vwWmsBase.getSource().on('tileloaderror', (evt)=>{
      const src = evt?.tile?.getImage?.()?.src;
      logErr('WMS 타일 오류', src||'(이미지 src 미확인)');
    });

    // OSM/Gray (대체 베이스)
    const osm = new ol.layer.Tile({
      source: new ol.source.XYZ({ url:'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png', crossOrigin:'anonymous' }),
      visible:false, zIndex:0
    });
    const vworldGray = new ol.layer.Tile({
      source: new ol.source.XYZ({ url:`https://api.vworld.kr/req/wmts/1.0.0/${VW_KEY}/gray/{z}/{y}/{x}.png`, crossOrigin:'anonymous' }),
      visible:false, zIndex:0
    });
    map.addLayer(osm); map.addLayer(vworldGray);

    function setBase(mode){
      vwWmsBase.setVisible(mode==='vworldwms');
      osm.setVisible(mode==='osm');
      vworldGray.setVisible(mode==='vworldgray');
      if(mode==='blank'){ vwWmsBase.setVisible(false); osm.setVisible(false); vworldGray.setVisible(false); }
    }
    $('#baseBar').addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      chip.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active'); setBase(chip.dataset.base);
    });
    setBase('vworldwms');

    /* ===== WFS(JSONP) ─ 행정경계 4종 ===== */
    // 공통: JSONP 호출
    function jsonp(url, cbname){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src = url;
        s.onerror = ()=>{ s.remove(); reject(new Error('JSONP script_error')); };
        const to = setTimeout(()=>{ s.remove(); reject(new Error('jsonp_timeout')); }, 15000);
        window[cbname] = function(payload){
          clearTimeout(to); s.remove(); try{ resolve(payload); } finally{ delete window[cbname]; }
        };
        document.head.appendChild(s);
      });
    }

    // 공통: URL 빌더(JSONP)  OUTPUT=text/javascript & FORMAT_OPTIONS=callback:<name>
    function buildWfsJsonpUrl(typename, bbox, cbName){
      const p = new URLSearchParams({
        SERVICE:'WFS', REQUEST:'GetFeature', VERSION:'1.1.0',
        TYPENAME: typename,
        SRSNAME: SRS,
        BBOX: bbox.join(','),        // 900913: xmin,ymin,xmax,ymax
        MAXFEATURES:'1000',
        OUTPUT:'text/javascript',
        EXCEPTIONS:'text/xml',
        FORMAT_OPTIONS:`callback:${cbName}`,
        KEY: VW_KEY, DOMAIN: DOMAIN
      });
      return `${WFS_API}?${p.toString()}`;
    }

    // 공통: 로더(뷰 변경 시 화면범위로 갱신)
    function attachJsonpLoader(layerId, typename, src, style, minZoom){
      let reqId=0;
      async function loadForExtent(ext){
        if(view.getZoom()<minZoom){ src.clear(true); return; }
        src.clear(true);
        const cb = `vw_cb_${layerId}_${Date.now()}_${Math.floor(Math.random()*1000)}`;
        const url = buildWfsJsonpUrl(typename, ext, cb);
        try{
          const data = await jsonp(url, cb); // 기대: GeoJSON 객체가 콜백 인자로 전달
          if(!data || data.type!=='FeatureCollection'){
            logErr(`WFS(JSONP) 파싱 실패(${typename})`, url, typeof data==='string'?data:JSON.stringify(data));
            return;
          }
          const fmt = new ol.format.GeoJSON();
          const feats = fmt.readFeatures(data, { dataProjection:SRS, featureProjection:'EPSG:3857' });
          if(feats?.length) src.addFeatures(feats);
        }catch(e){
          logErr(`WFS 로드 실패(${typename})`, url, e.message||String(e));
        }
      }
      // 최초 + moveend 디바운스
      let timer=null;
      function refresh(){
        if(timer) cancelAnimationFrame(timer);
        timer = requestAnimationFrame(()=> {
          const ext = view.calculateExtent(map.getSize()); // 3857 == 900913
          loadForExtent(ext.slice(0));
        });
      }
      map.on('moveend', refresh);
      refresh();
    }

    // 스타일: 윤곽선만
    const strokeSido = new ol.style.Style({ stroke:new ol.style.Stroke({color:[59,130,246,1], width:2}) });
    const strokeSigg = new ol.style.Style({ stroke:new ol.style.Stroke({color:[34,197,94,1], width:1.6}) });
    const strokeEmd  = new ol.style.Style({ stroke:new ol.style.Stroke({color:[234,179,8,1],  width:1.2}) });
    const strokeRi   = new ol.style.Style({ stroke:new ol.style.Stroke({color:[239,68,68,1],  width:1.0}) });

    // 레이어 4종 (초기 숨김, 토글로 표시)
    const srcSido = new ol.source.Vector({wrapX:true});
    const srcSigg = new ol.source.Vector({wrapX:true});
    const srcEmd  = new ol.source.Vector({wrapX:true});
    const srcRi   = new ol.source.Vector({wrapX:true});

    const lyrSido = new ol.layer.Vector({ source:srcSido, style:strokeSido, zIndex:100, visible:false });
    const lyrSigg = new ol.layer.Vector({ source:srcSigg, style:strokeSigg, zIndex:110, visible:false });
    const lyrEmd  = new ol.layer.Vector({ source:srcEmd,  style:strokeEmd,  zIndex:120, visible:false });
    const lyrRi   = new ol.layer.Vector({ source:srcRi,   style:strokeRi,   zIndex:130, visible:false });
    map.addLayer(lyrSido); map.addLayer(lyrSigg); map.addLayer(lyrEmd); map.addLayer(lyrRi);

    // JSONP 로더 장착(줌 임계값)
    attachJsonpLoader('sido','lt_c_adsido_info', srcSido, strokeSido, 4);
    attachJsonpLoader('sigg','lt_c_adsigg_info', srcSigg, strokeSigg, 7);
    attachJsonpLoader('emd', 'lt_c_ademd_info',  srcEmd,  strokeEmd,  10);
    attachJsonpLoader('ri',  'lt_c_adri_info',   srcRi,   strokeRi,   12);

    // 토글 버튼
    $('#admBar').addEventListener('click', (e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      chip.classList.toggle('active');
      const on = chip.classList.contains('active');
      const id = chip.dataset.lyr;
      ({sido:lyrSido, sigg:lyrSigg, emd:lyrEmd, ri:lyrRi}[id]).setVisible(on);
    });

    /* ===== 피처 클릭 팝업(속성 표시) ===== */
    const popupEl = document.createElement('div');
    popupEl.className='ol-popup';
    popupEl.innerHTML = `<button class="x" aria-label="닫기">×</button><div class="tit">정보</div><div class="sub2" id="pattrs"></div>`;
    const overlay = new ol.Overlay({ element: popupEl, positioning:'bottom-center', stopEvent:true, offset:[0,-14] });
    map.addOverlay(overlay);
    function closePopup(){ overlay.setPosition(undefined); }
    popupEl.querySelector('.x').addEventListener('click', closePopup);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePopup(); });

    function labelFromProps(p){
      const keys = Object.keys(p);
      const prefer = ['sidonm','sido_nm','sido_name','ctp_kor_nm','sigg_nm','sigg_name','sgg_nm','adm_nm','emd_kor_nm','emd_nm','ri_kor_nm','ri_nm','name'];
      for(const k of prefer){ if(k in p) return `${k}: ${p[k]}`; }
      // fallback: 임의의 2~3개 속성 프리뷰
      const pick = keys.filter(k=>k!=='geometry').slice(0,3).map(k=>`${k}: ${p[k]}`).join(' · ');
      return pick || '(속성 없음)';
    }

    map.on('singleclick', (evt)=>{
      let found=false;
      map.forEachFeatureAtPixel(evt.pixel, (feat, layer)=>{
        if([lyrSido,lyrSigg,lyrEmd,lyrRi].includes(layer)){
          const p = feat.getProperties();
          const html = Object.entries(p)
            .filter(([k])=>k!=='geometry')
            .map(([k,v])=>`<div><b>${k}</b>: ${v}</div>`).join('');
          popupEl.querySelector('.tit').textContent = '속성 정보';
          popupEl.querySelector('#pattrs').innerHTML = html || '(없음)';
          overlay.setPosition(evt.coordinate);
          found=true; return true;
        }
      }, {hitTolerance:6});
      if(!found) closePopup();
    });

    /* ===== 현재 위치 ===== */
    function setWhere(lng,lat){ $('#where').textContent = `${lng.toFixed(5)}, ${lat.toFixed(5)}`; }
    $('#locBtn').addEventListener('click', ()=>{
      const okHttps = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!okHttps || !navigator.geolocation){ warn('위치 권한/환경 문제(https 필요)'); return; }
      navigator.geolocation.getCurrentPosition(
        p=>{
          const lng=p.coords.longitude, lat=p.coords.latitude;
          setWhere(lng,lat);
          const c=ol.proj.fromLonLat([lng,lat]);
          view.animate({center:c, zoom:13, duration:350});
        },
        e=> logErr('geolocation 실패', '', `${e.code} ${e.message}`),
        {enableHighAccuracy:true,timeout:9000,maximumAge:3000}
      );
    });

    ok('준비 완료: WMS(지도만) + WFS(JSONP) 경계');
  }

  // OL 준비 후 시작
  function domReady(cb){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', cb); else cb(); }
  (function waitOL(){
    if(window.ol && typeof ol.Map==='function'){ domReady(start); return; }
    setTimeout(waitOL, 60);
  })();
})();
</script>
</body>
</html>