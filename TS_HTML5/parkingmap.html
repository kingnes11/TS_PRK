<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>브이월드 cbnd(WMS) + 지적도(WFS lt_c_uq111) 폴백 · 리스트/로그 · OL 10.6.1</title>

<!-- OL 동적 로더 -->
<script>
(function(){
  const basePath = location.pathname.replace(/\/[^/]*$/, '');
  const cssSrcs = [
    basePath + '/vendor/ol/10.6.1/ol.css',
    '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.css',
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.css',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css',
    'https://unpkg.com/ol@10.6.1/ol.css'
  ];
  const jsSrcs = [
    basePath + '/vendor/ol/10.6.1/ol.js',
    '/TS_PRK/TS_HTML5/vendor/ol/10.6.1/ol.js',
    'https://cdnjs.cloudflare.com/ajax/libs/ol/10.6.1/ol.js',
    'https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js',
    'https://unpkg.com/ol@10.6.1/dist/ol.js'
  ];
  function loadCSS(list,i=0){ if(i>=list.length) return; const l=document.createElement('link'); l.rel='stylesheet'; l.href=list[i]; l.onerror=()=>loadCSS(list,i+1); document.head.appendChild(l); }
  function loadJS(list,i,resolve,reject){
    if(i>=list.length) return reject(new Error('OpenLayers JS load failed (all sources)'));
    const s=document.createElement('script'); s.src=list[i]; s.defer=false; s.async=false; s.crossOrigin='anonymous';
    let done=false; const next=()=>{ if(done) return; done=true; s.remove(); loadJS(list,i+1,resolve,reject); };
    s.onload=()=>{ setTimeout(()=>{ (window.ol && typeof ol.Map==='function') ? (done=true, resolve(list[i])) : next(); },0); };
    s.onerror=next; document.head.appendChild(s);
  }
  loadCSS(cssSrcs,0);
  window.OL_READY=new Promise((resolve,reject)=>{ if(window.ol&&typeof ol.Map==='function'){ resolve('(preloaded)'); return; } loadJS(jsSrcs,0,resolve,reject); });
})();
</script>

<style>
  :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#2563eb; --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  /* 좌측 패널(유지 + 모바일 대응) */
  .side{
    position:fixed; left:12px; top:12px; bottom:12px; width:360px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media (max-width:960px){ .side{ right:12px; width:auto } }
  @media (max-width:600px){
    .side{ width:calc(100% - 24px); left:12px; right:12px; top:env(safe-area-inset-top,12px); bottom:calc(56px + env(safe-area-inset-bottom,12px)); }
  }

  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800; display:flex; gap:10px; align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent}
  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:var(--chip); border:1px solid var(--border); color:#c7d2fe; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.92rem}
  .chip.active{background:var(--chipOn); color:#fff; border-color:transparent}

  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; flex:1; min-height:140px; background:#0c1530}
  .item{padding:10px 12px; border-bottom:1px solid var(--border); cursor:pointer; display:grid; gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent); outline-offset:-2px; background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted); font-size:.92rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}
  .dist{color:#9ca3af}

  /* 팝업 */
  .ol-popup{ position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto }
  .ol-popup:after{ content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb) }
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}

  /* 오류 로그 도크 + FAB(유지) */
  .errdock{ position:fixed; right:12px; bottom:68px; z-index:1000; width:min(560px, calc(100% - 24px)); background:#0f172a; border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; flex-direction:column; }
  .errdock.open{ display:flex }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 } .errdock .grow{ flex:1 }
  .errdock .body{ max-height:38vh; overflow:auto; padding:8px 10px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.86rem; background:#0b1220 }
  .logrow{ border-bottom:1px dashed #1d2741; padding:4px 0 } .logrow:last-child{ border-bottom:0 }
  .time{ color:#9ca3af; margin-right:6px } .lvl{ font-weight:800; margin-right:6px }
  .lvl-INFO{ color:#93c5fd } .lvl-WARN{ color:#fbbf24 } .lvl-ERR{ color:#fca5a5 }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .btnsm.red{ background:#391d1d; border-color:#5c2a2a; color:#fecaca }
  .errfab{ position:fixed; right:12px; bottom:12px; z-index:1001; background:#1e293b; color:#e5e7eb; border:1px solid #334155; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px; box-shadow:0 8px 20px rgba(0,0,0,.35) }
  .errfab .dot{width:10px;height:10px;border-radius:50%;background:#10b981}
  .errfab.error .dot{background:#ef4444}
  .errfab .cnt{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:.82rem;display:none}
  .errfab.error .cnt{display:inline-block}
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<aside class="side">
  <div class="row title">
    <div>주차장(반경 <b id="radiusLabel">5</b>km)</div>
    <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
  </div>
  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn ghost" id="fitBtn">전체 보기</button>
    <span id="stat" class="muted" style="margin-left:auto">초기화 중…</span>
  </div>
  <div class="chipbar" id="typeBar" role="group" aria-label="주차장 형태 필터">
    <div class="chip active" data-type="">전체</div><div class="chip" data-type="노상">노상</div><div class="chip" data-type="노외">노외</div><div class="chip" data-type="부설">부설</div>
  </div>
  <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
</aside>

<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그</div><div class="muted" id="errcount">0건</div><div class="grow"></div>
    <button class="btnsm" id="copyErr">복사</button><button class="btnsm red" id="clearErr">지우기</button><button class="btnsm" id="closeErr">닫기</button>
  </div>
  <div class="body" id="errbody"></div>
</section>
<button class="errfab" id="errFab" aria-controls="errdock" aria-expanded="false" title="오류 로그 열기">
  <span class="dot" aria-hidden="true"></span><span>로그</span><span class="cnt" id="errCntFab">0</span>
</button>

<script>
(function(){
  /* ===== 설정 ===== */
  const VW_KEY = 'CF9A371B-35A6-3822-8315-6592C8342E82';
  const DOMAIN = 'kingnes11.github.io';
  const DEMO_N = 800;
  const RADIUS_KM = 5.0;
  document.getElementById('radiusLabel').textContent = RADIUS_KM;

  const $=(s)=>document.querySelector(s);
  const stat=$('#stat');
  const ok=(m)=> stat.innerHTML=`<span style="color:#10b981">✔</span> ${m}`;
  const warn=(m)=> stat.innerHTML=`<span style="color:#f59e0b">!</span> ${m}`;

  /* ===== 로그 ===== */
  const ERRUI=(function(){
    const dock=$('#errdock'), body=$('#errbody'), count=$('#errcount'), fab=$('#errFab'), cntFab=$('#errCntFab');
    $('#closeErr').onclick=()=>{ dock.classList.remove('open'); fab.setAttribute('aria-expanded','false'); };
    $('#clearErr').onclick=()=>{ body.innerHTML=''; count.textContent='0건'; cntFab.textContent='0'; fab.classList.remove('error'); };
    $('#copyErr').onclick=async()=>{ const t=[...body.querySelectorAll('.logrow')].map(el=>el.innerText).join('\n'); try{ await navigator.clipboard.writeText(t||'(로그 없음)'); }catch(e){} };
    fab.onclick=()=>{ const opened=dock.classList.toggle('open'); fab.setAttribute('aria-expanded',String(opened)); };
    return {dock,body,count,fab,cntFab};
  })();
  const logs=[]; let autoOpened=false;
  const tstr=()=>new Date().toLocaleTimeString();
  function appendRow(level,msg,extra){
    const d=document.createElement('div'); d.className='logrow';
    d.innerHTML=`<span class="time">[${tstr()}]</span><span class="lvl lvl-${level}">${level}</span><span>${msg}</span>`+(extra?`<div class="muted" style="margin-left:8px;white-space:pre-wrap">${extra}</div>`:'');
    ERRUI.body.appendChild(d); ERRUI.body.scrollTop=ERRUI.body.scrollHeight;
  }
  function log(level,msg,detail){
    const text=typeof detail==='string'?detail:(detail?(detail.stack||JSON.stringify(detail)):'');
    logs.push({t:Date.now(),level,msg,detail:text}); appendRow(level,msg,text);
    const errCnt=logs.filter(x=>x.level==='ERR').length;
    ERRUI.count.textContent=`${logs.length}건`; ERRUI.cntFab.textContent=String(errCnt);
    if(errCnt>0) ERRUI.fab.classList.add('error');
    if(level==='ERR'&&!autoOpened){ ERRUI.dock.classList.add('open'); ERRUI.fab.setAttribute('aria-expanded','true'); autoOpened=true; }
  }
  const logInfo=(m,d)=>log('INFO',m,d), logWarn=(m,d)=>log('WARN',m,d), logErr=(m,d)=>log('ERR',m,d);
  window.addEventListener('error',e=>logErr('window.onerror: '+e.message,e.error||e));
  window.addEventListener('unhandledrejection',e=>logErr('unhandledrejection',e.reason||e));

  /* ===== 앱 시작 ===== */
  function startApp(olSrc){
    logInfo('OpenLayers loaded', olSrc); ok('OpenLayers 10.6.1 로드 완료');

    /* --- 베이스맵 --- */
    const vwBase=new ol.layer.Tile({ source:new ol.source.XYZ({ url:`https://api.vworld.kr/req/wmts/1.0.0/${VW_KEY}/Base/{z}/{y}/{x}.png?domain=${DOMAIN}`, maxZoom:18, minZoom:5 }), zIndex:0, visible:true });
    const osm=new ol.layer.Tile({ source:new ol.source.OSM(), zIndex:0, visible:false });
    const map=new ol.Map({ target:'map', layers:[vwBase,osm], view:new ol.View({ center:ol.proj.fromLonLat([127,37]), zoom:7, maxZoom:18, minZoom:5 }) });
    let switched=false; function switchToOSM(r){ if(switched) return; switched=true; vwBase.setVisible(false); osm.setVisible(true); warn(`브이월드 타일 문제(${r}) → OSM로 전환`); logWarn('OSM fallback activated',r); }
    vwBase.getSource().on('tileloaderror',()=>{ logErr('WMTS tile load error'); switchToOSM('tileloaderror'); });

    /* --- cbnd WMS → 실패 시 WFS --- */
    const WMS_PARAMS_LOWER = {
      SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
      LAYERS:'lp_pa_cbnd_bonbun,lp_pa_cbnd_bubun',
      STYLES:'lp_pa_cbnd_bonbun_line,lp_pa_cbnd_bubun_line',
      CRS:'EPSG:900913', FORMAT:'image/png',
      TRANSPARENT:false, BGCOLOR:'0xFFFFFF',
      EXCEPTIONS:'text/xml', KEY:VW_KEY, DOMAIN:DOMAIN
    };
    const WMS_PARAMS_UPPER = {
      SERVICE:'WMS', REQUEST:'GetMap', VERSION:'1.3.0',
      LAYERS:'LP_PA_CBND_BONBUN,LP_PA_CBND_BUBUN',
      STYLES:'LP_PA_CBND_BONBUN_LINE,LP_PA_CBND_BUBUN_LINE',
      CRS:'EPSG:900913', FORMAT:'image/png',
      TRANSPARENT:false, BGCOLOR:'0xFFFFFF',
      EXCEPTIONS:'text/xml', KEY:VW_KEY, DOMAIN:DOMAIN
    };

    const cbndWmsSource=new ol.source.TileWMS({ url:'https://api.vworld.kr/req/wms', params:{...WMS_PARAMS_LOWER}, crossOrigin:'anonymous' });
    const cbndWms=new ol.layer.Tile({ source:cbndWmsSource, opacity:0.9, visible:true, zIndex:200 });
    map.addLayer(cbndWms);

    let wmsRetryCase=0;
    cbndWmsSource.on('tileloaderror', ()=>{
      if(wmsRetryCase===0){
        wmsRetryCase=1;
        logWarn('WMS cbnd 타일오류 – 대문자 LAYER/STYLE 재시도');
        cbndWmsSource.updateParams({...WMS_PARAMS_UPPER});
        return;
      }
      logErr('WMS cbnd tile error → WFS(JS) 폴백');
      cbndWms.setVisible(false);
      activateCbndWFS();
    });

    /* --- WFS 3-스텝 로더 (lt_c_uq111) --- */
    const gml2=new ol.format.GML2({ srsName:'EPSG:900913', featureType:'LT_C_UQ111', geometryName:'ag_geom' });
    const wfsFormat=new ol.format.WFS({ gmlFormat:gml2 });
    const geojson=new ol.format.GeoJSON();
    const proj=map.getView().getProjection();

    function bbox3857ToQS(ext){ return ext.join(','); }
    function buildReqWFS_GML2(ext){
      const p=new URLSearchParams({
        SERVICE:'WFS', REQUEST:'GetFeature',
        TYPENAME:'lt_c_uq111',
        BBOX:bbox3857ToQS(ext),
        PROPERTYNAME:'mnum,sido_cd,sigungu_cd,dyear,dnum,ucode,bon_bun,bu_bun,uname,sido_name,sigg_name,ag_geom',
        VERSION:'1.1.0', MAXFEATURES:'40',
        SRSNAME:'EPSG:900913', OUTPUT:'GML2',
        EXCEPTIONS:'text/xml',
        KEY:VW_KEY, key:VW_KEY, DOMAIN:DOMAIN, domain:DOMAIN
      });
      return 'https://api.vworld.kr/req/wfs?'+p.toString();
    }
    function buildReqWFS_GeoJSON(ext){
      const p=new URLSearchParams({
        SERVICE:'WFS', REQUEST:'GetFeature',
        TYPENAME:'lt_c_uq111',
        BBOX:bbox3857ToQS(ext),
        PROPERTYNAME:'mnum,sido_cd,sigungu_cd,dyear,dnum,ucode,bon_bun,bu_bun,uname,sido_name,sigg_name,ag_geom',
        VERSION:'1.1.0', MAXFEATURES:'40',
        SRSNAME:'EPSG:900913', OUTPUT:'application/json',
        EXCEPTIONS:'text/xml',
        KEY:VW_KEY, key:VW_KEY, DOMAIN:DOMAIN, domain:DOMAIN
      });
      return 'https://api.vworld.kr/req/wfs?'+p.toString();
    }
    function buildJSWFS_JSONP(ext, cbName){
      const p=new URLSearchParams({
        SERVICE:'WFS', REQUEST:'GetFeature',
        TYPENAME:'LT_C_UQ111', // js/wfs.do는 대문자 권장
        BBOX:bbox3857ToQS(ext),
        VERSION:'1.1.0', MAXFEATURES:'40',
        SRSNAME:'EPSG:900913',
        PROPERTYNAME:'mnum,std_sggcd,admin_cd,sido_cd,sigungu_cd,dyear,ag_geom', // 가이드 예시 호환
        OUTPUT:'application/json',
        EXCEPTIONS:'text/xml',
        FORMAT_OPTIONS:`callback:${cbName}`,
        APIKEY:VW_KEY, DOMAIN:DOMAIN
      });
      return 'https://map.vworld.kr/js/wfs.do?'+p.toString();
    }

    async function fetchText(url){
      try{
        const res=await fetch(url,{mode:'cors',credentials:'omit'});
        const txt=await res.text();
        if(!res.ok){ logErr('WFS HTTP error', `url=${url}\nstatus=${res.status}\n${txt.slice(0,300)}`); throw new Error('http_'+res.status); }
        return txt;
      }catch(e){ logErr('WFS 네트워크/CORS 오류', `${url}\n${e&&e.message||e}`); throw e; }
    }

    function jsonp(url, cbName, timeoutMs=10000){
      return new Promise((resolve,reject)=>{
        let done=false, timer=setTimeout(()=>{ if(done) return; done=true; cleanup(); reject(new Error('jsonp_timeout')); },timeoutMs);
        function cleanup(){ try{ delete window[cbName]; }catch(_){ window[cbName]=undefined; } if(s&&s.parentNode) s.parentNode.removeChild(s); clearTimeout(timer); }
        window[cbName]=(payload)=>{ if(done) return; done=true; cleanup(); resolve(payload); };
        const s=document.createElement('script'); s.src=url; s.onerror=()=>{ if(done) return; done=true; cleanup(); reject(new Error('jsonp_error')); };
        document.head.appendChild(s);
      });
    }

    let cbndWfsLayer=null;
    function activateCbndWFS(){
      if(cbndWfsLayer){ cbndWfsLayer.setVisible(true); return; }

      const src=new ol.source.Vector({
        strategy: ol.loadingstrategy.bbox,
        loader: async (extent)=>{
          // 1) req/wfs GML2
          try{
            const u1=buildReqWFS_GML2(extent); logInfo('WFS request(GML2)',u1);
            const xmlTxt=await fetchText(u1);
            const doc=new DOMParser().parseFromString(xmlTxt,'text/xml');
            const exc=doc.querySelector('ServiceException, ExceptionText, ParserError');
            if(exc){ logErr('WFS ServiceException(GML2)', (exc.textContent||'').slice(0,300)); throw new Error('wfs_exception_gml2'); }
            const feats=wfsFormat.readFeatures(doc,{dataProjection:'EPSG:900913', featureProjection:proj});
            if(feats.length){ logInfo(`WFS loaded (GML2): ${feats.length}`); src.addFeatures(feats); return; }
            logWarn('WFS GML2 응답 OK, feature=0'); // 다음 단계로
          }catch(e){ /* 다음 단계로 */ }

          // 2) req/wfs GeoJSON
          try{
            const u2=buildReqWFS_GeoJSON(extent); logInfo('WFS request(GeoJSON)',u2);
            const txt=await fetchText(u2);
            let json; try{ json=JSON.parse(txt); }catch(_){ logErr('GeoJSON parse 실패(텍스트)', txt.slice(0,200)); throw new Error('parse_geojson'); }
            const feats=geojson.readFeatures(json,{dataProjection:'EPSG:900913', featureProjection:proj});
            if(feats.length){ logInfo(`WFS loaded (GeoJSON): ${feats.length}`); src.addFeatures(feats); return; }
            logWarn('WFS GeoJSON 응답 OK, feature=0');
          }catch(e){ /* 다음 단계로 */ }

          // 3) js/wfs.do JSONP (CORS 회피)
          try{
            const cb='__vw_cb_'+Math.random().toString(36).slice(2);
            const u3=buildJSWFS_JSONP(extent, cb); logInfo('WFS request(JSONP)',u3);
            const payload=await jsonp(u3, cb, 10000);
            // payload가 JSON이면 그대로, 문자열이면 XML로 파싱
            if(typeof payload==='string'){
              const doc=new DOMParser().parseFromString(payload,'text/xml');
              const feats=wfsFormat.readFeatures(doc,{dataProjection:'EPSG:900913', featureProjection:proj});
              if(feats.length){ logInfo(`WFS loaded (JSONP/XML): ${feats.length}`); src.addFeatures(feats); return; }
              logWarn('JSONP(XML) OK, feature=0');
            }else if(payload && typeof payload==='object'){
              const feats=geojson.readFeatures(payload,{dataProjection:'EPSG:900913', featureProjection:proj});
              if(feats.length){ logInfo(`WFS loaded (JSONP/GeoJSON): ${feats.length}`); src.addFeatures(feats); return; }
              logWarn('JSONP(GeoJSON) OK, feature=0');
            }else{
              logErr('JSONP 응답 형식 미상', String(payload).slice(0,200));
            }
          }catch(e){
            logErr('WFS lt_c_uq111 load error', (e&&e.message)||e||'Load failed');
          }
        }
      });

      cbndWfsLayer=new ol.layer.Vector({
        source:src,
        style:new ol.style.Style({ stroke:new ol.style.Stroke({color:[239,68,68,0.95], width:2}) }),
        zIndex:300, visible:true
      });
      map.addLayer(cbndWfsLayer);
    }

    /* --- 주차 더미/현재위치(유지) --- */
    const PARK_SVG=`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'><circle cx='18' cy='18' r='16' fill='#2563eb'/><text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text></svg>`;
    const ME_SVG=`<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs><path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/><circle cx='19' cy='12' r='5' fill='#fff'/><path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/></svg>`;
    const stylePark=new ol.style.Style({ image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(PARK_SVG), anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1 }) });
    const styleMe=new ol.style.Style({ image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(ME_SVG), anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction', scale:1 }) });
    const styleCircle=new ol.style.Style({ stroke:new ol.style.Stroke({ color:[239,68,68,0.9], width:2 }), fill:new ol.style.Fill({ color:[239,68,68,0.08] }) });

    const meSrc=new ol.source.Vector(), meLayer=new ol.layer.Vector({source:meSrc, zIndex:120}); map.addLayer(meLayer);
    const rawSrc=new ol.source.Vector();
    const clusterSrc=new ol.source.Cluster({distance:40, minDistance:10, source:rawSrc});
    const clusterLy=new ol.layer.Vector({
      source:clusterSrc,
      style:(feature)=>{ const m=feature.get('features')||[]; const n=m.length;
        if(n>1) return new ol.style.Style({ image:new ol.style.Circle({radius:Math.max(12,Math.min(28,10+Math.log(n)*8)), fill:new ol.style.Fill({color:[37,99,235,0.92]}), stroke:new ol.style.Stroke({color:'#fff',width:2})}), text:new ol.style.Text({text:String(n), fill:new ol.style.Fill({color:'#fff'}), stroke:new ol.style.Stroke({color:'#000',width:3})}) });
        const f=m[0]; return (f && f.getStyle && f.getStyle())||stylePark;
      },
      zIndex:110
    }); map.addLayer(clusterLy);

    const popupEl=document.createElement('div'); popupEl.className='ol-popup';
    popupEl.innerHTML=`<button class="x" aria-label="닫기">×</button><div class="tit"></div><div class="sub2 addr"></div><div class="sub2 meta"></div>`;
    const overlay=new ol.Overlay({element:popupEl,positioning:'bottom-center',stopEvent:true,offset:[0,-14]}); map.addOverlay(overlay);
    const closePopup=()=>overlay.setPosition(undefined); popupEl.querySelector('.x').addEventListener('click',closePopup); document.addEventListener('keydown',e=>{ if(e.key==='Escape') closePopup(); });
    function openPopupForFeature(f,coord){ const p=f.getProperties(); popupEl.querySelector('.tit').textContent=p.nm||'주차장'; popupEl.querySelector('.addr').textContent=p.addr||''; popupEl.querySelector('.meta').textContent=`형태: ${p.type||'-'} · 좌표: ${Number(p.lat||0).toFixed(5)}, ${Number(p.lng||0).toFixed(5)}`; overlay.setPosition(coord); $('#sel').textContent=p.nm||'-'; }
    map.on('singleclick',(evt)=>{ let handled=false; map.forEachFeatureAtPixel(evt.pixel,(feature,layer)=>{ if(layer!==clusterLy) return; const members=feature.get('features')||[]; if(members.length>1){ const ex=ol.extent.createEmpty(); members.forEach(f=>ol.extent.extend(ex,f.getGeometry().getExtent())); map.getView().fit(ex,{duration:250,maxZoom:17,padding:[30,380,30,30]}); } else if(members.length===1){ const f=members[0], c=f.getGeometry().getCoordinates(); openPopupForFeature(f,c); highlightList(f.get('__id')); } handled=true; return true; },{hitTolerance:6}); if(!handled) closePopup(); });

    function haversineKm(a,b){ const R=6371,toRad=d=>d*Math.PI/180, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng), s1=Math.sin(dLat/2), s2=Math.sin(dLng/2), t=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(t)); }
    function generateDummyAround(lng,lat,n=DEMO_N,rKm=RADIUS_KM){ const types=['노상','노외','부설'], rows=[]; for(let i=0;i<n;i++){ const rkm=Math.random()*rKm, ang=Math.random()*Math.PI*2; const dLat=(rkm/111)*Math.sin(ang); const dLng=(rkm/(111*Math.cos(lat*Math.PI/180)))*Math.cos(ang); const y=lat+dLat, x=lng+dLng; const type=types[i%3]; rows.push({id:'DM-'+i, nm:`더미 ${type} 주차장 ${i+1}`, addr:`반경 ${rkm.toFixed(2)}km`, type, lng:x, lat:y}); } return rows.map(r=>({...r, distKm:haversineKm({lng,lat},{lng:r.lng,lat:r.lat})})); }
    function rebuildFeatures(rows){ rawSrc.clear(); const feats=rows.map(r=>{ const c=ol.proj.fromLonLat([r.lng,r.lat]); const f=new ol.Feature({geometry:new ol.geom.Point(c), __id:r.id, ...r}); f.setStyle(stylePark); return f; }); rawSrc.addFeatures(feats); }

    let ROWS_ALL=[], ROWS_VIEW=[], currentType="";
    function buildList(rows){ const listEl=$('#list'), countEl=$('#count'); countEl.textContent=String(rows.length);
      if(rows.length===0){ listEl.innerHTML=`<div class="item"><div class="nm">결과 없음</div><div class="sub">반경 ${RADIUS_KM}km / 형태: ${currentType||'전체'}</div></div>`; return; }
      listEl.innerHTML=rows.map((r,i)=>`<div class="item" data-id="${r.id}" role="option" tabindex="0"><div class="nm">${i+1}. ${r.nm}</div><div class="sub"><span class="badge">${r.type}</span><span class="dist">${r.distKm.toFixed(2)} km</span><span>${r.addr}</span></div></div>`).join('');
      listEl.querySelectorAll('.item').forEach(el=>{ el.addEventListener('click',()=>focusItem(el.dataset.id)); el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ focusItem(el.dataset.id); e.preventDefault(); }}); });
    }
    function highlightList(id){ $('#list').querySelectorAll('.item').forEach(el=>el.classList.toggle('active',el.dataset.id===id)); }
    function focusItem(id){ const r=ROWS_VIEW.find(x=>x.id===id)||ROWS_ALL.find(x=>x.id===id); if(!r) return; const c=ol.proj.fromLonLat([r.lng,r.lat]); map.getView().setCenter(c); map.getView().setZoom(16); openPopupForFeature(new ol.Feature({geometry:new ol.geom.Point(c), ...r}), c); highlightList(id); }
    function applyFilter(){ ROWS_VIEW=ROWS_ALL.filter(r=>!currentType||r.type===currentType).sort((a,b)=>a.distKm-b.distKm); buildList(ROWS_VIEW); rebuildFeatures(ROWS_VIEW); }
    $('#typeBar').addEventListener('click',(e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; chip.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active'); currentType=chip.dataset.type||""; closePopup(); applyFilter(); });

    function setMeAndSeed(lng,lat,msg){ meSrc.clear(); const center=ol.proj.fromLonLat([lng,lat]); const me=new ol.Feature({geometry:new ol.geom.Point(center)}); me.setStyle(styleMe); meSrc.addFeature(me); const circle=new ol.Feature({geometry:new ol.geom.Circle(center,RADIUS_KM*1000)}); circle.setStyle(styleCircle); meSrc.addFeature(circle); ROWS_ALL=generateDummyAround(lng,lat,DEMO_N,RADIUS_KM); applyFilter(); map.getView().setCenter(center); map.getView().setZoom(15); ok(`${msg} · 반경 ${RADIUS_KM}km · 더미 ${DEMO_N}개`); logInfo('seeded',`${msg} @ ${lng.toFixed(5)}, ${lat.toFixed(5)}`); }
    function fitAll(){ const ex=ol.extent.createEmpty(); meSrc.getFeatures().forEach(f=>ol.extent.extend(ex,f.getGeometry().getExtent())); rawSrc.getFeatures().forEach(f=>ol.extent.extend(ex,f.getGeometry().getExtent())); if(!ol.extent.isEmpty(ex)) map.getView().fit(ex,{duration:400,padding:[30,380,30,30],maxZoom:17}); }
    $('#locBtn').addEventListener('click',()=>autoLocate(true)); $('#fitBtn').addEventListener('click',fitAll);

    function autoLocate(fly=false){
      const isSecure=location.protocol==='https:'||['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!isSecure||!navigator.geolocation){ warn('위치 권한/환경 확인 필요'); logWarn('geolocation unsupported or insecure origin',location.origin); return; }
      const opts={enableHighAccuracy:true, maximumAge:5000, timeout:10000};
      navigator.geolocation.getCurrentPosition(
        p=>{ const {longitude:lng, latitude:lat}=p.coords; logInfo('geolocated', JSON.stringify({lng,lat})); setMeAndSeed(lng,lat,'현재 위치 기준'); if(fly){ map.getView().animate({center:ol.proj.fromLonLat([lng,lat]), zoom:15, duration:400}); } },
        err=>{ logErr('getCurrentPosition error', `${err.code} ${err.message}`); warn('위치 가져오기에 실패했습니다'); },
        opts
      );
    }
    autoLocate(false);
  }

  function domReady(cb){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', cb); else cb(); }
  window.OL_READY.then((src)=>domReady(()=>startApp(src))).catch(err=>{ const msg='OpenLayers 10.6.1 로딩 실패 (로컬+CDN 모두 실패)'; warn(msg); logErr(msg,(err&&(err.stack||err.message))||String(err)); });
})();
</script>
</body>
</html>