<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>주차장 지도 · OSM 전용 · 반경 3km</title>

<!-- OpenLayers (cdnjs) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol/6.15.1/ol.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ol/6.15.1/ol.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#2563eb; --accent2:#1d4ed8; --border:#20304f; --chip:#1f2a44; --chipOn:#243a7a;
    --bad:#ef4444; --ok:#10b981;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}

  .status{position:fixed;inset:12px 12px auto 12px;z-index:50;background:#0f172a;border:1px solid var(--border);border-radius:12px;padding:8px 12px;font-size:.92rem;color:var(--muted)}
  .status b{color:#fff}.ok{color:var(--ok)}.bad{color:var(--bad)}

  .layout{display:grid;grid-template-columns:360px 1fr;height:100vh}
  @media (max-width: 960px){
    .layout{grid-template-columns:1fr}
    .side{position:fixed;z-index:30;left:12px;right:12px;top:56px}
    .mapwrap{height:100vh}
  }
  .side{background:var(--panel);border:1px solid var(--border);border-radius:14px;margin:12px;padding:12px;display:flex;flex-direction:column;gap:10px;max-height:calc(100vh - 24px)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .title{font-weight:800;display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .btn{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff}
  .btn.ghost{background:transparent;color:#c7d2fe;border:1px solid var(--border)}
  .chipbar{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--border);color:#c7d2fe;padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none;font-weight:700;font-size:.92rem}
  .chip.active{background:var(--chipOn);color:#fff;border-color:transparent}
  .list{overflow:auto;border:1px solid var(--border);border-radius:12px;flex:1;min-height:140px}
  .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:grid;gap:4px}
  .item:last-child{border-bottom:0}
  .item:hover{background:rgba(37,99,235,.08)}
  .item.active{outline:2px solid var(--accent);outline-offset:-2px;background:rgba(37,99,235,.12)}
  .nm{font-weight:700}
  .sub{color:var(--muted);font-size:.92rem;display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-block;font-size:.78rem;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#12203c}
  .dist{color:#9ca3af}

  .mapwrap{position:relative}
  #map{position:absolute;inset:0}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:40;background:#111827;color:#fff;border:1px solid #374151;padding:10px 12px;border-radius:10px;display:none}

  .ol-popup{position:absolute;background:#fff;color:#111827;border-radius:8px;border:1px solid #e5e7eb;min-width:230px;padding:10px 12px;transform:translate(-50%,-110%);box-shadow:0 10px 20px rgba(0,0,0,.25);pointer-events:auto}
  .ol-popup:after{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-10px;width:0;height:0;border:10px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 #e5e7eb)}
  .ol-popup .tit{font-weight:800;margin-right:26px}
  .ol-popup .sub2{color:#4b5563;font-size:.9rem}
  .ol-popup .x{position:absolute;right:6px;top:6px;border:0;background:transparent;color:#6b7280;font-size:18px;cursor:pointer;line-height:1}
</style>
</head>
<body>
  <div class="status">상태: <b id="smsg">OSM로 초기화 중… (브이월드 완전 비활성)</b></div>

  <div class="layout">
    <aside class="side">
      <div class="row title">
        <div>주차장(반경 <b>3km</b>)</div>
        <div class="muted" style="margin-left:auto">총 <b id="count">0</b>곳 · 선택: <b id="sel">-</b></div>
      </div>

      <div class="row">
        <button class="btn" id="locBtn">현재 위치</button>
        <button class="btn ghost" id="fitBtn">전체 보기</button>
      </div>

      <div class="chipbar" id="typeBar" role="group" aria-label="주차장 형태 필터">
        <div class="chip active" data-type="">전체</div>
        <div class="chip" data-type="노상">노상</div>
        <div class="chip" data-type="노외">노외</div>
        <div class="chip" data-type="부설">부설</div>
      </div>

      <div id="list" class="list" role="listbox" aria-label="주차장 목록"></div>
    </aside>

    <main class="mapwrap">
      <div id="map" aria-label="지도"></div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ========== 전역/설정 (VWorld 완전 제거) ========== */
const FALLBACK_CENTER = { lng:128.1136, lat:36.1398 }; // 김천(교통안전공단 인근)
const RADIUS_M = 3000; // 3km
const $ = (s)=>document.querySelector(s);
const smsg=$('#smsg'), countEl=$('#count'), selEl=$('#sel'), toast=$('#toast');

let ORIGIN = { ...FALLBACK_CENTER };
let currentType = ""; // '', '노상','노외','부설'
let LIVE = [], DEMO = [], VIEW = [];

let olmap, vectorSrc, clusterSrc, clusterLayer, meLayer, radiusLayer, overlay, popupEl;
let openFeatureId = null;

/* ========== 유틸 ========== */
function logOk(msg){ smsg.innerHTML = `<span class="ok">✔</span> ${msg}`; }
function logInfo(msg){ smsg.textContent = msg; }
function showToast(msg, ms=2000){ toast.textContent=msg; toast.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.style.display='none',ms); }

function km(a,b){ const R=6371,toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const t=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(t)); }
function inferType(name="",category="",addr=""){ if(/노상/.test(name)||/노상/.test(category)) return "노상"; if(/노외|공영|타워|주차타워/.test(name)||/노외|공영|타워/.test(category)) return "노외"; if(/부설|몰|백화점|병원|학교|아파트/.test(name+addr)) return "부설"; return "노외"; }

/* ========== 지도 초기화 (OSM 전용) ========== */
function initMap(){
  const fromLonLat = ol.proj.fromLonLat;
  olmap = new ol.Map({
    target:'map',
    layers:[ new ol.layer.Tile({ source:new ol.source.OSM() }) ],
    view:new ol.View({ center: fromLonLat([ORIGIN.lng, ORIGIN.lat]), zoom: 14 })
  });
  logOk('지도 엔진: OSM');

  vectorSrc   = new ol.source.Vector({ features: [] });
  clusterSrc  = new ol.source.Cluster({ distance: 40, minDistance: 10, source: vectorSrc });

  clusterLayer= new ol.layer.Vector({ source: clusterSrc, style: clusterStyle }); clusterLayer.setZIndex(100);
  meLayer     = new ol.layer.Vector({ source: new ol.source.Vector() });          meLayer.setZIndex(90);
  radiusLayer = new ol.layer.Vector({ source: new ol.source.Vector() });          radiusLayer.setZIndex(20);

  olmap.addLayer(radiusLayer); olmap.addLayer(meLayer); olmap.addLayer(clusterLayer);

  // 팝업
  popupEl = document.createElement('div');
  popupEl.className = 'ol-popup';
  popupEl.innerHTML = `<button class="x" aria-label="닫기">×</button><div class="tit"></div><div class="sub2 addr"></div><div class="sub2 meta"></div>`;
  overlay = new ol.Overlay({ element: popupEl, positioning: 'bottom-center', stopEvent: true, offset: [0,-14] });
  olmap.addOverlay(overlay);
  popupEl.querySelector('.x').addEventListener('click', closePopup);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePopup(); });
  olmap.on('singleclick', (evt)=>{
    let hit=false;
    olmap.forEachFeatureAtPixel(evt.pixel,(feature, layer)=>{
      if(layer!==clusterLayer) return;
      const members = feature.get('features')||[];
      if(members.length>1){
        const ex = ol.extent.createEmpty();
        members.forEach(f => ol.extent.extend(ex, f.getGeometry().getExtent()));
        olmap.getView().fit(ex, { duration:250, maxZoom:17, padding:[40,20,40,380] });
      }else if(members.length===1){
        togglePopupForFeature(members[0], evt.coordinate);
      }
      hit=true; return true;
    },{hitTolerance:6});
    if(!hit) closePopup();
  });

  const c = ol.proj.transform([ORIGIN.lng, ORIGIN.lat], 'EPSG:4326', 'EPSG:3857');
  olmap.getView().setCenter(c); olmap.getView().setZoom(14);
  setTimeout(()=>olmap.updateSize(),0);
}

function closePopup(){ overlay.setPosition(undefined); openFeatureId=null; document.querySelectorAll('.item.active').forEach(el=>el.classList.remove('active')); }
function togglePopupForFeature(f, coord){
  const p = f.getProperties();
  const id = p.__id || p.id || `${p.lng},${p.lat}`;
  if(openFeatureId && openFeatureId===id){ closePopup(); return; }
  popupEl.querySelector('.tit').textContent  = p.nm || '주차장';
  popupEl.querySelector('.addr').textContent = p.addr || '';
  popupEl.querySelector('.meta').textContent = `형태: ${p.type||'주차장'} · 좌표: ${Number(p.lat).toFixed(5)}, ${Number(p.lng).toFixed(5)}`;
  overlay.setPosition(coord);
  openFeatureId = id;
  selEl.textContent = p.nm || '주차장';
  highlightListItem(p.nm);
}

const PARK_ICON_SVG = `
<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
  <circle cx='18' cy='18' r='16' fill='#2563eb'/>
  <text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
</svg>`;
function clusterStyle(feature){
  const size=(feature.get('features')||[]).length;
  if(size>1){
    return new ol.style.Style({
      image:new ol.style.Circle({ radius:Math.max(12, Math.min(28, 10 + Math.log(size)*8)), fill:new ol.style.Fill({color:[37,99,235,0.92]}), stroke:new ol.style.Stroke({color:'#fff',width:2}) }),
      text:new ol.style.Text({ text:String(size), fill:new ol.style.Fill({color:'#fff'}), stroke:new ol.style.Stroke({color:'#000',width:3}) })
    });
  }
  return new ol.style.Style({
    image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(PARK_ICON_SVG.trim()), scale:1.0, anchor:[0.5,0.5], anchorXUnits:'fraction', anchorYUnits:'fraction' })
  });
}

/* ========== 데이터 (데모로 표시) ========== */
function generateDemo(n=60){
  const out=[];
  for(let i=0;i<n;i++){
    const r=(Math.random()*2.6+0.2); const ang=Math.random()*Math.PI*2;
    const dLat=(r/111)*Math.sin(ang); const dLng=(r/(111*Math.cos(ORIGIN.lat*Math.PI/180)))*Math.cos(ang);
    const lat=ORIGIN.lat+dLat, lng=ORIGIN.lng+dLng;
    const types=['노상','노외','부설']; const t=types[i%3];
    out.push({ id:`DEMO-${ORIGIN.lng.toFixed(4)}-${ORIGIN.lat.toFixed(4)}-${i}`, nm:`데모 ${t} 주차장 ${i+1}`, lng, lat, addr:`데모로 ${i+1} (반경 ${r.toFixed(1)}km)`, type:t });
  }
  return out;
}
function loadLive(){ LIVE=[]; recompute(); } // 외부 API 호출 없음

/* ========== 리스트/마커 ========== */
function buildList(rows){
  const list = $('#list');
  if(rows.length===0){
    list.innerHTML = `<div class="item"><div class="nm">결과 없음</div><div class="sub">반경 3km / 형태: ${currentType||'전체'}</div></div>`;
    countEl.textContent = '0'; return;
  }
  list.innerHTML = rows.map((r,i)=>`
    <div class="item" data-id="${r.id}" role="option" tabindex="0">
      <div class="nm">${i+1}. ${r.nm}</div>
      <div class="sub"><span class="badge">${r.type}</span><span class="dist">${r.distKm.toFixed(2)} km</span><span>${r.addr||''}</span></div>
    </div>`).join('');
  countEl.textContent = String(rows.length);
  list.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', ()=> focusItem(el.dataset.id));
    el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ focusItem(el.dataset.id); e.preventDefault(); }});
  });
}
function highlightListItem(name){
  const list=$('#list'); list.querySelectorAll('.item').forEach(el=>el.classList.remove('active'));
  const el=[...list.querySelectorAll('.item')].find(x=>x.querySelector('.nm')?.textContent.includes(name));
  if(el){ el.classList.add('active'); el.scrollIntoView({block:'nearest',behavior:'smooth'}); }
}
function focusItem(id){
  const r = VIEW.find(x=>x.id===id); if(!r) return;
  const coord = ol.proj.transform([r.lng,r.lat],'EPSG:4326','EPSG:3857');
  olmap.getView().setCenter(coord); olmap.getView().setZoom(16);
  const f = vectorSrc.getFeatures().find(ft=>{ const p=ft.getProperties(); const pid=p.__id||p.id||`${p.lng},${p.lat}`; return pid===id; });
  if(f) togglePopupForFeature(f, coord);
  selEl.textContent=r.nm; highlightListItem(r.nm);
}
function rebuildMarkers(rows){
  const feats = rows.map(r=>{
    const coord = ol.proj.transform([r.lng,r.lat],'EPSG:4326','EPSG:3857');
    const f = new ol.Feature({ geometry:new ol.geom.Point(coord) });
    f.setProperties({ __id:r.id, nm:r.nm, addr:r.addr, type:r.type, lng:r.lng, lat:r.lat });
    return f;
  });
  vectorSrc.clear(); vectorSrc.addFeatures(feats);
}
function recompute(){
  const ALL = LIVE.concat(DEMO);
  const within = ALL.map(r=>({ ...r, distKm: km(ORIGIN,{lng:r.lng,lat:r.lat}) }))
                    .filter(r => r.distKm*1000 <= RADIUS_M);
  const rows = within.filter(r=>!currentType || r.type===currentType).sort((a,b)=>a.distKm-b.distKm);
  VIEW=rows; buildList(rows); rebuildMarkers(rows);
}

/* ========== 현재 위치 & 반경 ========== */
function drawOrigin(lng,lat){
  const PERSON_ICON_SVG = `<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs><path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/><circle cx='19' cy='12' r='5' fill='#fff'/><path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/></svg>`;
  const c=ol.proj.transform([lng,lat],'EPSG:4326','EPSG:3857');
  const me=new ol.Feature({ geometry:new ol.geom.Point(c) });
  me.setStyle(new ol.style.Style({ image:new ol.style.Icon({ src:'data:image/svg+xml;utf8,'+encodeURIComponent(PERSON_ICON_SVG.trim()), scale:1.0, anchor:[0.5,1], anchorXUnits:'fraction', anchorYUnits:'fraction' }) }));
  meLayer.getSource().clear(); meLayer.getSource().addFeature(me);

  const circle = new ol.geom.Circle(c, RADIUS_M);
  const feat = new ol.Feature(circle);
  feat.setStyle(new ol.style.Style({ stroke:new ol.style.Stroke({color:[220,38,38,0.9],width:2}), fill:new ol.style.Fill({color:[220,38,38,0.12]}) }));
  radiusLayer.getSource().clear(); radiusLayer.getSource().addFeature(feat);
}
function setOrigin(lng,lat,fly=true){
  ORIGIN={lng,lat}; drawOrigin(lng,lat); DEMO = generateDemo(60);
  if(fly){ const c=ol.proj.transform([lng,lat],'EPSG:4326','EPSG:3857'); olmap.getView().setCenter(c); olmap.getView().setZoom(15); }
  closePopup(); recompute();
}
async function autoLocate(){
  const secureOK = (location.protocol==='https:') || ['localhost','127.0.0.1','::1'].includes(location.hostname);
  if(!secureOK || !navigator.geolocation){ logInfo('현재위치: HTTP 환경 → 기본점 사용'); return; }
  let fixed=false; const opts={enableHighAccuracy:true,maximumAge:5000,timeout:8000};
  const wid = navigator.geolocation.watchPosition(pos=>{ if(fixed) return; fixed=true; navigator.geolocation.clearWatch(wid); setOrigin(pos.coords.longitude,pos.coords.latitude,true); }, ()=>{}, opts);
  navigator.geolocation.getCurrentPosition(pos=>{ if(fixed) return; fixed=true; navigator.geolocation.clearWatch(wid); setOrigin(pos.coords.longitude,pos.coords.latitude,true); }, ()=>{}, opts);
}

/* ========== 타입 칩 ========== */
function initTypeBar(){
  const bar=$('#typeBar');
  bar.addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    bar.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active'); currentType=chip.dataset.type||""; closePopup(); recompute();
  });
}

/* ========== 부트스트랩 ========== */
function bootstrap(){
  initMap();
  setOrigin(ORIGIN.lng, ORIGIN.lat); // 김천 기본점 + 데모 데이터 생성
  initTypeBar();
  autoLocate();                      // 가능 시 현재 위치로 재중심
  loadLive();                        // 외부 호출 없음
  showToast('OSM 지도를 불러왔습니다');
}
document.getElementById('locBtn').addEventListener('click', autoLocate);
document.getElementById('fitBtn').addEventListener('click', ()=>{
  const extent = ol.extent.createEmpty();
  radiusLayer?.getSource()?.getFeatures().forEach(f=> ol.extent.extend(extent, f.getGeometry().getExtent()));
  vectorSrc?.getFeatures()?.forEach(f=> ol.extent.extend(extent, f.getGeometry().getExtent()));
  if(!ol.extent.isEmpty(extent)){ olmap.getView().fit(extent, {duration:400, padding:[40,20,40,380], maxZoom:16}); }
});
document.addEventListener('DOMContentLoaded', bootstrap);

/* 안전장치: 외부로부터 들어오는 미처리 Promise 에러를 조용히 기록 */
window.addEventListener('unhandledrejection', e=>{ console.warn('Unhandled promise', e.reason); });
</script>
</body>
</html>