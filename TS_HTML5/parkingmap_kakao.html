<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>카카오맵: 반경 필터 + 현재위치 팔로우 + 더미10 + 하단리스트</title>

<!-- ✅ Kakao Maps JS: https 명시 + autoload=false -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a1194f70f6ecf2ece7a703a4a07a0876&libraries=services&autoload=false"></script>

<style>
  :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#20304f; --accent:#2563eb; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
  #map{position:fixed;inset:0}

  /* 하단 리스트(bottom sheet) */
  .bottom{
    position:fixed; left:12px; right:12px; bottom:12px; z-index:30;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 10px 12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35); display:flex; flex-direction:column; gap:8px;
  }
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .title{font-weight:800}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border); background:transparent; color:#c7d2fe; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.min{padding:6px 10px}
  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{ background:#152347; border:1px solid var(--border); color:#c7d2fe; padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:.9rem }
  .chip.on{ background:#1d3a7a; color:#fff; border-color:transparent }

  /* 2열 그리드 카드 + 스크롤(‘2행’만 보이도록 동적 제한) */
  .list{overflow:auto; border:1px solid var(--border); border-radius:12px; background:#0c1530; padding:8px}
  .grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
  .card{
    padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0e1a39; cursor:pointer;
    display:grid; gap:4px; min-height:74px;
  }
  .card:hover{background:#122147}
  .nm{font-weight:800}
  .sub{color:var(--muted); font-size:.86rem; display:flex; gap:6px; flex-wrap:wrap}
  .badge{display:inline-block; font-size:.78rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#12203c}
  .sep{opacity:.4}

  /* 최소화 상태 */
  .bottom.min .list{ display:none }
  .bottom .minbtn{ margin-left:auto }
  .bottom.min .minbtn::after{ content:'펼치기' }
  .bottom .minbtn::after{ content:'접기' }

  /* 우측 오류 로그 */
  .errdock{
    position:fixed; right:12px; z-index:1000; width:min(560px,calc(100% - 24px));
    background:#0f172a; border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .errdock .hdr{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border) }
  .errdock .title{ font-weight:800 }
  .errdock .body{ max-height:38vh; overflow:auto; padding:8px 10px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.86rem; background:#0b1220 }
  .logrow{ border-bottom:1px dashed #1d2741; padding:6px 0 }
  .time{ color:#9ca3af; margin-right:6px }
  .lvl{ color:#fca5a5; font-weight:800; margin-right:6px }
  .url{ color:#60a5fa; word-break:break-all }
  .btnsm{ border:1px solid var(--border); background:#0b1530; color:#c7d2fe; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
  .errdock.min .body{ display:none }
  .errdock .minbtn{ margin-left:auto }
  .errdock.min .minbtn::after{ content:'펼치기' }
  .errdock .minbtn::after{ content:'접기' }

  @media (max-width:480px){
    .bottom{ left:8px; right:8px; bottom:8px; }
    .errdock{ left:8px; right:8px; width:auto }
  }
</style>
</head>
<body>
<div id="map" aria-label="지도"></div>

<!-- 하단 리스트 패널 -->
<section class="bottom" id="bottom">
  <div class="row">
    <div class="title">더미 주차장 10 <span class="sep">|</span> 반경 <b id="rLbl">1.0</b> km</div>
    <div class="muted" id="stat" style="margin-left:8px">초기화 중…</div>
    <button class="btn min minbtn" id="minList"></button>
  </div>

  <div class="row">
    <button class="btn" id="locBtn">현재 위치</button>
    <button class="btn" id="fitBtn">전체 보기</button>
    <div class="chipbar" id="radiusBar" style="margin-left:auto">
      <div class="chip" data-r="0.5">0.5km</div>
      <div class="chip on" data-r="1">1km</div>
      <div class="chip" data-r="1.5">1.5km</div>
    </div>
  </div>

  <div class="list" id="listWrap">
    <div id="list" class="grid" role="listbox" aria-label="주차장 목록(반경 내)"></div>
  </div>
</section>

<!-- 오류 로그(오류만, URL 표시) -->
<section class="errdock" id="errdock" aria-label="오류 로그">
  <div class="hdr">
    <div class="title">오류 로그(에러만)</div>
    <div class="muted" id="errcount">0건</div>
    <button class="btnsm" id="copyErr">복사</button>
    <button class="btnsm" id="clearErr">지우기</button>
    <button class="btnsm minbtn" id="minErr"></button>
  </div>
  <div class="body" id="errbody"></div>
</section>

<script>
/* ✅ Kakao SDK 로드 완료 후에만 초기화 */
kakao.maps.load(function () {
  (function(){
    /* =========================================================
     * 기본 유틸/상태
     * =======================================================*/
    const $ = (s)=>document.querySelector(s);
    const stat = $('#stat');
    const ok   = (m)=> stat.innerHTML = `<span style="color:#10b981">✔</span> ${m}`;
    const warn = (m)=> stat.innerHTML = `<span style="color:#f59e0b">!</span> ${m}`;

    // 오류 로그 도크
    const errBody=$('#errbody'), errCnt=$('#errcount'), errDock=$('#errdock');
    $('#minErr').onclick=()=> errDock.classList.toggle('min');
    const tstr=()=>new Date().toLocaleTimeString();
    function logERR(msg, url, detail){
      const row=document.createElement('div'); row.className='logrow';
      row.innerHTML=`<span class="time">[${tstr()}]</span><span class="lvl">ERR</span> ${msg}`
                   +(url?`<div class="url">${url}</div>`:'')
                   +(detail?`<div class="muted">${detail}</div>`:'');
      errBody.appendChild(row); errBody.scrollTop=errBody.scrollHeight;
      errCnt.textContent=`${errBody.querySelectorAll('.logrow').length}건`;
    }
    $('#copyErr').onclick=async()=>{
      const txt=[...errBody.querySelectorAll('.logrow')].map(el=>el.innerText).join('\n');
      try{ await navigator.clipboard.writeText(txt||'(로그 없음)'); }catch(e){}
    };
    $('#clearErr').onclick=()=>{ errBody.innerHTML=''; errCnt.textContent='0건'; };
    window.addEventListener('error', e=> logERR('window.onerror: '+e.message,'', e.error?.stack||''));
    window.addEventListener('unhandledrejection', e=> logERR('unhandledrejection','', e.reason?.stack||String(e.reason)));

    /* =========================================================
     * Kakao 지도 초기화
     * =======================================================*/
    const mapEl = document.getElementById('map');
    const map = new kakao.maps.Map(mapEl, {
      center: new kakao.maps.LatLng(36.4, 127.5),
      level: 12, // 숫자 클수록 넓게
      draggable: true
    });
    const zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

    // 팔로우 모드: 사용자가 지도 조작하면 해제, “현재 위치” 클릭시 재설정
    let followMode = true;
    kakao.maps.event.addListener(map, 'dragstart', ()=>{ followMode=false; });
    kakao.maps.event.addListener(map, 'zoom_start', ()=>{ followMode=false; });
    $('#locBtn').onclick=()=>{ followMode=true; recenterToMe(true); };

    /* =========================================================
     * 현재 위치(마커/정확도/반경 링)
     * =======================================================*/
    const meState = { latlng: null, acc: 0 };   // kakao.maps.LatLng
    const ME_SVG = `data:image/svg+xml;utf8,`+encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#0ea5e9'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
        <path d='M19 0c9 0 16 7 16 16 0 9-8 17-16 22-8-5-16-13-16-22C3 7 10 0 19 0z' fill='url(#g)'/>
        <circle cx='19' cy='12' r='5' fill='#fff'/>
        <path d='M10 26c2-5 6-7 9-7s7 2 9 7' stroke='#fff' stroke-width='3' fill='none' stroke-linecap='round'/>
      </svg>`
    );
    const meMarker = new kakao.maps.Marker({
      map, position: new kakao.maps.LatLng(36.4,127.5),
      image: new kakao.maps.MarkerImage(ME_SVG, new kakao.maps.Size(38,38), {offset:new kakao.maps.Point(19,38)})
    });
    // 정확도 원(미터)
    const accCircle = new kakao.maps.Circle({
      map, center: new kakao.maps.LatLng(36.4,127.5), radius: 0,
      strokeWeight: 2, strokeColor: '#0ea5e9', strokeOpacity: 0.8, strokeStyle: 'solid',
      fillColor: '#0ea5e9', fillOpacity: 0.12
    });
    // 반경 링(선택 반경, km)
    const radCircle = new kakao.maps.Circle({
      map, center: new kakao.maps.LatLng(36.4,127.5), radius: 1000, // 초기 1km
      strokeWeight: 2, strokeColor: '#2563eb', strokeOpacity: 0.9, strokeStyle: 'dash',
      fillColor: '#2563eb', fillOpacity: 0.06
    });

    function updateMe(lat, lng, acc){
      const ll = new kakao.maps.LatLng(lat, lng);
      meState.latlng = ll; meState.acc = acc||0;
      meMarker.setPosition(ll);
      accCircle.setPosition(ll); accCircle.setRadius(Math.max(0, acc||0));
      updateRadiusRing();
      applyRadiusFilter();
      rebuildList();
    }
    function updateRadiusRing(){
      if(!meState.latlng) return;
      radCircle.setPosition(meState.latlng);
      radCircle.setRadius((radiusState.rKm||1) * 1000);
    }
    function recenterToMe(animate=true){
      if(!meState.latlng) return;
      if(animate) map.panTo(meState.latlng); else map.setCenter(meState.latlng);
      if(map.getLevel() > 5) map.setLevel(5);
    }

    // 지오로케이션(팔로우)
    function inKorea(lng, lat){ return lng>124 && lng<132 && lat>32 && lat<39; }
    function coerceLngLat(rawLng, rawLat){
      let lng = Number(rawLng), lat = Number(rawLat);
      const looksSwapped = (Math.abs(lng) <= 90 && Math.abs(lat) > 90) || (!inKorea(lng,lat) && inKorea(lat,lng));
      if(looksSwapped){ const t=lng; lng=lat; lat=t; logERR('현재위치 좌표 스왑 보정','',`(${rawLng}, ${rawLat}) → (${lng}, ${lat})`); }
      return { lng, lat };
    }
    function locateWatch(){
      const httpsOk = location.protocol==='https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      if(!httpsOk || !navigator.geolocation){ warn('위치 권한/환경 문제(HTTPS 필요)'); return; }
      navigator.geolocation.watchPosition(
        p=>{
          const fixed = coerceLngLat(p.coords.longitude, p.coords.latitude);
          updateMe(fixed.lat, fixed.lng, p.coords.accuracy||0);
          setDummyOnce(fixed.lat, fixed.lng); // 최초 1회 더미 생성
          if(followMode) recenterToMe(true);
          ok(`위치 갱신 · ${fixed.lat.toFixed(5)}, ${fixed.lng.toFixed(5)} · acc~${Math.round(p.coords.accuracy||0)}m`);
        },
        e=> { logERR('geolocation 실패','', `${e.code} ${e.message}`); warn('위치 실패'); },
        { enableHighAccuracy:true, maximumAge:2000, timeout:10000 }
      );
    }
    locateWatch();

    /* =========================================================
     * 반경 선택 + 거리계산 + 더미 주차장(10)
     * =======================================================*/
    const radiusState = { rKm: 1 };
    $('#rLbl').textContent = radiusState.rKm.toFixed(1);
    $('#radiusBar').addEventListener('click', (e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      $('#radiusBar').querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
      chip.classList.add('on');
      radiusState.rKm = Number(chip.dataset.r);
      $('#rLbl').textContent = radiusState.rKm.toFixed(1);
      updateRadiusRing(); applyRadiusFilter(); rebuildList();
    });

    // Haversine (km)
    function haversineKm(a,b){
      const R=6371,toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const t=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(t));
    }

    // 더미 10개 생성
    const P_SVG = `data:image/svg+xml;utf8,`+encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='34' height='34' viewBox='0 0 36 36'>
        <circle cx='18' cy='18' r='16' fill='#2563eb'/><text x='18' y='22' font-family='Arial,Helvetica,sans-serif' font-size='16' text-anchor='middle' fill='#fff' font-weight='700'>P</text>
      </svg>`
    );
    const prkImage = new kakao.maps.MarkerImage(P_SVG, new kakao.maps.Size(34,34), {offset:new kakao.maps.Point(17,17)});
    const prkMarkers = [];   // { marker, lat, lng, meta }
    function genDummy(lng,lat,n=10,rKm=2.5){
      const types=['노상','노외','부설']; const owners=['공영','민영']; const out=[];
      for(let i=0;i<n;i++){
        const ang=Math.random()*Math.PI*2, r=Math.random()*rKm;
        const dy=(r/111)*Math.sin(ang), dx=(r/(111*Math.cos(lat*Math.PI/180)))*Math.cos(ang);
        const y=lat+dy, x=lng+dx;
        out.push({
          id:`DM-${i+1}`, nm:`더미 주차장 ${i+1}`,
          type: types[i%types.length], owner: owners[i%owners.length],
          cap:{ total: 20+(i*3)%80, disabled:(i*2)%6, compact:(i*3)%10, ev:(i*4)%8, pregnant:(i*5)%5 },
          hour:'연중무휴 24시간', fee: (i%2?'유료(30분 1000원)':'무료'),
          lng:x, lat:y
        });
      }
      return out;
    }
    let dummyMade=false;
    function setDummyOnce(lat,lng){
      if(dummyMade) return;
      dummyMade=true;
      const rows = genDummy(lng, lat, 10, 2.5);
      rows.forEach(r=>{
        const mk = new kakao.maps.Marker({
          map, position: new kakao.maps.LatLng(r.lat,r.lng), image: prkImage
        });
        mk._meta = r;
        prkMarkers.push({ marker:mk, lat:r.lat, lng:r.lng, meta:r });
        kakao.maps.event.addListener(mk, 'click', ()=> openInfo(mk, r));
      });
      rebuildList();
      applyRadiusFilter();
    }

    /* =========================================================
     * 반경 필터 + 리스트 + 인포윈도우
     * =======================================================*/
    function applyRadiusFilter(){
      if(!meState.latlng) return;
      const me = { lat: meState.latlng.getLat(), lng: meState.latlng.getLng() };
      prkMarkers.forEach(obj=>{
        const d = haversineKm(me, {lat:obj.lat, lng:obj.lng});
        obj._dist = d;
        // 반경 밖이면 숨김
        obj.marker.setMap(d <= radiusState.rKm ? map : null);
      });
    }

    const listEl = $('#list');
    function rebuildList(){
      if(!meState.latlng){ listEl.innerHTML=''; adjustListHeight(); return; }
      const me = { lat: meState.latlng.getLat(), lng: meState.latlng.getLng() };
      const items = prkMarkers
        .map(o=>({ o, d: haversineKm(me, {lat:o.lat,lng:o.lng}) }))
        .filter(x=> x.d <= radiusState.rKm)
        .sort((a,b)=> a.d - b.d)
        .map((x,i)=> ({ i, d:x.d, meta:x.o.meta, marker:x.o.marker }));

      listEl.innerHTML = items.map(r => `
        <div class="card" data-id="${r.meta.id}">
          <div class="nm">${r.i+1}. ${r.meta.nm}</div>
          <div class="sub">
            <span class="badge">${r.meta.type}</span>
            <span class="badge">${r.meta.owner}</span>
            <span class="badge">${r.d.toFixed(2)}km</span>
          </div>
          <div class="sub">총:${r.meta.cap.total} / 장애:${r.meta.cap.disabled} / 경차:${r.meta.cap.compact} / EV:${r.meta.cap.ev} / 임산부:${r.meta.cap.pregnant}</div>
        </div>
      `).join('');

      listEl.querySelectorAll('.card').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          const obj = prkMarkers.find(x=>x.meta.id===id);
          if(!obj) return;
          map.panTo(new kakao.maps.LatLng(obj.lat,obj.lng));
          openInfo(obj.marker, obj.meta);
        });
      });

      adjustListHeight();
    }

    const info = new kakao.maps.InfoWindow({ removable:true });
    function openInfo(marker, meta){
      const html = `
        <div style="min-width:240px;padding:8px 10px">
          <div style="font-weight:800;margin-bottom:6px">${meta.nm||'주차장'}</div>
          <div style="color:#374151;font-size:.9rem;line-height:1.35">
            형태: ${meta.type||'-'} · 구분: ${meta.owner||'-'}<br>
            총면수: ${meta.cap?.total??0} (장애 ${meta.cap?.disabled??0}, 경차 ${meta.cap?.compact??0}, 친환경 ${meta.cap?.ev??0}, 임산부 ${meta.cap?.pregnant??0})<br>
            운영시간: ${meta.hour||'-'}<br>
            요금: ${meta.fee||'-'}
          </div>
        </div>`;
      info.setContent(html);
      info.open(map, marker);
    }
    kakao.maps.event.addListener(map, 'click', ()=> info.close());

    // 전체 보기: 현재위치 + 반경 내 주차장
    $('#fitBtn').onclick=()=>{
      const bounds = new kakao.maps.LatLngBounds();
      if(meState.latlng){ bounds.extend(meState.latlng); }
      prkMarkers.forEach(p=>{
        // 현재 반경 내만 포함
        if(meState.latlng){
          const d = haversineKm({lat:meState.latlng.getLat(),lng:meState.latlng.getLng()},{lat:p.lat,lng:p.lng});
          if(d <= radiusState.rKm) bounds.extend(new kakao.maps.LatLng(p.lat,p.lng));
        } else {
          bounds.extend(new kakao.maps.LatLng(p.lat,p.lng));
        }
      });
      if(!bounds.isEmpty()) map.setBounds(bounds, 20, 20, calcBottomPad(), 20);
    };

    /* =========================================================
     * 레이아웃: 하단 패널 최소화/높이 보정(2행 제한) + 오류 도크 위치
     * =======================================================*/
    const bottom = $('#bottom');
    $('#minList').onclick=()=>{ bottom.classList.toggle('min'); placeErrdock(); };

    function adjustListHeight(){
      const grid = $('#list');
      const wrap = $('#listWrap');
      const first = grid.querySelector('.card');
      if(!first){ wrap.style.maxHeight = '0px'; placeErrdock(); return; }
      const cardH = first.getBoundingClientRect().height;
      const gap = parseFloat(getComputedStyle(grid).gap) || 8;
      const visibleRows = 2;
      const padding = 8*2;
      const maxH = cardH * visibleRows + gap * (visibleRows - 1) + padding;
      wrap.style.maxHeight = Math.ceil(maxH) + 'px';
      placeErrdock();
    }
    function calcBottomPad(){
      const h = bottom.getBoundingClientRect().height;
      return Math.ceil(h + 20);
    }
    function placeErrdock(){
      const h = bottom.getBoundingClientRect().height;
      errDock.style.bottom = (h + 12) + 'px';
    }
    const ro = new ResizeObserver(()=>{ adjustListHeight(); });
    ro.observe(bottom);
    window.addEventListener('resize', adjustListHeight);
    window.addEventListener('orientationchange', ()=> setTimeout(adjustListHeight, 200));

    // 초기 메시지
    ok('Kakao 지도 + 현재위치 팔로우 + 반경 필터 준비 완료');
  })();
});
</script>
</body>
</html>