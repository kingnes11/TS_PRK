<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>노상주차장 상세</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280;
    --primary:#2563eb; --primary-2:#1d4ed8; --border:#e5e7eb;
    --warn:#dc2626; --ok:#16a34a;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#3b82f6; --primary-2:#2563eb; --border:#20304f;
      --warn:#f87171; --ok:#34d399;
    }
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif; background:var(--bg); color:var(--text); padding:12px}
  .wrap{max-width:1100px; margin:0 auto; display:grid; gap:12px}
  .head{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .title{font-weight:800; font-size:1.2rem}
  .muted{color:var(--muted)}
  .badge{display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:.8rem; background:#eef2ff}
  .row{display:grid; gap:10px; grid-template-columns:1fr}
  @media(min-width:900px){ .row{ grid-template-columns:1fr 1fr } }
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px}
  h2{font-size:1rem; margin:.2rem 0 .6rem}
  .grid{display:grid; grid-template-columns:1fr; gap:8px}
  @media(min-width:700px){ .grid{grid-template-columns: 1fr 1fr} }
  label{display:block; font-size:.85rem; color:var(--muted); margin-bottom:4px}
  .ctl{display:flex; gap:8px; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:transparent; align-items:center; flex-wrap:wrap}
  input,textarea,select{border:0; outline:0; width:100%; background:transparent; color:var(--text); font-size:1rem}
  input[readonly]{color:var(--muted)}
  textarea{min-height:80px; resize:vertical}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .btn{border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; color:#fff; background:linear-gradient(180deg,var(--primary),var(--primary-2))}
  .btn.ghost{background:transparent; color:var(--primary); border:1px solid var(--border)}
  .btn.light{background:#eef2ff; color:#1e40af; border:1px solid var(--border)}
  .thumb{width:100%; max-height:260px; object-fit:contain; border:1px solid var(--border); border-radius:10px; background:#fff}
  .mono{font-variant-numeric: tabular-nums}
  .suffix{white-space:nowrap; color:var(--muted); font-size:.95rem}
  .row-1c{grid-template-columns:1fr}
  .help{font-size:.85rem; color:var(--muted)}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .ctl.warn{border-color:var(--warn)}
  [hidden]{display:none !important}

  /* 표준 라디오/체크 그룹 */
  .radio-group, .check-group{display:flex; flex-wrap:wrap; gap:12px}
  .radio-group label, .check-group label{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid var(--border); border-radius:999px;
    background:transparent; line-height:1.2;
  }
  .radio-group input[type="radio"], .check-group input[type="checkbox"]{
    width:18px; height:18px; accent-color:var(--primary);
  }

  /* 주소찾기 레이어 */
  #postcodeLayer{display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:9999}
  #postcodeWrap{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(100vw - 24px,520px); height:70vh; background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:0 20px 40px rgba(0,0,0,.2)}
  #postcodeClose{position:absolute; right:10px; top:10px; z-index:1}
  #postcodeContainer{width:100%; height:100%}
</style>
<script src="https://cdn.jsdelivr.net/npm/exifr@7/dist/full.umd.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="card head">
      <div class="title" id="v_name">노상주차장 상세</div>
      <span class="badge">노상</span>
      <span class="muted mono" id="v_id">관리번호</span>
      <span class="muted" id="v_addr"></span>
      <span class="actions" style="margin-left:auto">
        <button class="btn" onclick="window.print()">인쇄</button>
        <button class="btn" id="btnSaveTop">저장</button>
      </span>
    </header>

    <section class="row">
      <!-- 기본정보 -->
      <div class="card">
        <h2>기본정보</h2>
        <div class="grid">
          <div><label for="f_id">주차장관리번호</label><div class="ctl"><input id="f_id" class="mono" type="text" readonly /></div></div>
          <div><label for="f_name">주차장명</label><div class="ctl"><input id="f_name" type="text" placeholder="예) 연남로 노상" /></div></div>
          <div><label for="f_status">진행상태</label><div class="ctl"><input id="f_status" type="text" placeholder="예) PENDING/APPROVED" /></div></div>
          <div><label for="f_type">주차장구분</label><div class="ctl"><input id="f_type" type="text" value="노상" readonly /></div></div>
          <div><label for="f_sido">시도</label><div class="ctl"><input id="f_sido" /></div></div>
          <div><label for="f_sigungu">시군구</label><div class="ctl"><input id="f_sigungu" /></div></div>
          <div><label for="f_emd">읍면동</label><div class="ctl"><input id="f_emd" /></div></div>

          <!-- 주소: 지번/도로명 + 아래 주소찾기 버튼 -->
          <div style="grid-column:1/-1">
            <label for="f_addr_jibun">지번 주소</label>
            <div class="ctl"><input id="f_addr_jibun" type="text" placeholder="예) 서울 마포구 연남동 123-45" readonly /></div>
          </div>
          <div style="grid-column:1/-1">
            <label for="f_addr_road">도로명 주소</label>
            <div class="ctl"><input id="f_addr_road" type="text" placeholder="예) 서울 마포구 연남로 123" readonly /></div>
          </div>
          <div style="grid-column:1/-1; display:flex; gap:8px">
            <button type="button" class="btn light" id="btnFindAddr">주소찾기</button>
          </div>
        </div>
      </div>

      <!-- 사진 & 좌표 -->
      <div class="card">
        <h2>현장 사진 & 좌표</h2>
        <div class="grid">
          <div style="grid-column:1/-1">
            <label>사진 업로드</label>
            <div class="ctl">
              <input id="f_photo_lib" type="file" accept="image/*,image/heic,image/heif" style="display:none" />
              <input id="f_photo_cam" type="file" accept="image/*" capture="environment" style="display:none" />
              <button type="button" class="btn light" id="btnPickFromLibrary">사진첩에서 선택</button>
              <button type="button" class="btn ghost" id="btnTakePhoto">카메라 촬영</button>
              <button type="button" class="btn" id="btnUseGeolocation">기기 위치로 좌표</button>
              <button type="button" class="btn ghost" id="btnClearPhoto">초기화</button>
            </div>
          </div>
          <div style="grid-column:1/-1"><img id="preview" class="thumb" alt="사진 미리보기" /></div>
          <div><label for="f_lat">위도</label><div class="ctl"><input id="f_lat" class="mono" inputmode="decimal" /></div></div>
          <div><label for="f_lng">경도</label><div class="ctl"><input id="f_lng" class="mono" inputmode="decimal" /></div></div>
        </div>
      </div>
    </section>

    <!-- 운영/요금/면수 -->
    <section class="card">
      <h2>운영 · 요금 · 주차면수</h2>
      <div class="grid">

        <!-- 총 주차면수 + 세부 -->
        <div style="grid-column:1/-1">
          <label for="f_totalStalls">총 주차면수</label>
          <div id="ctl_total" class="ctl">
            <input id="f_totalStalls" type="number" min="0" inputmode="numeric" placeholder="예) 120" />
            <span class="suffix">면</span>
          </div>
          
          <div id="stallsMsg" class="help" style="margin-top:4px"></div>
          <div class="check-group" style="margin-top:8px">
            <label><span>장애인</span><input id="f_st_dis"   type="number" min="0" inputmode="numeric" style="width:90px; margin-left:6px" /><span class="suffix">면</span></label>
            <label><span>경차</span>  <input id="f_st_small" type="number" min="0" inputmode="numeric" style="width:90px; margin-left:6px" /><span class="suffix">면</span></label>
            <label><span>친환경</span><input id="f_st_green" type="number" min="0" inputmode="numeric" style="width:90px; margin-left:6px" /><span class="suffix">면</span></label>
            <label><span>임산부</span><input id="f_st_preg"  type="number" min="0" inputmode="numeric" style="width:90px; margin-left:6px" /><span class="suffix">면</span></label>
          </div>
        </div>

        <!-- 운영주체 (라디오 표준형) -->
        <div style="grid-column:1/-1">
          <label>운영주체</label>
          <div class="radio-group" id="own_group">
            <label><input type="radio" name="own" value="시운영" checked /> <span>시운영</span></label>
            <label><input type="radio" name="own" value="구(군)운영" /> <span>구(군)운영</span></label>
            <label><input type="radio" name="own" value="공단위탁" /> <span>공단위탁</span></label>
            <label><input type="radio" name="own" value="민간위탁" id="own_private" /> <span>민간위탁</span></label>
          </div>
        </div>
        <div id="own_company_wrap" hidden>
          <label for="f_own_company">민간위탁 업체명</label>
          <div class="ctl"><input id="f_own_company" placeholder="예) ㈜○○파킹" /></div>
        </div>

        <!-- 관리기관 -->
        <div>
          <label for="f_mgr_name">관리기관명</label>
          <div class="ctl"><input id="f_mgr_name" placeholder="예) 마포구청 교통행정과" /></div>
        </div>
        <div>
          <label for="f_mgr_tel">관리기관 전화번호</label>
          <div class="ctl"><input id="f_mgr_tel" placeholder="예) 02-123-4567" inputmode="tel" /></div>
        </div>

        <!-- 부제 시행 여부 -->
        <div>
          <label for="f_oddEven">부제 시행 여부</label>
          <div class="ctl">
            <select id="f_oddEven">
              <option value="미시행">미시행</option>
              <option value="2부제">2부제</option>
              <option value="5부제">5부제</option>
              <option value="10부제">10부제</option>
              <option value="승용차요일제">승용차요일제</option>
            </select>
          </div>
        </div>

        <!-- 운영방식 (라디오 표준형) -->
        <div style="grid-column:1/-1">
          <label>주차장 운영방식</label>
          <div class="radio-group" id="op_group">
            <label><input type="radio" name="opType" value="일반노상주차장" checked /> <span>일반노상주차장</span></label>
            <label><input type="radio" name="opType" value="거주자우선주차장" /> <span>거주자우선주차장</span></label>
            <label><input type="radio" name="opType" value="일반노상주차장+거주자우선주차장" /> <span>일반노상+거주자우선</span></label>
          </div>
        </div>

        <!-- 시간대 (체크 표준형) -->
        <div style="grid-column:1/-1">
          <label>운영 시간대</label>
          <div class="check-group">
            <label><input type="checkbox" id="chk_day" /> <span>주간</span></label>
            <label><input type="checkbox" id="chk_night" /> <span>야간</span></label>
          </div>
        </div>

        <!-- 주간 세부 (급지 + 요금부과여부) -->
        <div id="day_detail_wrap" class="grid row-1c" hidden style="grid-column:1/-1">
          <div>
            <label for="f_day_grade">주간 급지</label>
            <div class="ctl">
              <select id="f_day_grade">
                <option value="">선택</option>
                <option>1급지</option><option>2급지</option><option>3급지</option>
                <option>4급지</option><option>5급지</option>
                <option>미분류</option><option>기타</option>
              </select>
            </div>
          </div>
          <div>
            <label for="f_day_feeType">주간 요금 부과여부</label>
            <div class="ctl">
              <select id="f_day_feeType">
                <option value="">선택</option>
                <option>유료</option>
                <option>무료</option>
                <option>유료+무료</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 거주자우선 주차요금 -->
        <div id="res_fee_wrap" class="grid row-1c" hidden style="grid-column:1/-1">
          <h3 class="help" style="margin:.2rem 0">거주자우선주차장 요금(원)</h3>
          <div><label for="f_res_all">전일</label><div class="ctl"><input id="f_res_all" type="number" min="0" inputmode="numeric" placeholder="예) 5000" /><span class="suffix">원</span></div></div>
          <div><label for="f_res_day">주간</label><div class="ctl"><input id="f_res_day" type="number" min="0" inputmode="numeric" placeholder="예) 3000" /><span class="suffix">원</span></div></div>
          <div><label for="f_res_full">상근</label><div class="ctl"><input id="f_res_full" type="number" min="0" inputmode="numeric" placeholder="예) 4000" /><span class="suffix">원</span></div></div>
          <div><label for="f_res_night">야간</label><div class="ctl"><input id="f_res_night" type="number" min="0" inputmode="numeric" placeholder="예) 2000" /><span class="suffix">원</span></div></div>
        </div>

      </div>
    </section>

    <section class="card">
      <div class="actions">
        <button class="btn" id="btnSave">저장</button>
        <span class="muted">샘플 저장입니다. 실제 API로 교체하세요.</span>
      </div>
    </section>
  </div>

  <!-- 주소찾기 레이어 -->
  <div id="postcodeLayer" role="dialog" aria-modal="true" aria-label="주소 검색">
    <div id="postcodeWrap">
      <button id="postcodeClose" class="btn light" type="button">닫기</button>
      <div id="postcodeContainer"></div>
    </div>
  </div>

<script>
const $=(s)=>document.querySelector(s);
function params(){const sp=new URLSearchParams(location.search);return new Proxy({}, {get:(_,k)=> sp.get(k)||''});}
const p=params();

/* ===== 기본 필드 ===== */
const f_id=$('#f_id'), f_name=$('#f_name'), f_status=$('#f_status'), f_type=$('#f_type');
const f_sido=$('#f_sido'), f_sigungu=$('#f_sigungu'), f_emd=$('#f_emd');
const f_addrJ=$('#f_addr_jibun'), f_addrR=$('#f_addr_road');
const f_lat=$('#f_lat'), f_lng=$('#f_lng');
const v_id=$('#v_id'), v_name=$('#v_name'), v_addr=$('#v_addr');

/* 샘플/주입 */
const sample={ id:'PRK-0002', name:'연남로 노상', status:'PENDING', sido:'서울특별시', sigungu:'마포구', emd:'연남동', addrJ:'서울 마포구 연남동 123-45', addrR:'서울 마포구 연남로 123' };
f_id.value=p.id||sample.id; f_name.value=p.name||sample.name; f_status.value=p.status||sample.status; f_type.value='노상';
f_sido.value=p.sido||sample.sido; f_sigungu.value=p.sigungu||sample.sigungu; f_emd.value=p.emd||sample.emd;
f_addrJ.value=p.jibun||p.addr||sample.addrJ; f_addrR.value=p.road||sample.addrR;
v_id.textContent=f_id.value; v_name.textContent=f_name.value||'노상주차장 상세'; updateHeaderAddr();

/* ===== 주소찾기 레이어 ===== */
const layer=$('#postcodeLayer'), container=$('#postcodeContainer');
$('#btnFindAddr').addEventListener('click', ()=>{
  layer.style.display='block'; container.innerHTML='';
  new daum.Postcode({
    oncomplete(data){
      const road = data.roadAddress || data.address || '';
      const jibun = data.jibunAddress || data.autoJibunAddress || data.address || '';
      f_addrJ.value = jibun; f_addrR.value = road;
      updateHeaderAddr();
      layer.style.display='none';
    }, width:'100%', height:'100%'
  }).embed(container);
});
$('#postcodeClose').addEventListener('click', ()=> layer.style.display='none');
layer.addEventListener('click', (e)=>{ if(e.target===layer) layer.style.display='none'; });

/* ===== 사진 업로드/좌표 ===== */
const inLib=$('#f_photo_lib'), inCam=$('#f_photo_cam');
$('#btnPickFromLibrary').addEventListener('click', ()=> inLib.click());
$('#btnTakePhoto').addEventListener('click', ()=> inCam.click());
$('#btnUseGeolocation').addEventListener('click', async ()=>{
  const c=await geoFromDevice(); if(c){ f_lat.value=c.lat.toFixed(6); f_lng.value=c.lng.toFixed(6); }
});
$('#btnClearPhoto').addEventListener('click', ()=>{
  inLib.value=''; inCam.value=''; $('#preview').removeAttribute('src'); f_lat.value=''; f_lng.value='';
});
inLib.addEventListener('change', (e)=> handleFiles(e.target.files, 'lib'));
inCam.addEventListener('change', (e)=> handleFiles(e.target.files, 'cam'));

async function handleFiles(list, mode){
  const file=list && list[0]; if(!file) return;
  try{ $('#preview').src=URL.createObjectURL(file); }catch(_){}
  if(mode==='cam'){
    const c=await geoFromDeviceSilent(); // 촬영 시 무음으로 기기좌표 사용
    if(c){ f_lat.value=c.lat.toFixed(6); f_lng.value=c.lng.toFixed(6); }
    return;
  }
  try{
    let coords=null;
    if(window.exifr){
      try{
        const g=await exifr.gps(file);
        if(g && typeof g.latitude==='number' && typeof g.longitude==='number') coords={lat:g.latitude,lng:g.longitude};
      }catch(_){}
    }
    if(!coords && (/jpe?g$/i.test(file.name) || file.type==='image/jpeg')){
      try{ coords=await readJpegGpsSafe(file); }catch(_){}
    }
    if(coords){ f_lat.value=Number(coords.lat).toFixed(6); f_lng.value=Number(coords.lng).toFixed(6); }
  }catch(err){ console.error(err); }
}

async function geoFromDeviceSilent(){
  if(!('geolocation' in navigator) || !isSecureContext) return null;
  try{
    const p=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:8000, maximumAge:0}));
    return {lat:p.coords.latitude, lng:p.coords.longitude};
  }catch(_){
    try{
      const p=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:false, timeout:12000, maximumAge:0}));
      return {lat:p.coords.latitude, lng:p.coords.longitude};
    }catch(__){ return null; }
  }
}
async function geoFromDevice(){
  if(!('geolocation' in navigator)) { alert('이 브라우저는 위치 기능을 지원하지 않습니다.'); return null; }
  if(!isSecureContext) { alert('HTTPS 또는 http://localhost 에서만 위치 사용 가능'); return null; }
  try{
    const p=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:8000, maximumAge:0}));
    return {lat:p.coords.latitude, lng:p.coords.longitude};
  }catch(e1){
    try{
      const p=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:false, timeout:12000, maximumAge:0}));
      return {lat:p.coords.latitude, lng:p.coords.longitude};
    }catch(e2){ alert('위치 확인 실패'); return null; }
  }
}

/* JPEG EXIF 보조 파서 */
function u16(v,o,le){ return v.getUint16(o, !!le); }
function u32(v,o,le){ return v.getUint32(o, !!le); }
async function readJpegGpsSafe(file){
  const buf=await file.arrayBuffer(); const v=new DataView(buf);
  if(v.byteLength<4 || v.getUint16(0)!==0xFFD8) return null;
  let off=2;
  while(off+4<=v.byteLength){
    const marker=v.getUint16(off); off+=2;
    if((marker&0xFFF0)!==0xFFE0) break;
    const size=v.getUint16(off); off+=2;
    const next=off+size-2; if(next>v.byteLength) break;
    if(marker===0xFFE1){
      if(off+6<=v.byteLength && v.getUint32(off)===0x45786966){
        const c=parseExifForGps(v,off+6); if(c) return c;
      }
    }
    off=next;
  }
  return null;
  function parseExifForGps(view,tiff){
    if(tiff+8>view.byteLength) return null;
    const endian=view.getUint16(tiff), le=endian===0x4949; if(!le && endian!==0x4D4D) return null;
    const ifd0=tiff+u32(view,tiff+4,le); if(!rng(ifd0,2)) return null;
    const n=u16(view,ifd0,le); let gpsPtr=0;
    for(let i=0;i<n;i++){
      const e=ifd0+2+i*12; if(!rng(e,12)) return null;
      const tag=u16(view,e,le);
      if(tag===0x8825){ gpsPtr=tiff+u32(view,e+8,le); break; }
    }
    if(!gpsPtr || !rng(gpsPtr,2)) return null;
    const m=u16(view,gpsPtr,le); let latRef='N',lonRef='E',lat=null,lon=null;
    for(let i=0;i<m;i++){
      const e=gpsPtr+2+i*12; if(!rng(e,12)) break;
      const tag=u16(view,e,le), type=u16(view,e+2,le), cnt=u32(view,e+4,le);
      const ofsRel=u32(view,e+8,le); const ptr=(cnt<=4)?(e+8):(tiff+ofsRel);
      if((tag===0x0001||tag===0x0003)&&type===2&&cnt>=2){
        if(rng(ptr,1)){
          const ch=String.fromCharCode(view.getUint8(ptr));
          if(tag===0x0001)latRef=ch; if(tag===0x0003)lonRef=ch;
        }
      }
      if((tag===0x0002||tag===0x0004)&&type===5&&cnt===3){
        const p=tiff+ofsRel; if(!rng(p,24)) continue;
        const d=u32(view,p,le), m2=u32(view,p+8,le), s=u32(view,p+16,le);
        const dd=(d/(u32(view,p+4,le)||1)), mm=(m2/(u32(view,p+12,le)||1)), ss=(s/(u32(view,p+20,le)||1));
        const dec=dd + (mm/60) + (ss/3600);
        if(tag===0x0002) lat=dec; else if(tag===0x0004) lon=dec;
      }
    }
    if(lat!=null&&lon!=null){ if(latRef==='S')lat=-lat; if(lonRef==='W')lon=-lon; return {lat,lng:lon}; }
    return null;
  }
  function rng(s,l){ return s>=0 && (s+(l||0))<=v.byteLength; }
}

/* ===== 라디오/체크 토글 로직 ===== */
const ownRadios=[...document.querySelectorAll('input[name="own"]')];
const ownWrap=$('#own_company_wrap'), ownCompany=$('#f_own_company');
ownRadios.forEach(r=>r.addEventListener('change', ()=>{
  const isPrivate = (r.value==='민간위탁' && r.checked);
  ownWrap.hidden = !isPrivate;
  if(!isPrivate) ownCompany.value='';
}));

const opTypeRadios=[...document.querySelectorAll('input[name="opType"]')];
const resWrap=$('#res_fee_wrap');
function syncResWrap(){
  const v = opTypeRadios.find(r=>r.checked)?.value || '';
  const hasResident = v.includes('거주자우선주차장');
  resWrap.hidden = !hasResident;
}
opTypeRadios.forEach(r=>r.addEventListener('change', syncResWrap));
syncResWrap();

const chkDay=$('#chk_day'), dayDetail=$('#day_detail_wrap');
function syncDay(){ dayDetail.hidden = !chkDay.checked; }
chkDay.addEventListener('change', syncDay);
syncDay();

/* ===== 총면수 ↔ 세부면수 자동/검증 ===== */
const totalInput = $('#f_totalStalls');
const ctlTotal   = $('#ctl_total');
const disInput   = $('#f_st_dis');
const smallInput = $('#f_st_small');
const greenInput = $('#f_st_green');
const pregInput  = $('#f_st_preg');
const autoSumEl  = $('#autoSum');
const msgEl      = $('#stallsMsg');

function num(v){ const n=parseInt((v||'').toString().replace(/[^0-9]/g,''),10); return Number.isFinite(n)&&n>=0?n:0; }
function detailSum(){
  return num(disInput.value)+num(smallInput.value)+num(greenInput.value)+num(pregInput.value);
}
function setWarn(on, text){
  ctlTotal.classList.toggle('warn', !!on);
  msgEl.textContent = text || '';
  msgEl.classList.toggle('warn', !!on);
  msgEl.classList.toggle('ok', !on && text);
}
function recompute(){
  const sum = detailSum();
  if(autoSumEl.checked){
    totalInput.value = sum; // 자동 반영하지만 '입력 가능'(readOnly 아님)
    setWarn(false, sum ? `세부합 ${sum.toLocaleString()}면 자동반영` : '');
  }else{
    const total = num(totalInput.value);
    if(total !== sum){
      const diff = total - sum;
      setWarn(true, `세부합 ${sum.toLocaleString()}면 ≠ 총 ${total.toLocaleString()}면 (차이 ${diff>0?'+':''}${diff})`);
    }else if(total || sum){
      setWarn(false, `세부합과 총면수가 일치합니다 (${sum.toLocaleString()}면)`);
    }else{
      setWarn(false, '');
    }
  }
}
[disInput, smallInput, greenInput, pregInput].forEach(el=> el.addEventListener('input', recompute));
totalInput.addEventListener('input', recompute);
autoSumEl.addEventListener('change', recompute);
recompute();

/* ===== 헤더 주소 ===== */
function updateHeaderAddr(){
  const j=f_addrJ.value?.trim(); const r=f_addrR.value?.trim();
  v_addr.textContent = (j||r) ? ' · '+[j,r].filter(Boolean).join(' / ') : '';
}

/* ===== 저장 ===== */
function doSave(){
  // 자동합계 OFF + 불일치면 저장 중단
  if(!autoSumEl.checked){
    const sum = detailSum();
    const total = num(totalInput.value);
    if(total !== sum){
      alert('총면수와 세부면수의 합이 일치하지 않습니다. 확인해주세요.');
      return;
    }
  }
  const own = (ownRadios.find(r=>r.checked)||{}).value || '';
  const opType = (opTypeRadios.find(r=>r.checked)||{}).value || '';
  const payload={
    id:f_id.value, name:f_name.value, status:f_status.value, type:'노상',
    sido:f_sido.value, sigungu:f_sigungu.value, emd:f_emd.value,
    addrJibun:f_addrJ.value, addrRoad:f_addrR.value, lat:f_lat.value, lng:f_lng.value,

    totalStalls: num(totalInput.value),
    stalls:{ disabled:num(disInput.value), compact:num(smallInput.value), eco:num(greenInput.value), pregnant:num(pregInput.value) },
    autoTotalFromDetail: autoSumEl.checked,

    ownerType: own,
    ownerCompany: (own==='민간위탁') ? ($('#f_own_company').value) : '',
    manager:{ name:$('#f_mgr_name').value, tel:$('#f_mgr_tel').value },

    oddEven: $('#f_oddEven').value,

    operationType: opType,
    times:{ day:$('#chk_day').checked, night:$('#chk_night').checked },
    dayDetail: $('#chk_day').checked ? { grade: $('#f_day_grade').value, feeType: $('#f_day_feeType').value } : null,

    residentFees: (!resWrap.hidden) ? {
      all:num($('#f_res_all').value),
      day:num($('#f_res_day').value),
      full:num($('#f_res_full').value),
      night:num($('#f_res_night').value)
    } : null
  };
  console.log('SAVE(offstreet):', payload);
  alert('샘플 저장 완료(콘솔 확인). 실제 API로 교체하세요.');
}
$('#btnSave').addEventListener('click', doSave);
$('#btnSaveTop').addEventListener('click', doSave);
</script>
</body>
</html>